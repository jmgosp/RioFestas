<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>RioFestas • Guia de Festas do Rio</title><link href="styles.css" rel="stylesheet"/>
<!-- Tailwind + Inter -->
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com"></script>
<script>
(function(){
  try{
    var ls = localStorage.getItem('rf_theme');
    var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    var initTheme = ls || (prefersDark ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', initTheme);
  } catch(e){}
})();
</script>

<!-- Perf: preconnect to common image hosts -->
<link crossorigin="" href="https://firebasestorage.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://lh3.googleusercontent.com" rel="preconnect"/>
<link crossorigin="" href="https://images.unsplash.com" rel="preconnect"/>
<link href="https://placehold.co" rel="preconnect"/>

<!-- Preload critical images -->
<link rel="preload" as="image" href="https://images.unsplash.com/photo-1540039155733-5bb30b53aa14?q=80&amp;w=1600&amp;auto=format&amp;fit=crop" fetchpriority="high" class="hero-image-preload"/>
<link rel="preload" as="image" href="https://placehold.co/32x32/f472b6/ffffff?text=U" fetchpriority="high"/>

<!-- DNS prefetch for additional domains -->
<link rel="dns-prefetch" href="//www.gstatic.com"/>
<link rel="dns-prefetch" href="//firebaseapp.com"/>
</head>
<body class="bg-gray-50 md:bg-white text-gray-900 selection:bg-pink-600/10">
<!-- HEADER -->
<header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-gray-200">
<div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
<!-- AJUSTE: Logo removido da barra de navegação. Botão Home permanece em mobile. -->
<div class="flex items-center mr-2">
<button class="inline-flex items-center justify-center h-10 w-10 rounded-full border border-gray-200 bg-white text-gray-600 hover:bg-gray-50" id="btn-home-header" title="Início">
<svg fill="none" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="20"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
</button>
</div>
<!-- AJUSTE: Aumentado o espaçamento (gap) e ajustado o tamanho dos botões para mobile -->
<nav class="flex items-center gap-2 sm:gap-3">
<button class="inline-flex items-center rounded-full bg-gray-100 border border-gray-200 px-5 py-2.5 text-xs font-semibold text-gray-700 hover:bg-gray-200 sm:px-5 sm:py-2.5 sm:text-sm" id="btn-about-header">Sobre</button>
<button class="inline-flex items-center rounded-full bg-pink-600/5 border border-pink-600/20 px-5 py-2.5 text-xs font-semibold text-pink-700 hover:bg-pink-600/10 sm:px-5 sm:py-2.5 sm:text-sm" id="btn-social-header">Rede</button>
<button class="inline-flex items-center justify-center h-10 w-10 rounded-full border border-gray-200 bg-white text-gray-700 hover:bg-gray-50" id="btn-theme" title="Alternar tema">
<svg fill="none" height="18" id="icon-sun" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="5"></circle>
<path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
</svg>
<svg class="hidden" fill="none" height="18" id="icon-moon" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg">
<path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
</button>
<!-- Visitante -->
<div class="flex items-center gap-2" id="nav-auth">
<button class="inline-flex items-center rounded-full border border-gray-200 bg-white px-5 py-2.5 text-xs font-semibold hover:bg-gray-50 sm:px-5 sm:py-2.5 sm:text-sm" id="btn-open-login">Entrar</button>
<button class="hidden sm:inline-flex items-center rounded-full bg-pink-600 px-5 py-2.5 text-sm font-semibold text-white hover:opacity-90" id="btn-open-register">Registrar-se</button>
</div>
<!-- Logado -->
<div class="hidden relative" id="nav-user">
<!-- AJUSTE: Botão de usuário agora é um círculo perfeito em mobile para acomodar a foto -->
<button class="inline-flex items-center justify-center h-9 w-9 rounded-full border border-gray-200 bg-white font-semibold hover:bg-gray-50 sm:w-auto sm:px-3 sm:py-1.5 sm:gap-2" id="btn-user">
<img alt="Avatar" class="h-8 w-8 rounded-full object-cover bg-gray-200" id="user-avatar-img" src="https://placehold.co/32x32/f472b6/ffffff?text=U"/>
<span class="grid h-8 w-8 place-items-center rounded-full bg-pink-600 text-white font-bold hidden" id="user-avatar-text">U</span>
<span class="hidden sm:inline" id="user-label">Usuário</span>
<svg class="hidden sm:block" fill="none" height="16" viewbox="0 0 24 24" width="16"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-linecap="round" stroke-width="2"></path></svg>
</button>
<div class="absolute right-0 mt-2 hidden w-56 rounded-2xl bg-white p-2 shadow-xl ring-1 ring-gray-200" id="user-menu">
<a class="block rounded-xl px-3 py-2 text-sm hover:bg-gray-50 cursor-pointer" id="go-profile">Meu Perfil</a>
<a class="block rounded-xl px-3 py-2 text-sm hover:bg-gray-50 cursor-pointer hidden" id="go-organizer">Organizador</a>
<a class="block rounded-xl px-3 py-2 text-sm hover:bg-gray-50 cursor-pointer hidden" id="go-admin">Área Admin</a>
<button class="mt-1 block w-full rounded-xl px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50" id="btn-logout">Sair</button>
</div>
</div>
</nav>
</div>
</header>
<!-- HERO -->
<section class="relative bg-white" id="hero-section">
<div class="max-w-6xl mx-auto px-4 py-8 md:py-14 grid items-center gap-8 md:grid-cols-[1.2fr_.8fr]">
<div class="text-center md:text-left md:col-span-1">
<!-- TÍTULO ELEGANTE ADICIONADO AQUI -->
<a class="text-4xl md:text-5xl font-black tracking-tighter mb-4 inline-block" href="#/">
<span class="bg-gradient-to-r from-pink-500 via-fuchsia-500 to-purple-600 bg-clip-text text-transparent">RioFestas</span>
</a>
<h1 class="text-4xl md:text-6xl font-extrabold leading-tight tracking-tight">Descubra e<br/>reserve as<br/>melhores festas do<br/>Rio.</h1>
<p class="mt-5 text-base text-gray-600 max-w-xl mx-auto md:mx-0">Sua curadoria definitiva para os eventos mais exclusivos e vibrantes da cidade.</p>
<div class="mt-6 relative">
<input class="w-full rounded-full border border-gray-200 bg-white px-5 py-3.5 pr-12 text-base outline-none focus:ring-2 focus:ring-pink-600/40 shadow-soft" id="search-input" placeholder="Pesquise por festas, DJs..."/>
<button class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-[#131722] focus:outline-none" id="search-btn" type="button">
<svg class="absolute right-4 top-1/2 -translate-y-1/2" fill="none" height="20" viewbox="0 0 24 24" width="20"><path d="M15.5 15.5L20 20" stroke="#888" stroke-linecap="round" stroke-width="2"></path><circle cx="10.5" cy="10.5" r="6.5" stroke="#888" stroke-width="2"></circle></svg>
</button>
</div>
<!-- Botão para a página de locais -->
<div class="mt-4 flex justify-center md:justify-start items-center gap-2">
<button class="inline-flex items-center gap-2 rounded-full border border-gray-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-gray-50 shadow-sm" id="btn-locations-view">
<svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                Ver por Local
            </button>
</div>
</div>
<div class="rounded-3xl overflow-hidden shadow-soft ring-subtle hidden md:block md:col-span-1">
<img alt="Brinde em festa no Rio" class="w-full h-[280px] md:h-[420px] object-cover" src="https://images.unsplash.com/photo-1540039155733-5bb30b53aa14?q=80&amp;w=1600&amp;auto=format&amp;fit=crop" fetchpriority="high" decoding="async"/>
</div>
</div>
</section>
<!-- HOME SECTIONS -->
<main class="max-w-6xl mx-auto px-4 pb-24 space-y-12" id="home-view">
<!-- BARRA DE FILTROS (Bairros & Gêneros) -->
<section class="mt-2 mb-6" id="filters-bar">
<div class="rounded-3xl bg-white shadow-soft ring-subtle">
<!-- Botão de Toggle -->
<button class="w-full flex items-center justify-between p-3 text-left hover:bg-gray-50/70 rounded-3xl transition-colors" id="btn-toggle-filters">
<div class="flex items-center gap-2">
<svg class="text-gray-400" fill="none" height="18" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="18"><path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"></path></svg>
<span class="text-sm font-semibold text-gray-700">Filtros</span>
</div>
<div class="flex items-center gap-3">
<span class="hidden text-xs font-bold bg-pink-600 text-white rounded-full h-5 w-5 flex items-center justify-center" id="active-filters-count">0</span>
<svg class="w-5 h-5 text-gray-500 transition-transform" fill="currentColor" id="filters-chevron" viewbox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" fill-rule="evenodd"></path>
</svg>
</div>
</button>
<!-- Conteúdo dos Filtros -->
<div id="filters-content">
<div class="inner-filter-content">
<div class="px-3 pt-1 pb-3 border-t border-gray-100">
<div class="mt-3 space-y-3">
<div>
<div class="text-xs font-medium text-gray-500 mb-1.5">Bairros</div>
<div class="flex flex-wrap gap-2" id="chips-bairros"></div>
</div>
<div>
<div class="text-xs font-medium text-gray-500 mb-1.5">Gêneros musicais</div>
<div class="flex flex-wrap gap-2" id="chips-generos"></div>
</div>
</div>
<div class="mt-4 text-right">
<button class="text-xs font-semibold text-pink-600 hover:underline disabled:text-gray-400 disabled:no-underline" disabled="" id="btn-clear-filters">Limpar Filtros</button>
</div>
</div>
</div>
</div>
</div>
</section>

<!-- DESTAQUES DE HOJE (aparece apenas se houver eventos hoje) -->
<section class="hidden" id="today-highlights-section">
<div class="flex items-center justify-between">
<h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">
  <span class="flex items-center gap-2">
    <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    Destaques de Hoje
  </span>
</h2>
</div>
<div class="mt-4 flex gap-3 md:gap-4 overflow-x-auto snap-x snap-mandatory pb-4 -mx-4 px-4" id="carousel-today-highlights"></div>
<div class="hidden mt-6 text-center text-gray-500" id="empty-today-highlights">
  <div class="flex flex-col items-center gap-2">
    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <p>Nenhum evento hoje.</p>
    <p class="text-sm text-gray-400">Confira os destaques da semana abaixo!</p>
  </div>
</div>
</section>

<section>
<div class="flex items-center justify-between">
<h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Destaques da Semana</h2>
</div>
<div class="mt-4 flex gap-3 md:gap-4 overflow-x-auto snap-x snap-mandatory pb-4 -mx-4 px-4" id="carousel-week-top"></div>
<div class="hidden mt-6 text-center text-gray-500" id="empty-week-top">Nenhum evento nos próximos 7 dias.</div>
</section>
<section>
<div class="flex items-center justify-between">
<h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Eventos Populares</h2>
</div>
<div class="mt-4 flex gap-3 md:gap-4 overflow-x-auto snap-x snap-mandatory pb-4 -mx-4 px-4" id="carousel-popular"></div>
<div class="hidden mt-6 text-center text-gray-500" id="empty-popular">Nenhum evento com confirmações ainda.</div>
</section>
<section>
<div class="flex items-center justify-between">
<h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Eventos por Dia</h2>
</div>
<div class="mt-3 flex gap-2 overflow-x-auto pb-2 -mx-4 px-4" id="weekday-menu"></div>
<div class="mt-4 flex gap-3 md:gap-4 overflow-x-auto snap-x snap-mandatory pb-4 -mx-4 px-4" id="carousel-byday"></div>
<div class="hidden mt-6 text-center text-gray-500" id="empty-byday">Sem eventos nesse dia.</div>
</section>
<section>
<div class="flex items-center justify-between">
<h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Outros Eventos</h2>
</div>
<div class="mt-4 flex gap-3 md:gap-4 overflow-x-auto snap-x snap-mandatory pb-4 -mx-4 px-4" id="carousel-others"></div>
<div class="hidden mt-6 text-center text-gray-500" id="empty-others">Nenhum outro evento encontrado.</div>
</section>
<section class="hidden" id="search-results-section">
<h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Resultados da Busca</h2>
<div class="mt-4 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4" id="grid-events"></div>
<div class="hidden mt-10 text-center text-gray-500" id="empty-feed">Nenhum evento encontrado.</div>
</section>
</main>
<!-- O restante do seu HTML continua aqui... -->
<!-- PÁGINA SOBRE -->
<section class="hidden max-w-3xl mx-auto px-4 pb-28 mt-10 md:mt-16" id="view-about">
<div class="bg-white rounded-3xl p-6 md:p-12 shadow-soft ring-subtle text-center">
<!-- Título com Gradiente -->
<h2 class="text-4xl md:text-5xl font-black tracking-tighter mb-6">
<span class="bg-gradient-to-r from-pink-500 via-fuchsia-500 to-purple-600 bg-clip-text text-transparent">
                    Conectando Pessoas e Festas
                </span>
</h2>
<!-- Novo Texto -->
<div class="prose prose-lg max-w-none mx-auto text-gray-700">
<p>O Rio Festas é um aplicativo focado em conexões; nossa missão é facilitar que você encontre os lugares certos, com as pessoas certas. Porque tudo é melhor com uma companhia especial.</p>
<p>Aqui, você pode seguir seus amigos, enviar convites, marcar sua presença, procurar ingressos e descobrir quais os locais mais cobiçados de cada noite carioca.</p>
<p class="font-semibold">Nunca foi tão fácil e prático curtir o Rio de Janeiro com aqueles que mais importam para você.</p>
</div>
<!-- Botão de Suporte -->
<div class="mt-10">
<a class="inline-flex items-center gap-3 rounded-full bg-emerald-500 px-6 py-3 text-lg font-semibold text-white shadow-lg hover:bg-emerald-600 transition-colors" href="https://wa.me/5521000000000" id="whatsapp-support-link" target="_blank">
<svg fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                    Suporte via WhatsApp
                </a>
</div>
<!-- Link de Privacidade -->
<div class="mt-12 text-center text-sm text-gray-500">
<p>Veja nossa <a class="font-semibold text-pink-600 hover:underline" href="https://firebasestorage.googleapis.com/v0/b/riofestas2.firebasestorage.app/o/termos%20de%20uso.html?alt=media&amp;token=f7f7a4f3-b414-4bb8-b631-e2704652eb83" target="_blank">Política de Privacidade e Termos de Uso</a>.</p>
</div>
</div>
</section>
<!-- PÁGINA DE LOCAIS -->
<section class="hidden max-w-6xl mx-auto px-4 pb-28" id="view-locations">
<h2 class="text-3xl md:text-4xl font-extrabold tracking-tight">Eventos por Local</h2>
<div class="mt-8 space-y-12" id="locations-container">
<!-- Carrosséis de locais serão injetados aqui pelo JavaScript -->
</div>
</section>
<!-- PÁGINA SOCIAL -->
<section class="hidden max-w-6xl mx-auto px-4 pb-28" id="view-social">
<main class="space-y-12">
<section>
<div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
<div class="flex items-center gap-3 cursor-pointer" id="notifications-toggle">
<h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Notificações</h2>
<div class="hidden w-2 h-2 bg-red-500 rounded-full animate-pulse" id="notifications-badge"></div>
<button class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 transition-all duration-200 group" id="notifications-toggle-btn">
<svg class="w-4 h-4 text-gray-600 transition-transform duration-200 group-hover:text-gray-800" id="notifications-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
</svg>
</button>
</div>
<div class="flex items-center gap-4 w-full md:w-auto" id="notifications-controls">
<label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer flex-1"><input class="h-4 w-4 cursor-pointer" id="account-notify-check" type="checkbox"/> Notificar quando meus amigos confirmarem em eventos</label>
<button class="text-sm font-semibold text-red-600 hover:text-red-800 flex-shrink-0" id="clear-all-notifs-btn">Limpar Tudo</button>
</div>
</div>
<div class="mt-4 space-y-3 overflow-hidden transition-all duration-300" id="notifications-content">
<div class="space-y-3" id="notifications-list"></div>
<div class="hidden mt-6 text-center text-gray-500" id="empty-notifications">Nenhuma notificação nova.</div>
</div>
</section>
<section>
<h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Encontre Pessoas</h2>
<div class="mt-4">
<input class="w-full rounded-full border border-gray-200 bg-white px-5 py-3 text-base outline-none focus:ring-2 focus:ring-pink-600/40 shadow-soft" id="user-search-input" placeholder="Buscar por nome de usuário..."/>
</div>
<div class="mt-6 grid gap-4" id="user-search-results"></div>
</section>
<section>
<h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Eventos que seus amigos vão</h2>
<div class="mt-4 flex gap-3 md:gap-4 overflow-x-auto snap-x snap-mandatory pb-4 -mx-4 px-4" id="carousel-friends-popular"></div>
<div class="hidden mt-6 text-center text-gray-500" id="empty-friends-popular">Ninguém que você segue confirmou presença ainda.</div>
</section>
<section>
<h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Eventos mais populares da rede</h2>
<div class="mt-4 flex gap-3 md:gap-4 overflow-x-auto snap-x snap-mandatory pb-4 -mx-4 px-4" id="carousel-social-popular"></div>
<div class="hidden mt-6 text-center text-gray-500" id="empty-social-popular">Nenhum evento com confirmações ainda.</div>
</section>
</main>
</section>
<!-- PÁGINA DO ORGANIZADOR -->
<section class="hidden max-w-6xl mx-auto px-4 pb-28" id="view-organizer">
<div class="flex items-center justify-between">
<h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Área do Organizador</h2>
<div class="flex items-center gap-2">
<button class="inline-flex items-center rounded-full bg-pink-600 px-5 py-2.5 text-sm font-semibold text-white hover:opacity-90" id="btn-new-org-event">Novo Evento</button>
</div>
</div>

<!-- Meus Eventos -->
<div class="organizer-section">
<h3 class="text-lg font-semibold mb-4">Meus Eventos</h3>
<div class="organizer-events-grid" id="my-events-grid">
<!-- Eventos serão carregados aqui -->
</div>
<div class="hidden mt-6 text-center text-gray-500" id="empty-my-events">Você ainda não criou nenhum evento.</div>
</div>

<!-- Eventos Privados - Solicitações Pendentes -->
                    <div class="organizer-section">
                        <h3 class="text-lg font-semibold mb-4">Eventos Privados - Solicitações Pendentes</h3>
                        <p class="text-sm text-gray-600 mb-4">Aprovar ou recusar solicitações de acesso a eventos privados.</p>
                        
                        <!-- Barra de pesquisa -->
                        <div class="search-container">
                            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" class="search-input" id="search-pending-requests" placeholder="Pesquisar por nome de usuário...">
                        </div>
                        
                        <div class="space-y-4" id="private-events-requests">
                            <!-- Solicitações serão carregadas aqui -->
                        </div>
                        <div class="hidden mt-6 text-center text-gray-500" id="empty-private-requests">Nenhuma solicitação pendente para seus eventos privados.</div>
                    </div>

                    <!-- Eventos Privados - Pessoas Aprovadas -->
                    <div class="organizer-section">
                        <h3 class="text-lg font-semibold mb-4">Eventos Privados - Pessoas Aprovadas</h3>
                        <p class="text-sm text-gray-600 mb-4">Gerenciar pessoas que têm acesso a seus eventos privados.</p>
                        
                        <!-- Barra de pesquisa -->
                        <div class="search-container">
                            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" class="search-input" id="search-approved-users" placeholder="Pesquisar por nome de usuário...">
                        </div>
                        
                        <div class="space-y-4" id="private-events-approved">
                            <!-- Pessoas aprovadas serão carregadas aqui -->
                        </div>
                        <div class="hidden mt-6 text-center text-gray-500" id="empty-private-approved">Nenhuma pessoa aprovada para seus eventos privados.</div>
                    </div>
</section>

<!-- PÁGINA DE PERFIL -->
<section class="hidden max-w-xl mx-auto px-4 pb-28" id="view-profile">
<h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Meu Perfil</h2>
<form class="mt-4 space-y-4 rounded-3xl bg-white p-6 shadow-soft ring-subtle" id="account-form">
<div>
<label class="text-sm font-medium text-gray-700">Nome de Exibição</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="account-name" required="" type="text"/>
</div>
<div>
<label class="text-sm font-medium text-gray-700">Nome de Usuário (@...)</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="account-username" readonly="" required="" type="text"/>
<p class="text-xs text-gray-500 mt-1">O nome de usuário não pode ser alterado.</p>
</div>
<div>
<label class="text-sm font-medium text-gray-700">Foto de Perfil</label>
<div class="mt-1 flex items-center gap-4">
<img class="h-16 w-16 rounded-full object-cover bg-gray-200" id="account-photo-preview" src="https://placehold.co/64x64/f472b6/ffffff?text=U"/>
<div class="flex flex-col gap-2">
<label class="cursor-pointer rounded-full border border-gray-300 bg-white px-4 py-2 text-sm font-semibold hover:bg-gray-50" for="account-photo-upload">
                    Trocar Foto
                </label>
<button class="rounded-full border border-red-200 bg-red-50 px-4 py-2 text-sm font-semibold text-red-700 hover:bg-red-100" id="btn-remove-photo" type="button">
                    Remover Foto
                </button>
</div>
<input accept="image/jpeg,image/png,image/webp" class="hidden" id="account-photo-upload" type="file"/>
</div>
</div>
<div>
<label class="text-sm font-medium text-gray-700">Sua Bio</label>
<textarea class="mt-1 w-full min-h-[80px] rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="account-bio" placeholder="Fale um pouco sobre você..."></textarea>
</div>
<div class="flex items-center justify-between rounded-2xl bg-gray-50 p-3 ring-subtle">
<label class="text-sm font-medium text-gray-700" for="account-private">Tornar perfil privado</label>
<label class="relative inline-flex items-center cursor-pointer">
<input class="sr-only peer" id="account-private" type="checkbox"/>
<div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-pink-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-600"></div>
</div>
</div>
<div class="hidden rounded-xl bg-red-50 px-3 py-2 text-sm text-red-700" id="account-error"></div>
<div class="flex justify-end">
<button class="inline-flex items-center rounded-full bg-pink-600 px-5 py-2.5 text-sm font-semibold text-white hover:opacity-90" type="submit">Salvar Perfil</button>
</div>
</form>
<div class="mt-6 rounded-3xl bg-white p-6 shadow-soft ring-subtle">
<div class="flex border-b border-gray-200">
<button class="tab-btn flex-1 pb-3 font-semibold border-b-2 border-pink-600 text-pink-600" data-tab="followers">Seguidores</button>
<button class="tab-btn flex-1 pb-3 font-semibold border-b-2 border-transparent text-gray-500" data-tab="following">Seguindo</button>
</div>
<div class="mt-4 space-y-3" id="followers-list"></div>
<div class="mt-4 space-y-3 hidden" id="following-list"></div>
</div>
<div class="mt-6 rounded-3xl bg-white p-6 shadow-soft ring-subtle">
<h3 class="text-lg font-semibold">Próximos eventos confirmados</h3>
<div class="mt-3 space-y-2 text-xs" id="my-upcoming-events"></div>
</div>
<div class="mt-6 rounded-3xl bg-white p-6 shadow-soft ring-subtle">
<h3 class="text-lg font-semibold">Eventos que já fui</h3>
<div class="mt-3 space-y-2 text-xs" id="my-past-events"></div>
</div>
</section>
<!-- ADMIN -->
<section class="hidden max-w-6xl mx-auto px-4 pb-28" id="view-admin">
<div class="flex items-center justify-between">
<h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Painel Admin</h2>
<div class="flex items-center gap-2">
<button class="inline-flex items-center rounded-full bg-pink-600 px-5 py-2.5 text-sm font-semibold text-white hover:opacity-90" id="btn-new-event">Novo Evento</button>
</div>
</div>
<!-- CORREÇÃO: Painel de Bairros/Gêneros movido para o topo -->
<div class="mt-6 rounded-3xl bg-white p-4 shadow-soft ring-subtle">
<div class="flex items-center justify-between rounded-3xl px-5 py-3">
<h3 class="flex-1 font-semibold text-lg">Bairros &amp; Gêneros</h3>
<button class="rounded-full border border-gray-200 px-3 py-1.5 text-sm hover:bg-gray-50" id="toggle-taxonomy-panel">Mostrar/Ocultar</button>
</div>
<div class="mt-4 hidden" id="taxonomy-panel">
<div class="grid gap-4 md:grid-cols-2">
<div class="rounded-2xl ring-subtle p-4">
<h4 class="font-semibold">Bairros</h4>
<form class="mt-2 flex gap-2" id="bairro-form">
<input class="flex-1 rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="bairro-name-input" placeholder="Ex: Copacabana" type="text"/>
<button class="rounded-2xl bg-pink-600 px-4 py-3 text-sm font-semibold text-white hover:opacity-90" type="submit">Adicionar</button>
</form>
<div class="hidden mt-2 rounded-xl bg-red-50 px-3 py-2 text-sm text-red-700" id="bairro-error"></div>
<ul class="mt-3 space-y-2 text-sm" id="bairro-list"></ul>
</div>
<div class="rounded-2xl ring-subtle p-4">
<h4 class="font-semibold">Gêneros Musicais</h4>
<form class="mt-2 flex gap-2" id="genero-form">
<input class="flex-1 rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="genero-name-input" placeholder="Ex: Funk" type="text"/>
<button class="rounded-2xl bg-pink-600 px-4 py-3 text-sm font-semibold text-white hover:opacity-90" type="submit">Adicionar</button>
</form>
<div class="hidden mt-2 rounded-xl bg-red-50 px-3 py-2 text-sm text-red-700" id="genero-error"></div>
<ul class="mt-3 space-y-2 text-sm" id="genero-list"></ul>
</div>
</div>
</div>
</div>
<div class="mt-6 grid gap-4 md:grid-cols-3">
<div class="rounded-3xl bg-white p-4 shadow-soft ring-subtle md:col-span-2">
<h3 class="text-lg font-semibold">Gerenciar administradores</h3>
<p class="text-sm text-gray-600 mb-3">Conceda ou remova acesso de administrador por e-mail.</p>
<div class="flex flex-col gap-2 sm:flex-row">
<input class="flex-1 rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="role-email" placeholder="email@exemplo.com" type="email"/>
<button class="rounded-2xl bg-emerald-600 px-4 py-3 text-sm font-semibold text-white hover:opacity-90" id="btn-grant-admin">Tornar Admin</button>
<button class="rounded-2xl bg-red-600 px-4 py-3 text-sm font-semibold text-white hover:opacity-90" id="btn-revoke-admin">Remover Admin</button>
</div>
<div class="hidden mt-2 rounded-xl bg-red-50 px-3 py-2 text-sm text-red-700" id="role-error"></div>
</div>
<div class="rounded-3xl bg-white p-4 shadow-soft ring-subtle">
<h3 class="text-lg font-semibold mb-2">Admins atuais</h3>
<ul class="space-y-2 text-sm text-gray-700" id="admins-list"></ul>
</div>
</div>
<div class="mt-6 rounded-3xl bg-white p-4 shadow-soft ring-subtle">
<h3 class="text-lg font-semibold">Configurações Gerais</h3>
<p class="text-sm text-gray-600 mb-3">Gerencie links e outras configurações globais.</p>
<form class="space-y-3" id="general-settings-form">
<div>
<label class="text-sm font-medium" for="whatsapp-link-input">Link do WhatsApp para Suporte</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="whatsapp-link-input" placeholder="https://wa.me/55..." type="url"/>
</div>
<div class="flex justify-end">
<button class="rounded-2xl bg-pink-600 px-4 py-3 text-sm font-semibold text-white hover:opacity-90" type="submit">Salvar Configurações</button>
</div>
</form>
</div>
<div class="mt-6 rounded-3xl bg-white p-4 shadow-soft ring-subtle">
<h3 class="text-lg font-semibold">Gerenciar Locais/Eventos Recorrentes</h3>
<p class="text-sm text-gray-600 mb-3">Adicione locais que recebem eventos com frequência para agrupar avaliações.</p>
<form class="flex gap-2" id="recurring-event-form">
<input class="flex-1 rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="recurring-event-name" placeholder="Nome do Local/Evento Recorrente" required="" type="text"/>
<button class="rounded-2xl bg-pink-600 px-4 py-3 text-sm font-semibold text-white hover:opacity-90" type="submit">Salvar</button>
</form>
<div class="hidden mt-2 rounded-xl bg-red-50 px-3 py-2 text-sm text-red-700" id="recurring-event-error"></div>
<div class="mt-4 divide-y divide-gray-100" id="recurring-events-list"></div>
</div>
<div class="mt-6 rounded-3xl bg-white p-4 shadow-soft ring-subtle">
<h3 class="text-lg font-semibold">Solicitações de Organizadores</h3>
<p class="text-sm text-gray-600 mb-3">Aprovar ou recusar cadastro de empresas.</p>
<div class="divide-y divide-gray-100" id="org-requests"></div>
</div>
<div class="mt-6 rounded-3xl bg-white p-4 shadow-soft ring-subtle">
<h3 class="text-lg font-semibold">Gerenciar Organizadores</h3>
<p class="text-sm text-gray-600 mb-3">Remover acesso de organizadores aprovados.</p>
<div class="divide-y divide-gray-100" id="approved-organizers-list"></div>
</div>
<div class="mt-6 rounded-3xl bg-white p-4 shadow-soft ring-subtle">
<h3 class="text-lg font-semibold">Eventos pendentes</h3>
<p class="text-sm text-gray-600 mb-3">Aguardando aprovação. Você pode editar antes de aprovar.</p>
<div class="grid gap-3" id="pending-events"></div>
</div>

                    <!-- Eventos Privados - Solicitações Pendentes -->
                    <div class="mt-6 rounded-3xl bg-white p-4 shadow-soft ring-subtle">
                        <h3 class="text-lg font-semibold">Eventos Privados - Solicitações Pendentes</h3>
                        <p class="text-sm text-gray-600 mb-3">Aprovar ou recusar solicitações de acesso a eventos privados.</p>
                        
                        <!-- Barra de pesquisa -->
                        <div class="search-container">
                            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" class="search-input" id="search-admin-pending-requests" placeholder="Pesquisar por nome de usuário...">
                        </div>
                        
                        <div class="space-y-4" id="admin-private-events-requests">
                            <!-- Solicitações serão carregadas aqui -->
                        </div>
                        <div class="hidden mt-6 text-center text-gray-500" id="empty-admin-private-requests">Nenhuma solicitação pendente para eventos privados.</div>
                    </div>

                    <!-- Eventos Privados - Pessoas Aprovadas -->
                    <div class="mt-6 rounded-3xl bg-white p-4 shadow-soft ring-subtle">
                        <h3 class="text-lg font-semibold">Eventos Privados - Pessoas Aprovadas</h3>
                        <p class="text-sm text-gray-600 mb-3">Gerenciar pessoas que têm acesso a eventos privados.</p>
                        
                        <!-- Barra de pesquisa -->
                        <div class="search-container">
                            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" class="search-input" id="search-admin-approved-users" placeholder="Pesquisar por nome de usuário...">
                        </div>
                        
                        <div class="space-y-4" id="admin-private-events-approved">
                            <!-- Pessoas aprovadas serão carregadas aqui -->
                        </div>
                        <div class="hidden mt-6 text-center text-gray-500" id="empty-admin-private-approved">Nenhuma pessoa aprovada para eventos privados.</div>
                    </div>
<!-- ÁREA DE GERENCIAMENTO DE EVENTOS UNIFICADA -->
<div class="mt-6 rounded-3xl md:bg-white md:shadow-soft md:ring-subtle md:overflow-hidden">
<div class="p-4 flex flex-col md:flex-row justify-between md:items-center gap-4 border-b border-gray-100">
<h3 class="text-lg font-semibold">Gerenciar Eventos</h3>
<div class="flex-shrink-0 flex rounded-full bg-gray-100 p-1">
<button class="px-4 py-1.5 text-sm font-semibold rounded-full bg-white shadow" id="admin-tab-active">Ativos</button>
<button class="px-4 py-1.5 text-sm font-semibold rounded-full text-gray-600" id="admin-tab-past">Passados</button>
</div>
</div>
<div class="px-4 pt-4 hidden" id="active-events-search-container">
<input class="w-full rounded-full border border-gray-200 bg-gray-50 px-4 py-2.5" id="active-events-search" placeholder="Buscar eventos ativos por nome, local ou gênero."/>
</div>
<div class="px-4 pt-4 hidden" id="past-events-search-container">
<input class="w-full rounded-full border border-gray-200 bg-gray-50 px-4 py-2.5" id="past-events-search" placeholder="Buscar eventos passados por nome..."/>
</div>
<div class="admin-table-container max-h-[60vh] md:overflow-auto p-4 md:p-0">
<table class="min-w-full">
<thead class="bg-gray-50/60" id="admin-events-thead">
<!-- Conteúdo do cabeçalho da tabela inserido via JS -->
</thead>
<tbody class="bg-transparent md:divide-y md:divide-gray-200 md:bg-white" id="admin-events-tbody">
<!-- Conteúdo do corpo da tabela inserido via JS -->
</tbody>
</table>
<p class="hidden text-center text-sm text-gray-500 p-6" id="admin-events-placeholder"></p>
</div>
</div>
</section>
<!-- MODAL: LOGIN -->
<div class="fixed inset-0 z-[80] hidden" id="auth-login">
<div class="absolute inset-0 fade" data-close="auth-login"></div>
<div class="relative z-[81] mx-auto mt-20 w-[92%] max-w-md rounded-3xl bg-white p-8 shadow-soft ring-subtle pop">
<button aria-label="Fechar" class="absolute right-3 top-3 rounded-full p-2 hover:bg-gray-100" data-close="auth-login">✕</button>
<div class="text-center mb-6">
<h3 class="text-2xl font-extrabold">Bem-vindo!</h3>
<p class="text-sm text-gray-500">Acesse sua conta para continuar.</p>
</div>
<form class="space-y-4" id="form-login">
<input class="w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="login-email" placeholder="E-mail" required="" type="email"/>
<input class="w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="login-pass" placeholder="Senha" required="" type="password">
<div class="flex items-center justify-between text-sm">
<button class="text-pink-600 font-semibold" id="btn-forgot" type="button">Esqueceu a senha?</button>
<button class="text-pink-600 font-semibold" id="switch-register" onclick="document.getElementById('auth-login').classList.add('hidden');document.getElementById('auth-register').classList.remove('hidden')" type="button">Registrar-se</button>
</div>
<div class="hidden rounded-xl bg-red-50 px-3 py-2 text-sm text-red-700" id="err-login"></div>
<button class="w-full inline-flex items-center justify-center rounded-2xl bg-pink-600 px-5 py-3 text-[15px] font-semibold text-white hover:opacity-90" id="submit-login">Entrar</button>
</input></form>
</div>
</div>
<!-- MODAL: REGISTER (com opção de organizador) -->
<div class="fixed inset-0 z-[80] hidden" id="auth-register">
<div class="absolute inset-0 fade" data-close="auth-register"></div>
<div class="relative z-[81] mx-auto mt-8 w-[92%] max-w-xl rounded-3xl bg-white shadow-soft ring-subtle pop max-h-[88vh] flex flex-col">
<div class="sticky top-0 z-10 flex items-center justify-between px-6 pt-5 pb-3 bg-white/95 backdrop-blur rounded-t-3xl border-b border-gray-100">
<div class="text-center flex-1">
<h3 class="text-xl font-semibold">Crie sua Conta</h3>
<p class="text-sm text-gray-500">Leva menos de um minuto.</p>
</div>
<button aria-label="Fechar" class="rounded-full p-2 hover:bg-gray-100" data-close="auth-register">✕</button>
</div>
<form class="px-6 pb-3 overflow-y-auto space-y-4 mt-4" id="form-register">
<div class="grid gap-3 md:grid-cols-2">
<input class="w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="reg-name" placeholder="Nome completo" required="" type="text"/>
<input class="w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="reg-username" placeholder="Nome de usuário (@exemplo)" required="" type="text"/>
<input class="w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="reg-email" placeholder="E-mail" required="" type="email"/>
<input class="w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="reg-pass" placeholder="Senha (mín. 6)" required="" type="password"/>
</div>
<label class="flex items-center gap-2 select-none text-sm"><input class="h-4 w-4" id="reg-organizer-check" type="checkbox"/> Sou organizador de eventos</label>
<div class="hidden grid gap-3 md:grid-cols-2" id="reg-organizer-form">
<input class="rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="org-company" placeholder="Nome da empresa"/>
<input class="rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="org-cnpj" placeholder="CNPJ (opcional)">
<input class="rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="org-phone" placeholder="Telefone"/>
<input class="rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="org-website" placeholder="Site ou Instagram"/>
<textarea class="md:col-span-2 rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="org-about" placeholder="Sobre a empresa"></textarea>
</input></div>
<div class="flex items-start gap-2 text-sm">
<input class="mt-0.5" id="reg-terms" required="" type="checkbox"/>
<label class="text-gray-600" for="reg-terms">Eu li e aceito os <a class="text-pink-600 hover:underline" href="https://firebasestorage.googleapis.com/v0/b/riofestas2.firebasestorage.app/o/termos%20de%20uso.html?alt=media&amp;token=f7f7a4f3-b414-4bb8-b631-e2704652eb83" target="_blank">Termos de Uso e a Política de Privacidade</a>.</label>
</div>
<div class="hidden rounded-xl bg-red-50 px-3 py-2 text-sm text-red-700" id="err-register"></div>
<div class="sticky bottom-0 z-10 -mx-6 mt-4 px-6 pt-3 pb-4">
<button class="w-full inline-flex items-center justify-center rounded-2xl bg-pink-600 px-5 py-3 text-[15px] font-semibold text-white hover:opacity-90" id="submit-register">Registrar</button>
</div>
</form>
</div>
</div>
<!-- MODAL: NEW / EDIT EVENT (ADMIN) -->
<div class="fixed inset-0 z-[60] hidden" id="event-modal">
<div class="absolute inset-0 bg-black/40 backdrop-blur-sm fade" data-close="event"></div>
<div class="relative z-[61] mx-auto mt-8 w-[94%] max-w-2xl rounded-3xl bg-white shadow-soft ring-subtle pop max-h-[88vh] flex flex-col">
<div class="sticky top-0 z-10 flex items-center justify-between px-6 pt-5 pb-3 bg-white/95 backdrop-blur rounded-t-3xl border-b border-gray-100">
<h3 class="text-xl font-semibold" id="event-modal-title">Novo Evento</h3>
<button aria-label="Fechar" class="rounded-full p-2 hover:bg-gray-100" data-close="event">✕</button>
</div>
<form class="px-6 pb-3 overflow-y-auto" id="event-form">
<div class="grid grid-cols-1 gap-4 md:grid-cols-2">
<div class="md:col-span-2">
<label class="text-[13px] font-medium text-gray-700">Nome do Evento</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="ev-name" required="" type="text"/>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Data de Início</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="ev-date" required="" type="date"/>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Horário (início)</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="ev-time-start" type="time"/>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Data de Fim (opcional)</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="ev-date-end" type="date"/>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Horário (fim)</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="ev-time-end" type="time"/>
</div>
<div class="md:col-span-2">
<label class="text-[13px] font-medium text-gray-700">Endereço</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="ev-local" required="" type="text"/>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Bairro</label>
<select class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="ev-bairro">
<option value="">Selecione...</option>
</select>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Gênero Musical</label>
<p class="hidden md:block mt-1 text-xs text-gray-500">Use Ctrl + setas para rolar entre os gêneros e clique com o mouse para selecionar.</p>
<select class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="ev-genero" multiple="" size="6">
<option value="">Selecione...</option>
</select>
</div>
<div class="md:col-span-2">
<label class="text-[13px] font-medium text-gray-700">Local/Evento Recorrente (Opcional)</label>
<select class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="ev-recurring">
<option value="">Nenhum</option>
</select>
</div>
<!-- RECURRING EVENT OPTIONS -->
<div class="md:col-span-2 space-y-2 rounded-2xl bg-gray-50 p-3 ring-subtle">
<div class="flex items-center justify-between">
<label class="text-[13px] font-medium text-gray-700 cursor-pointer select-none" for="ev-repeats-weekly">Repetir semanalmente</label>
<label class="relative inline-flex items-center cursor-pointer">
<input class="sr-only peer" id="ev-repeats-weekly" type="checkbox"/>
<div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-pink-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-600"></div>
</label>
</div>
<div class="hidden pt-2" id="ev-repeat-options">
<label class="text-[13px] font-medium text-gray-700">Semanas visíveis simultaneamente</label>
<select class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-pink-600/35" id="ev-display-count">
<option value="1">1 semana (padrão)</option>
<option value="2">2 semanas</option>
<option value="3">3 semanas</option>
<option value="4">4 semanas</option>
<option value="5">5 semanas</option>
<option value="6">6 semanas</option>
<option value="7">7 semanas</option>
<option value="8">8 semanas</option>
<option value="9">9 semanas</option>
<option value="10">10 semanas</option>
</select>
</div>
</div>
<div class="md:col-span-2">
<label class="text-[13px] font-medium text-gray-700">Descrição</label>
<textarea class="mt-1 w-full min-h-[100px] rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="ev-desc" placeholder="Detalhes do evento..."></textarea>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Link de Compra</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="ev-buy" placeholder="https://..." type="url"/>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Cupom de Desconto</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="ev-coupon" placeholder="RIO10" type="text"/>
</div>
<div class="md:col-span-2">
<label class="text-[13px] font-medium text-gray-700">Importância (0–10)</label>
<div class="mt-1 flex items-center gap-3">
<input class="w-full" id="ev-importance" max="10" min="0" step="1" type="range" value="5"/>
<span class="w-10 text-right font-semibold" id="ev-importance-value">5</span>
</div>
</div>
<div class="md:col-span-2">
<label class="flex items-center gap-2 cursor-pointer">
<input class="h-4 w-4" id="ev-private" type="checkbox"/>
<span class="text-[13px] font-medium text-gray-700">Evento privado</span>
</label>
<p class="text-xs text-gray-500 mt-1">Eventos privados só mostram informações básicas para usuários não logados. Usuários logados precisam solicitar acesso.</p>
</div>
<div class="md:col-span-2">
<label class="text-[13px] font-medium text-gray-700">Fotos do Evento</label>
<div class="mt-1">
<label class="w-full inline-block text-center rounded-2xl bg-pink-600 px-4 py-3 text-sm font-semibold text-white cursor-pointer hover:opacity-90" for="ev-photo-upload">
                    Selecionar Fotos
                </label>
<input accept="image/jpeg,image/png,image/webp" class="hidden" id="ev-photo-upload" multiple="" type="file"/>
</div>
<p class="mt-1 text-xs text-gray-500">Selecione uma ou mais imagens (JPG, PNG, WEBP). Você pode remover imagens abaixo.</p>
<div class="mt-3 grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-4" id="preview-photos"></div>
</div>
<div class="md:col-span-2 hidden rounded-xl bg-red-50 px-3 py-2 text-sm text-red-700" id="event-error"></div>
</div>
<div class="sticky bottom-0 z-10 -mx-6 mt-4 bg-gradient-to-t from-white via-white/95 to-white/0 px-6 pt-3 pb-4 border-t border-gray-100 flex items-center justify-end gap-2">
<button class="inline-flex items-center rounded-full border border-gray-200 bg-white px-4 py-2.5 text-sm font-semibold hover:bg-gray-50" data-close="event" type="button">Cancelar</button>
<button class="inline-flex items-center rounded-full bg-pink-600 px-5 py-2.5 text-sm font-semibold text-white hover:opacity-90" id="btn-save-event" type="submit">Salvar Evento</button>
</div>
</form>
</div>
</div>
<!-- MODAL: EVENTO (ORGANIZADOR) sem prioridade -->
<div class="fixed inset-0 z-[60] hidden" id="org-event-modal">
<div class="absolute inset-0 bg-black/40 backdrop-blur-sm fade" data-close="org-event"></div>
<div class="relative z-[61] mx-auto mt-8 w-[94%] max-w-2xl rounded-3xl bg-white shadow-soft ring-subtle pop max-h-[88vh] flex flex-col">
<div class="sticky top-0 z-10 flex items-center justify-between px-6 pt-5 pb-3 bg-white/95 backdrop-blur rounded-t-3xl border-b border-gray-100">
<h3 class="text-xl font-semibold">Criar evento (Organizador)</h3>
<button aria-label="Fechar" class="rounded-full p-2 hover:bg-gray-100" data-close="org-event">✕</button>
</div>
<form class="px-6 pb-3 overflow-y-auto" id="org-event-form">
<div class="grid grid-cols-1 gap-4 md:grid-cols-2">
<div class="md:col-span-2">
<label class="text-[13px] font-medium text-gray-700">Nome do Evento</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="org-ev-name" required="" type="text"/>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Data de Início</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="org-ev-date" required="" type="date"/>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Horário (início)</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="org-ev-time-start" type="time"/>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Data de Fim (opcional)</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="org-ev-date-end" type="date"/>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Horário (fim)</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="org-ev-time-end" type="time"/>
</div>
<div class="md:col-span-2">
<label class="text-[13px] font-medium text-gray-700">Endereço</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="org-ev-local" required="" type="text"/>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Bairro</label>
<select class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="org-ev-bairro">
<option value="">Selecione...</option>
</select>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Gênero Musical</label>
<p class="hidden md:block mt-1 text-xs text-gray-500">Use Ctrl + setas para rolar entre os gêneros e clique com o mouse para selecionar.</p>
<select class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="org-ev-genero" multiple="" size="6">
<option value="">Selecione...</option>
</select>
</div>
<div class="md:col-span-2">
<label class="text-[13px] font-medium text-gray-700">Local/Evento Recorrente (Opcional)</label>
<select class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-pink-600/35" id="org-ev-recurring">
<option value="">Nenhum</option>
</select>
</div>
<!-- RECURRING EVENT OPTIONS (ORGANIZER) -->
<div class="md:col-span-2 space-y-2 rounded-2xl bg-gray-50 p-3 ring-subtle">
<div class="flex items-center justify-between">
<label class="text-[13px] font-medium text-gray-700 cursor-pointer select-none" for="org-ev-repeats-weekly">Repetir semanalmente</label>
<label class="relative inline-flex items-center cursor-pointer">
<input class="sr-only peer" id="org-ev-repeats-weekly" type="checkbox"/>
<div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-pink-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-600"></div>
</label>
</div>
<div class="hidden pt-2" id="org-ev-repeat-options">
<label class="text-[13px] font-medium text-gray-700">Semanas visíveis simultaneamente</label>
<select class="mt-1 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-pink-600/35" id="org-ev-display-count">
<option value="1">1 semana (padrão)</option>
<option value="2">2 semanas</option>
<option value="3">3 semanas</option>
<option value="4">4 semanas</option>
<option value="5">5 semanas</option>
<option value="6">6 semanas</option>
<option value="7">7 semanas</option>
<option value="8">8 semanas</option>
<option value="9">9 semanas</option>
<option value="10">10 semanas</option>
</select>
</div>
</div>
<div class="md:col-span-2">
<label class="text-[13px] font-medium text-gray-700">Descrição</label>
<textarea class="mt-1 w-full min-h-[100px] rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="org-ev-desc" placeholder="Detalhes do evento..."></textarea>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Link de Compra</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="org-ev-buy" type="url"/>
</div>
<div>
<label class="text-[13px] font-medium text-gray-700">Cupom de Desconto</label>
<input class="mt-1 w-full rounded-2xl border border-gray-300 bg-gray-50 px-4 py-3" id="org-ev-coupon" type="text"/>
</div>
<div class="md:col-span-2">
<label class="flex items-center gap-2 cursor-pointer">
<input class="h-4 w-4" id="org-ev-private" type="checkbox"/>
<span class="text-[13px] font-medium text-gray-700">Evento privado</span>
</label>
<p class="text-xs text-gray-500 mt-1">Eventos privados só mostram informações básicas para usuários não logados. Usuários logados precisam solicitar acesso.</p>
</div>
<div class="md:col-span-2">
<label class="text-[13px] font-medium text-gray-700">Fotos</label>
<div class="mt-1">
<label class="w-full inline-block text-center rounded-2xl bg-pink-600 px-4 py-3 text-sm font-semibold text-white cursor-pointer hover:opacity-90" for="org-ev-photo-upload">
                    Selecionar Fotos
                </label>
<input accept="image/jpeg,image/png,image/webp" class="hidden" id="org-ev-photo-upload" multiple="" type="file"/>
</div>
<p class="mt-1 text-xs text-gray-500">Selecione uma ou mais imagens (JPG, PNG, WEBP). Você pode remover imagens abaixo.</p>
<div class="mt-3 grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-4" id="org-preview-photos"></div>
</div>
<div class="md:col-span-2 hidden rounded-xl bg-red-50 px-3 py-2 text-sm text-red-700" id="org-event-error"></div>
</div>
<div class="sticky bottom-0 z-10 -mx-6 mt-4 bg-gradient-to-t from-white via-white/95 to-white/0 px-6 pt-3 pb-4 border-t border-gray-100 flex items-center justify-end gap-2">
<button class="inline-flex items-center rounded-full border border-gray-200 bg-white px-4 py-2.5 text-sm font-semibold hover:bg-gray-50" data-close="org-event" type="button">Cancelar</button>
<button class="inline-flex items-center rounded-full bg-pink-600 px-5 py-2.5 text-sm font-semibold text-white" id="org-btn-save" type="submit">Enviar para aprovação</button>
</div>
</form>
</div>
</div>
<!-- MODAL: VISUALIZAÇÃO DO EVENTO -->
<div class="fixed inset-0 z-[60] hidden" id="event-view">
<div class="absolute inset-0 bg-black/40 backdrop-blur-sm fade" data-close="view"></div>
<div class="relative z-[61] mx-auto mt-8 w-[96%] max-w-4xl rounded-3xl bg-white shadow-soft ring-subtle pop max-h-[92vh] overflow-hidden flex flex-col">
<div class="sticky top-0 z-10 flex items-center justify-between px-6 pt-5 pb-3 bg-white/95 backdrop-blur rounded-t-3xl border-b border-gray-100">
<h3 class="text-xl font-semibold" id="view-title">Evento</h3>
<button aria-label="Fechar" class="rounded-full p-2 hover:bg-gray-100" data-close="view">✕</button>
</div>
<div class="grid md:grid-cols-[1.2fr_.8fr] gap-6 p-6 overflow-y-auto">
<div>
<div class="grid grid-cols-1 md:gap-3" id="view-gallery"></div>
</div>
<aside class="space-y-4">
<div class="rounded-3xl ring-subtle p-4">
<div class="text-sm text-gray-500">Data</div>
<div class="text-lg font-semibold" id="view-date">—</div>
<div class="mt-3 text-sm text-gray-500">Local</div>
<div class="text-lg font-semibold" id="view-local">—</div>
<div class="mt-3 text-sm text-gray-500">Estilo</div>
<div class="text-lg font-semibold" id="view-style">—</div>
</div>
<div class="hidden rounded-3xl ring-subtle p-4" id="view-rating-display-container"></div>
<div class="rounded-3xl ring-subtle p-4">
<div class="text-sm text-gray-500">Descrição</div>
<p class="mt-1 text-[15px] leading-relaxed text-gray-700" id="view-desc">—</p>
</div>
<div class="rounded-3xl ring-subtle p-4 space-y-2">
<a class="block w-full text-center rounded-full bg-pink-600 px-4 py-3 text-sm font-semibold text-white hover:opacity-90 disabled:opacity-50" id="view-buy" target="_blank">Comprar Ingresso</a>
<div class="text-center text-sm text-gray-600">Cupom: <span class="font-semibold" id="view-coupon">—</span></div>
</div>
<div class="rounded-3xl ring-subtle p-4">
<button class="w-full inline-flex items-center justify-center gap-2 rounded-full bg-emerald-600 px-4 py-3 text-sm font-semibold text-white hover:opacity-90" id="btn-going">
<svg fill="none" height="16" viewbox="0 0 24 24" width="16"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
<span id="btn-going-text">Confirmar Presença</span>
</button>
<div class="mt-2 text-center text-xs text-gray-500" id="going-count"></div>
<!-- Amigos que vão -->
<div class="mt-2 text-center hidden" id="friends-going-container">
<button class="inline-flex items-center gap-2 rounded-full bg-pink-50 px-3 py-1.5 text-sm font-semibold text-pink-700 hover:bg-pink-100" id="friends-going-button">
<!-- Text set by JS -->
</button>
</div>
</div>
<div class="hidden rounded-3xl ring-subtle p-4" id="view-rating-input-container"></div>
</aside>
</div>
</div>
</div>
<!-- MODAL DE PERFIL DE USUÁRIO -->
<div class="fixed inset-0 z-[70] hidden" id="user-profile-modal">
<div class="absolute inset-0 fade" data-close="user-profile"></div>
<div class="relative z-[71] mx-auto mt-4 w-[96%] max-w-2xl rounded-3xl bg-white shadow-soft ring-subtle pop max-h-[95vh] overflow-hidden flex flex-col">
<div class="sticky top-0 z-10 flex items-center justify-between px-6 pt-5 pb-3 bg-white/95 backdrop-blur rounded-t-3xl border-b border-gray-100">
<h3 class="text-xl font-semibold" id="profile-title">Perfil de Usuário</h3>
<button aria-label="Fechar" class="rounded-full p-2 hover:bg-gray-100" data-close="user-profile">✕</button>
</div>
<div class="px-6 py-4 overflow-y-auto flex-1" id="profile-content"></div>
</div>
</div>
<!-- MODAL: LISTA DE AMIGOS -->
<div class="fixed inset-0 z-[70] hidden" id="friends-list-modal">
<div class="absolute inset-0 bg-black/40 backdrop-blur-sm fade" data-close="friends-list"></div>
<div class="relative z-[71] mx-auto mt-20 w-[92%] max-w-sm rounded-3xl bg-white p-6 shadow-soft ring-subtle pop">
<div class="flex items-center justify-between">
<h3 class="text-xl font-semibold">Amigos que vão</h3>
<button aria-label="Fechar" class="rounded-full p-2 hover:bg-gray-100" data-close="friends-list">✕</button>
</div>
<div class="mt-4 max-h-[60vh] overflow-y-auto space-y-3" id="friends-list-content">
<!-- Friends list will be populated by JS -->
</div>
</div>
</div>
<!-- MODAL: LISTA DE SEGUIDORES/SEGUINDO -->
<div class="fixed inset-0 z-[75] hidden" id="follow-list-modal">
<div class="absolute inset-0 bg-black/40 backdrop-blur-sm fade" data-close="follow-list"></div>
<div class="relative z-[76] mx-auto mt-20 w-[92%] max-w-sm rounded-3xl bg-white p-6 shadow-soft ring-subtle pop">
<div class="flex items-center justify-between">
<h3 class="text-xl font-semibold" id="follow-list-title">Lista</h3>
<button aria-label="Fechar" class="rounded-full p-2 hover:bg-gray-100" data-close="follow-list">✕</button>
</div>
<div class="mt-4 max-h-[60vh] overflow-y-auto space-y-2" id="follow-list-content">
<!-- User list will be populated by JS -->
</div>
</div>
</div>
<!-- Modal: Aprovar pendente -->
<div class="fixed inset-0 z-[70] hidden" id="approve-modal">
<div class="absolute inset-0 bg-black/40 backdrop-blur-sm" data-close="approve"></div>
<div class="relative z-[71] mx-auto mt-40 w-[92%] max-w-sm rounded-2xl bg-white p-5 shadow-soft ring-subtle">
<h4 class="text-lg font-semibold">Definir importância (0–10)</h4>
<div class="mt-3 flex items-center gap-3">
<input class="w-full" id="approve-importance" max="10" min="0" type="range" value="5"/>
<span class="w-8 text-right font-semibold" id="approve-importance-value">5</span>
</div>
<div class="mt-4 flex justify-end gap-2">
<button class="rounded-full border border-gray-200 px-4 py-2.5 text-sm" data-close="approve">Cancelar</button>
<button class="rounded-full bg-pink-600 px-4 py-2.5 text-sm font-semibold text-white" id="approve-confirm">Aprovar</button>
</div>
</div>
</div>
<div class="fixed inset-0 z-[70] hidden" id="organizer-details-modal">
<div class="absolute inset-0 bg-black/40 backdrop-blur-sm fade" data-close="organizer-details"></div>
<div class="relative z-[71] mx-auto mt-20 w-[92%] max-w-lg rounded-3xl bg-white p-6 shadow-soft ring-subtle pop">
<div class="flex items-center justify-between">
<h3 class="text-xl font-semibold">Detalhes do Organizador</h3>
<button aria-label="Fechar" class="rounded-full p-2 hover:bg-gray-100" data-close="organizer-details">✕</button>
</div>
<div class="mt-4 space-y-3 text-sm" id="organizer-details-content"></div>
</div>
</div>
<!-- Modal de Confirmação para Excluir Evento -->
<div class="fixed inset-0 z-[70] hidden" id="delete-modal">
<div class="absolute inset-0 bg-black/40 backdrop-blur-sm" data-close="delete"></div>
<div class="relative z-[71] mx-auto mt-40 w-[92%] max-w-sm rounded-3xl bg-white p-6 shadow-soft ring-subtle pop">
<h4 class="text-lg font-bold">Confirmar Exclusão</h4>
<p class="mt-2 text-sm text-gray-600">Você tem certeza que deseja excluir o evento "<span class="font-semibold" id="delete-event-name"></span>"? Esta ação não pode ser desfeita.</p>
<div class="mt-5 flex justify-end gap-2">
<button class="rounded-full border border-gray-200 bg-white px-4 py-2.5 text-sm font-semibold hover:bg-gray-50" data-close="delete">Cancelar</button>
<button class="rounded-full bg-red-600 px-4 py-2.5 text-sm font-semibold text-white hover:opacity-90" id="delete-confirm-btn">Excluir</button>
</div>
</div>
</div>
<!-- Modal de Confirmação para Remover Seguidor -->
<div class="fixed inset-0 z-[70] hidden" id="remove-follower-modal">
<div class="absolute inset-0 bg-black/40 backdrop-blur-sm" data-close="remove-follower"></div>
<div class="relative z-[71] mx-auto mt-40 w-[92%] max-w-sm rounded-3xl bg-white p-6 shadow-soft ring-subtle pop">
<h4 class="text-lg font-bold">Remover Seguidor</h4>
<p class="mt-2 text-sm text-gray-600">Você tem certeza que deseja remover <span class="font-semibold" id="remove-follower-name"></span> dos seus seguidores?</p>
<div class="mt-5 flex justify-end gap-2">
<button class="rounded-full border border-gray-200 bg-white px-4 py-2.5 text-sm font-semibold hover:bg-gray-50" data-close="remove-follower">Cancelar</button>
<button class="rounded-full bg-red-600 px-4 py-2.5 text-sm font-semibold text-white hover:opacity-90" id="remove-follower-confirm-btn">Remover</button>
</div>
</div>
</div>
<!-- Modal de Confirmação para Excluir Notificação -->
<div class="fixed inset-0 z-[70] hidden" id="delete-notification-modal">
<div class="absolute inset-0 bg-black/40 backdrop-blur-sm" data-close="delete-notification"></div>
<div class="relative z-[71] mx-auto mt-40 w-[92%] max-w-sm rounded-3xl bg-white p-6 shadow-soft ring-subtle pop">
<h4 class="text-lg font-bold">Excluir Notificação</h4>
<p class="mt-2 text-sm text-gray-600">Você tem certeza que deseja excluir esta notificação? Esta ação não pode ser desfeita.</p>
<div class="mt-5 flex justify-end gap-2">
<button class="rounded-full border border-gray-200 bg-white px-4 py-2.5 text-sm font-semibold hover:bg-gray-50" data-close="delete-notification">Cancelar</button>
<button class="rounded-full bg-red-600 px-4 py-2.5 text-sm font-semibold text-white hover:opacity-90" id="delete-notification-confirm-btn">Excluir</button>
</div>
</div>
</div>
<!-- Modal de Confirmação para Zerar Avaliações -->
<div class="fixed inset-0 z-[70] hidden" id="reset-ratings-modal">
<div class="absolute inset-0 bg-black/40 backdrop-blur-sm" data-close="reset-ratings"></div>
<div class="relative z-[71] mx-auto mt-40 w-[92%] max-w-sm rounded-3xl bg-white p-6 shadow-soft ring-subtle pop">
<h4 class="text-lg font-bold">Zerar Avaliações</h4>
<p class="mt-2 text-sm text-gray-600">Você tem certeza que deseja apagar todas as avaliações para "<span class="font-semibold" id="reset-ratings-name"></span>"? Esta ação não pode ser desfeita.</p>
<div class="mt-5 flex justify-end gap-2">
<button class="rounded-full border border-gray-200 bg-white px-4 py-2.5 text-sm font-semibold hover:bg-gray-50" data-close="reset-ratings">Cancelar</button>
<button class="rounded-full bg-red-600 px-4 py-2.5 text-sm font-semibold text-white hover:opacity-90" id="reset-ratings-confirm-btn">Zerar</button>
</div>
</div>
</div>

<!-- Modal de solicitação removido - agora usando confirm() padrão do navegador -->

<!-- Modal de Confirmação para Remover Acesso a Evento Privado -->
<div class="fixed inset-0 z-[70] hidden" id="remove-access-modal">
<div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
<div class="relative z-[71] mx-auto mt-40 w-[92%] max-w-sm rounded-3xl bg-white p-6 shadow-soft ring-subtle pop">
<div class="text-center">
<div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-orange-100">
<svg class="h-8 w-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
</svg>
</div>
<h4 class="text-xl font-bold text-gray-900">Remover Acesso</h4>
<p class="mt-2 text-sm text-gray-600">Tem certeza que deseja remover o acesso desta pessoa?</p>
</div>
<div class="mt-6 flex justify-end gap-3">
<button class="rounded-full border border-gray-200 bg-white px-4 py-2.5 text-sm font-semibold text-gray-700 hover:bg-gray-50" id="cancel-remove-access-btn">Cancelar</button>
<button class="rounded-full bg-orange-600 px-4 py-2.5 text-sm font-semibold text-white hover:opacity-90" id="confirm-remove-access-btn">Remover</button>
</div>
</div>
</div>
<!-- Toast Container -->
<div class="pointer-events-none fixed inset-x-0 bottom-5 z-[90] flex flex-col items-center gap-2" id="toast-container"></div>
<!-- Firebase (ESM) -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
    import {
      getAuth, setPersistence, browserLocalPersistence, signInAnonymously,
      onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,
      updateProfile, sendPasswordResetEmail, signOut
    } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
    import {
      getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, serverTimestamp, Timestamp, query, where, getDocs, getDoc,
      runTransaction, increment, writeBatch, orderBy, limit
    } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
    import { 
      getStorage, ref, uploadBytesResumable, getDownloadURL 
    } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js';

    // --- Config do seu projeto ---
    const firebaseConfig = {
      apiKey: 'AIzaSyA_9DrafoKA0dfaprtFvRG5qDt3itFu3Ms',
      authDomain: 'riofestas2.firebaseapp.com',
      projectId: 'riofestas2',
      storageBucket: 'riofestas2.firebasestorage.app',
      messagingSenderId: '50086400997',
      appId: '1:50086400997:web:d7440f7bf48d0e087b150c',
      measurementId: 'G-CCD25NKM4L'
    };

    // --- Inicialização ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Caminhos
    const appId = firebaseConfig.appId;
    const EVENTS_PATH   = `artifacts/${appId}/public/data/events`;
    const EVENT_EXCEPTIONS_PATH = `artifacts/${appId}/public/data/eventExceptions`; 
    const PENDING_PATH  = `artifacts/${appId}/public/data/events_pending`;
    const USERS_PATH    = `artifacts/${appId}/public/data/users`;
    const USERNAMES_PATH = `artifacts/${appId}/public/data/usernames`;
    const ORG_PATH      = `artifacts/${appId}/public/data/organizers`;
    const RECURRING_EVENTS_PATH = `artifacts/${appId}/public/data/recurringEvents`;
    const SETTINGS_PATH = `artifacts/${appId}/public/data/settings`;

    // ===== Utils (ÚNICOS) =====
    const $  = (s)=>document.querySelector(s);
    const $$ = (s)=>document.querySelectorAll(s);
    const show = (el)=> el?.classList.remove('hidden');
    const hide = (el)=> el?.classList.add('hidden');
    
    // Sistema de Toast com Ação
    const toast = (message, type = 'success', options = {}) => {
        const container = $('#toast-container');
        const toastId = 'toast-' + Date.now();
        const toastEl = document.createElement('div');
        const { duration = 4000, actionText = null, onAction = null } = options;
        
        const icons = {
            success: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
            error: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
            info: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
        };

        const colors = {
            success: 'bg-emerald-50 text-emerald-800 ring-emerald-200',
            error: 'bg-red-50 text-red-800 ring-red-200',
            info: 'bg-blue-50 text-blue-800 ring-blue-200'
        };

        toastEl.id = toastId;
        toastEl.className = `pointer-events-auto flex items-center gap-3 w-[90%] max-w-sm rounded-2xl p-4 shadow-lg ring-1 toast-in ${colors[type] || colors.info}`;
        toastEl.innerHTML = `
            <div class="flex-shrink-0">${icons[type] || icons.info}</div>
            <div class="flex-1 text-sm font-medium">${message}</div>
            ${actionText ? `<button data-toast-action class="flex-shrink-0 ml-2 px-3 py-1 rounded-full text-sm font-semibold bg-black/10 hover:bg-black/20 transition-colors">${actionText}</button>` : ''}
            <button data-close-toast="${toastId}" class="flex-shrink-0 ml-2 opacity-70 hover:opacity-100">&times;</button>
        `;
        
        container.appendChild(toastEl);

        const close = () => {
            toastEl.classList.remove('toast-in');
            toastEl.classList.add('toast-out');
            toastEl.addEventListener('animationend', () => toastEl.remove(), { once: true });
        };

        const timer = setTimeout(close, duration);
        
        toastEl.querySelector(`[data-close-toast]`).addEventListener('click', () => {
            clearTimeout(timer);
            close();
        });

        const actionBtn = toastEl.querySelector('[data-toast-action]');
        if (actionBtn && onAction) {
            actionBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                clearTimeout(timer);
                onAction();
                close();
            });
        }
    };

    const initials = (s='U') => (s.split(/[\s@._-]+/).filter(Boolean).slice(0,2).map(x=>x[0]?.toUpperCase()).join('')||'U');

    const weekdayLabels = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
    const weekdayLong   = ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'];
    const fmtDate = (ts)=>{ try{ const d = ts?.toDate ? ts.toDate() : new Date(ts); if(isNaN(d)) return ''; return `${d.toLocaleDateString('pt-BR',{day:'2-digit',month:'short'})} (${weekdayLabels[d.getDay()]})`; }catch{return ''} };
    const parseDateInput = (yyyyMmDd)=>{ try{ const [y,m,d]=yyyyMmDd.split('-').map(Number); return new Date(y, (m||1)-1, d||1); }catch{ return new Date(yyyyMmDd) } };
    
    function startOfToday(){ const x=new Date(); x.setHours(0,0,0,0); return x; }
    function next7End(){ const x=startOfToday(); x.setDate(x.getDate()+6); x.setHours(23,59,59,999); return x; }
    function isEventToday(ev) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const eventDate = ev.date?.toDate ? ev.date.toDate() : new Date(ev.date);
        return eventDate >= today && eventDate < tomorrow;
    }

    // ===== Sessão & roles =====
    const state = { baseEvents: [], events:[], pending:[], users:{}, recurringEvents: [], settings: {}, eventExceptions: {}, isAdmin:false, isOrganizer:false, byDayOffset:0, deleteTarget: null, deleteNotificationTarget: null, removeFollowerTarget: null, resetRatingsTarget: null, userGoingTo: new Set(), userFollowing: new Set(), userFollowers: new Set(), userOutgoingRequests: new Set(), incomingFollowRequests: new Set(), currentViewEvent: null, currentUserData: null, friendsGoingMap: new Map(), editingRecurringEventId: null, newProfilePhotoUrl: null, photoRemovalFlag: false, eventForm: { imageUrls: [], uploadTasks: {} }, orgEventForm: { imageUrls: [], uploadTasks: {} }, adminEventsView: 'active', selectedBairros: new Set(), selectedGeneros: new Set() };
    let _unsubRole = null, _unsubEvents=null, _unsubPending=null, _unsubGoingTo=null, _unsubFollowing=null, _unsubFollowers=null, _unsubOutgoingRequests=null, _unsubIncomingRequests=null, _unsubNotifications=null, _unsubRecurring=null, _unsubSettings=null, _unsubExceptions=null;

    const renderHeader = ()=>{
      const goAdmin = $('#go-admin'), goOrg = $('#go-organizer'), goProfile = $('#go-profile');
      if(auth.currentUser && !auth.currentUser.isAnonymous){
        hide($('#nav-auth')); show($('#nav-user'));
        const user = state.currentUserData;
        $('#user-label').textContent = user?.name || auth.currentUser.displayName || auth.currentUser.email;
        if(user?.photoUrl){
          show($('#user-avatar-img')); hide($('#user-avatar-text'));
          $('#user-avatar-img').src = user.photoUrl;
          $('#user-avatar-img').onerror = () => { $('#user-avatar-img').src = 'https://placehold.co/32x32/f472b6/ffffff?text='+initials(user.name); };
        } else {
          hide($('#user-avatar-img')); show($('#user-avatar-text'));
          $('#user-avatar-text').textContent = initials(user?.name || auth.currentUser.displayName || auth.currentUser.email);
        }
        goAdmin.classList.toggle('hidden', !state.isAdmin);
        goOrg.classList.toggle('hidden', !state.isOrganizer);
        show(goProfile);
      }else{
        show($('#nav-auth')); hide($('#nav-user'));
        hide($('#view-admin'));
        hide($('#view-organizer'));
        hide(goProfile);
      }
    };

    const openLogin = ()=> { show($('#auth-login')); document.body.classList.add('modal-open'); };
    const openRegister = ()=> { show($('#auth-register')); document.body.classList.add('modal-open'); };
    const closeLogin = ()=> { hide($('#auth-login')); document.body.classList.remove('modal-open'); };
    const closeRegister = ()=> { hide($('#auth-register')); document.body.classList.remove('modal-open'); };

    $('#btn-open-login').addEventListener('click', openLogin);
    $('#btn-open-register').addEventListener('click', openRegister);

    document.addEventListener('click', (e)=>{
      const el = e.target.closest('[data-close]');
      if(!el) return;
      const id = el.dataset.close;
      
      let modal;
      if (id === 'view') {
        modal = $('#event-view');
      } else if (id === 'follow-list') {
        modal = $('#follow-list-modal');
      } else {
        modal = $(`#${id}-modal`) || $(`#${id}`);
      }

      if(modal) {
        hide(modal);
        document.body.classList.remove('modal-open');
      }

      if(id === 'event') {
        Object.values(state.eventForm.uploadTasks).forEach(t => t.task.cancel());
        state.eventForm.uploadTasks = {};
      }
      if(id === 'org-event') {
        Object.values(state.orgEventForm.uploadTasks).forEach(t => t.task.cancel());
        state.orgEventForm.uploadTasks = {};
      }
      if(id==='view') { state.currentViewEvent = null; }
      if(id==='delete') { state.deleteTarget = null; }
      if(id==='remove-follower') { state.removeFollowerTarget = null; }
      if(id==='delete-notification') { state.deleteNotificationTarget = null; }
      if(id==='reset-ratings') { state.resetRatingsTarget = null; }
    });

    // ===== Login =====
    $('#form-login').addEventListener('submit', async (e)=>{
      e.preventDefault(); const email=$('#login-email').value.trim(); const pass=$('#login-pass').value; const btn=$('#submit-login'); const old=btn.textContent; btn.textContent='Entrando…'; btn.disabled=true; $('#err-login').classList.add('hidden');
      try{ 
        await setPersistence(auth, browserLocalPersistence);
        await signInWithEmailAndPassword(auth,email,pass); 
        closeLogin(); 
        toast('Login realizado!'); 
      }
      catch(err){ const b=$('#err-login'); b.textContent=mapAuthErr(err); b.classList.remove('hidden'); }
      finally{ btn.textContent=old; btn.disabled=false; }
    });

    // Recuperar senha
    $('#btn-forgot').addEventListener('click', async()=>{
      const email=$('#login-email').value.trim(); if(!email){ const b=$('#err-login'); b.textContent='Informe seu e-mail.'; b.classList.remove('hidden'); return; }
      try{ await sendPasswordResetEmail(auth,email); toast('Enviamos um e-mail para redefinir sua senha. Confira também a caixa de spam.', 'info'); }
      catch(err){ const b=$('#err-login'); b.textContent=mapAuthErr(err); b.classList.remove('hidden'); }
    });

    $('#reg-organizer-check').addEventListener('change', (e)=> $('#reg-organizer-form').classList.toggle('hidden', !e.target.checked) );

    // Registro
    $('#form-register').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name=$('#reg-name').value.trim();
      const usernameRaw = $('#reg-username').value.trim();
      const email=$('#reg-email').value.trim(); const pass=$('#reg-pass').value; const isOrg=$('#reg-organizer-check').checked;
      const btn=$('#submit-register'); const old=btn.textContent; btn.textContent='Registrando…'; btn.disabled=true;
      const errEl = $('#err-register'); hide(errEl);
      
      if (usernameRaw.includes(' ')) {
        errEl.textContent = 'Nome de usuário não pode conter espaços.'; show(errEl);
        btn.textContent=old; btn.disabled=false; return;
      }
      const username = usernameRaw.toLowerCase().replace(/[^a-z0-9_]/g, '');

      if (!username || !name || !email || pass.length < 6) {
        errEl.textContent = 'Preencha todos os campos corretamente.'; show(errEl);
        btn.textContent=old; btn.disabled=false; return;
      }

      try {
        await setPersistence(auth, browserLocalPersistence);
        const usernameRef = doc(db, USERNAMES_PATH, username);
        const usernameDoc = await getDoc(usernameRef);
        if (usernameDoc.exists()) {
          throw new Error(`Usuário @${username} já existe. Tente outro.`);
        }

        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, { displayName: name });

        const userData = {
          admin: false, organizer: false, name, username, email,
          photoUrl: null, createdAt: serverTimestamp(), bio: '',
          followersCount: 0, followingCount: 0, isPrivate: false,
          settings: { notifyOnFriendGoing: true }
        };
        await setDoc(doc(db, USERS_PATH, cred.user.uid), userData);
        await setDoc(usernameRef, { uid: cred.user.uid }); // Reserva o username

        if (isOrg) {
          const orgData={ uid:cred.user.uid, email, name, company:$('#org-company').value.trim()||null, cnpj:$('#org-cnpj').value.trim()||null, phone:$('#org-phone').value.trim()||null, website:$('#org-website').value.trim()||null, about:$('#org-about').value.trim()||null, status:'pending', createdAt:serverTimestamp() };
          await addDoc(collection(db, ORG_PATH), orgData);
          toast('Solicitação de organizador enviada! Aguarde aprovação.', 'info');
        } else {
          toast('Conta criada com sucesso!');
        }
        closeRegister();
      } catch(err) {
        errEl.textContent = err.message.includes('@') ? err.message : mapAuthErr(err);
        show(errEl);
      } finally {
        btn.textContent=old; btn.disabled=false;
      }
    });

    onAuthStateChanged(auth, (user)=>{
      const unsubAll = () => {
        if(_unsubRole) _unsubRole();
        if(_unsubGoingTo) _unsubGoingTo();
        if(_unsubFollowing) _unsubFollowing();
        if(_unsubFollowers) _unsubFollowers();
        if(_unsubOutgoingRequests) _unsubOutgoingRequests();
        if(_unsubIncomingRequests) _unsubIncomingRequests();
        if(_unsubNotifications) _unsubNotifications();
        _unsubRole = _unsubGoingTo = _unsubFollowing = _unsubFollowers = _unsubOutgoingRequests = _unsubIncomingRequests = _unsubNotifications = null;
      };
      unsubAll();
      
      state.isAdmin=false; state.isOrganizer=false; state.currentUserData=null; state.userGoingTo.clear(); state.userFollowing.clear(); state.userFollowers.clear(); state.userOutgoingRequests.clear(); state.incomingFollowRequests.clear();

      if (user && !user.isAnonymous) {
        _unsubRole = onSnapshot(doc(db, USERS_PATH, user.uid), (d)=>{
          const u=d.data()||{};
          state.isAdmin=!!u.admin;
          state.isOrganizer=!!u.organizer;
          state.currentUserData = u;
          renderHeader();
          if(!state.isAdmin) hide($('#view-admin'));
        if(!state.isOrganizer) hide($('#view-organizer'));
        }, ()=>{ state.isAdmin=false; state.isOrganizer=false; renderHeader(); hide($('#view-admin')); hide($('#view-organizer')); });

        const goingToRef = collection(db, `artifacts/${appId}/users/${user.uid}/goingTo`);
        _unsubGoingTo = onSnapshot(goingToRef, (snap) => {
          state.userGoingTo.clear();
          snap.forEach(doc => state.userGoingTo.add(doc.id));
          updateGoingButtonUI();
          updateFriendsGoingMap();
        });

        const followingRef = collection(db, `artifacts/${appId}/users/${user.uid}/following`);
        _unsubFollowing = onSnapshot(followingRef, (snap) => {
            state.userFollowing.clear();
            snap.forEach(doc => state.userFollowing.add(doc.id));
            renderSocialFeeds();
            updateFriendsGoingMap();
            if (state.notifications) renderNotifications(state.notifications);
        });

        const followersRef = collection(db, `artifacts/${appId}/users/${user.uid}/followers`);
        _unsubFollowers = onSnapshot(followersRef, (snap) => {
            state.userFollowers.clear();
            snap.forEach(doc => state.userFollowers.add(doc.id));
        });
        
        const outgoingRequestsRef = collection(db, `artifacts/${appId}/users/${user.uid}/outgoingFollowRequests`);
        _unsubOutgoingRequests = onSnapshot(outgoingRequestsRef, (snap) => {
            state.userOutgoingRequests.clear();
            snap.forEach(doc => state.userOutgoingRequests.add(doc.id));
            if (state.notifications) renderNotifications(state.notifications);
        });

        const incomingRequestsRef = collection(db, `artifacts/${appId}/users/${user.uid}/followRequests`);
        _unsubIncomingRequests = onSnapshot(incomingRequestsRef, (snap) => {
            state.incomingFollowRequests.clear();
            snap.forEach(doc => state.incomingFollowRequests.add(doc.id));
        });

        const notificationsRef = query(collection(db, `artifacts/${appId}/users/${user.uid}/notifications`), orderBy('timestamp', 'desc'), limit(20));
        _unsubNotifications = onSnapshot(notificationsRef, (snap) => {
            state.notifications = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderNotifications(state.notifications);
        });
      } else {
        if (!user) {
          signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
        }
        renderHeader();
      }
    });

    $('#btn-user').addEventListener('click', (e)=>{ e.stopPropagation(); $('#user-menu').classList.toggle('hidden'); });
    document.addEventListener('click', ()=> $('#user-menu').classList.add('hidden'));
    $('#btn-logout').addEventListener('click', async()=>{ await signOut(auth); toast('Você saiu da sua conta.'); hide($('#view-admin')); hide($('#view-organizer')); });

    // ===== Navegação =====
    const allViews = ['#home-view', '#view-admin', '#view-organizer', '#view-social', '#hero-section', '#view-profile', '#view-about', '#view-locations'];
    
    function updateHeaderStyles(activeViewId) {
        const buttons = {
            home: { el: $('#btn-home-header'), view: '#home-view', default: 'bg-white', active: 'bg-gray-100' },
            about: { el: $('#btn-about-header'), view: '#view-about', default: 'bg-gray-100', active: 'bg-gray-200' },
            social: { el: $('#btn-social-header'), view: '#view-social', default: 'bg-pink-600/5', active: 'bg-pink-600/10' }
        };

        const currentView = (activeViewId === '#hero-section') ? '#home-view' : activeViewId;

        Object.values(buttons).forEach(btn => {
            btn.el.classList.remove(btn.active);
            btn.el.classList.add(btn.default);
        });

        const activeButton = Object.values(buttons).find(btn => btn.view === currentView);
        if (activeButton) {
            activeButton.el.classList.remove(activeButton.default);
            activeButton.el.classList.add(activeButton.active);
        }
    }

    async function showView(viewId) {
      allViews.forEach(v => hide($(v)));
      show($(viewId));
      if (viewId === '#home-view') show($('#hero-section'));
      if (viewId === '#view-locations') await renderLocationsPage();
      window.scrollTo(0, 0);
      updateHeaderStyles(viewId); 
    }
    $('#btn-home-header').addEventListener('click', () => showView('#home-view'));
    $('#btn-about-header').addEventListener('click', () => showView('#view-about'));
    $('#btn-locations-view').addEventListener('click', () => showView('#view-locations'));
    $('#btn-social-header').addEventListener('click', () => {
      if (auth.currentUser && !auth.currentUser.isAnonymous) {
        openSocialView();
      } else {
        openLogin();
      }
    });
    $('#go-profile').addEventListener('click', () => {
        if (auth.currentUser && !auth.currentUser.isAnonymous) {
            openProfileView();
        } else {
            openLogin();
        }
    });
    $('#go-admin').addEventListener('click', ()=>{ 
        if(!ensureAdmin()) return; 
        showView('#view-admin'); 
        refreshAllAdminViews(); 
    });
    
    $('#go-organizer').addEventListener('click', ()=>{ 
        if(!auth.currentUser || auth.currentUser.isAnonymous) return openLogin();
        if(!state.isOrganizer) { toast('Apenas organizadores aprovados podem acessar esta área.', 'error'); return; }
        showView('#view-organizer'); 
        refreshOrganizerViews(); 
    });
    
    function openSocialView() {
        if (!state.currentUserData) return;
        $('#account-notify-check').checked = state.currentUserData.settings?.notifyOnFriendGoing ?? true;
        showView('#view-social');
        renderSocialFeeds();
    }
    
    // ===== Meu Perfil: Eventos confirmados (próximos e passados) =====
    async function renderMyProfileEventSections() {
      const upcomingEl = $('#my-upcoming-events');
      const pastEl = $('#my-past-events');
      if (!upcomingEl || !pastEl) return;
      const user = auth.currentUser;
      if (!user) {
        upcomingEl.innerHTML = '<p class="text-xs text-gray-500">Entre para ver seus eventos.</p>';
        pastEl.innerHTML = '';
        return;
      }
      upcomingEl.innerHTML = '<div class="text-gray-500 text-xs">Carregando...</div>';
      pastEl.innerHTML = '';

      let confirmedIds = null;
      if (state.userGoingTo && state.userGoingTo.size >= 0) {
        confirmedIds = new Set(state.userGoingTo);
      }
      if (!confirmedIds) {
        try {
          const snap = await getDocs(collection(db, `artifacts/${appId}/users/${user.uid}/goingTo`));
          confirmedIds = new Set(snap.docs.map(d => d.id));
        } catch (e) { confirmedIds = new Set(); }
      }

      const list = (state.events || []).filter(ev => {
        const baseId = ev._original_id || ev._id;
        return confirmedIds.has(baseId);
      });

      const getDate = (ev) => (ev.date?.toDate ? ev.date.toDate() : new Date(ev.date || Date.now()));
      const upcoming = list.filter(isEventActive).sort((a,b) => getDate(a) - getDate(b));
      const past = list.filter(ev => !isEventActive(ev)).sort((a,b) => getDate(b) - getDate(a));

      const renderItem = (ev) => {
        const url = ev.imageUrls?.[0] || '';
        return `
          <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 cursor-pointer" data-open-event="${ev._id}">
            <img src="${url}" onerror="this.src='https://placehold.co/48x48/f9a8d4/ffffff?text=RF'" class="h-10 w-12 rounded-lg object-cover ring-subtle"/>
            <div class="min-w-0">
              <div class="font-medium text-sm truncate">${ev.name || ''}</div>
              <div class="text-[11px] text-gray-600 truncate">${fmtDate(ev.date)} • ${ev.local || ''}</div>
            </div>
          </div>`;
      };

      upcomingEl.innerHTML = upcoming.length ? upcoming.map(renderItem).join('') : '<p class="text-xs text-gray-500">Você ainda não confirmou nenhum evento futuro.</p>';
      pastEl.innerHTML = past.length ? past.map(renderItem).join('') : '<p class="text-xs text-gray-500">Nada por aqui ainda.</p>';

      $$('#my-upcoming-events [data-open-event], #my-past-events [data-open-event]').forEach(el => {
        const id = el.getAttribute('data-open-event');
        el.addEventListener('click', () => {
          const ev = (state.events || []).find(e => e._id === id);
          if (ev) openViewModal(ev);
        });
      });
    }

    function openProfileView() {
        if (!state.currentUserData) return;
        const u = state.currentUserData;
        $('#account-name').value = u.name || '';
        $('#account-username').value = u.username || '';
        $('#account-bio').value = u.bio || '';
        $('#account-private').checked = u.isPrivate || false;
        $('#account-photo-preview').src = u.photoUrl || `https://placehold.co/64x64/f472b6/ffffff?text=${initials(u.name)}`;
        state.newProfilePhotoUrl = null;
        state.photoRemovalFlag = false; // Reset flag
        showView('#view-profile');
        loadFollowLists();
        renderMyProfileEventSections();
    }

    // ===== Realtime: eventos e usuários =====
    function subEvents(){
      if(_unsubEvents) _unsubEvents();
      _unsubEvents = onSnapshot(collection(db, EVENTS_PATH), (snap)=>{
        state.baseEvents = snap.docs.map(d=>({ _id: d.id, _ref: d.ref, _path: d.ref.path, ...d.data() }));
        processAndRenderAllViews();
        
        // Re-renderiza a página de locais se estiver ativa
        if (document.getElementById('view-locations') && !document.getElementById('view-locations').classList.contains('hidden')) {
          renderLocationsPage();
        }
      }, (err)=>{ console.error(err); toast('Erro ao carregar eventos.', 'error'); });
    }
    subEvents();
    
    function subEventExceptions() {
        if (_unsubExceptions) _unsubExceptions();
        _unsubExceptions = onSnapshot(collection(db, EVENT_EXCEPTIONS_PATH), (snap) => {
            const exceptions = {};
            snap.forEach(doc => {
                const data = doc.data();
                if (!exceptions[data.eventId]) {
                    exceptions[data.eventId] = [];
                }
                const d = data.deletedDate.toDate();
                d.setHours(0,0,0,0);
                exceptions[data.eventId].push(d.getTime());
            });
            state.eventExceptions = exceptions;
            processAndRenderAllViews();
        });
    }
    subEventExceptions();

    function getFirstUpcomingDate(startDate) {
        const now = new Date();
        now.setHours(0, 0, 0, 0); 
        const eventDate = startDate.toDate();
        eventDate.setHours(0, 0, 0, 0);

        if (eventDate >= now) {
            return eventDate;
        }

        const eventDayOfWeek = eventDate.getDay();
        const todayDayOfWeek = now.getDay();
        
        let daysToAdd = eventDayOfWeek - todayDayOfWeek;
        if (daysToAdd < 0) {
            daysToAdd += 7; 
        }

        const nextOccurrence = new Date(now);
        nextOccurrence.setDate(now.getDate() + daysToAdd);
        return nextOccurrence;
    }

    function processAndRenderAllViews() {
        const expandedEvents = [];
        
        (state.baseEvents || []).forEach(event => {
            if (event.repeatsWeekly) {
                const displayCount = event.displayCount || 1; // CORREÇÃO: Padrão para 1
                const baseStartDate = event.date;
                if (!baseStartDate) return;

                const firstUpcoming = getFirstUpcomingDate(baseStartDate);
                const exceptions = state.eventExceptions[event._id] || [];
                
                let generatedCount = 0;
                let weekOffset = 0;
                while (generatedCount < displayCount) {
                    const currentDate = new Date(firstUpcoming);
                    currentDate.setDate(firstUpcoming.getDate() + (weekOffset * 7));
                    
                    const currentDateStart = new Date(currentDate);
                    currentDateStart.setHours(0,0,0,0);

                    if (!exceptions.includes(currentDateStart.getTime())) {
                        const clone = { ...event };
                        clone.date = Timestamp.fromDate(currentDate);
                        clone._original_id = event._id;
                        clone._path = event._path;
                        clone._id = `${event._id}_${currentDate.getTime()}`; 
                        clone.isGenerated = true;
                        
                        expandedEvents.push(clone);
                        generatedCount++;
                    }
                    weekOffset++;
                }
            } else {
                expandedEvents.push(event);
            }
        });

        state.events = expandedEvents;
        
        // CORREÇÃO: Aplica filtros e renderiza tudo
        applyFiltersAndRender().catch(console.error);
    }


    function subPending(){
      if(_unsubPending) _unsubPending();
      _unsubPending = onSnapshot(collection(db, PENDING_PATH), (snap)=>{
        state.pending = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderPending();
      }, ()=>{});
    }
    subPending();
    
    function subRecurringEvents() {
        if (_unsubRecurring) _unsubRecurring();
        _unsubRecurring = onSnapshot(collection(db, RECURRING_EVENTS_PATH), (snap) => {
            state.recurringEvents = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderRecurringEventsAdmin();
            populateRecurringEventsDropdown();
            
            // Re-renderiza a página de locais se estiver ativa
            if (document.getElementById('view-locations') && !document.getElementById('view-locations').classList.contains('hidden')) {
                renderLocationsPage();
            }
        });
    }
    subRecurringEvents();

    function subSettings() {
      if (_unsubSettings) _unsubSettings();
      _unsubSettings = onSnapshot(doc(db, SETTINGS_PATH, 'global'), (doc) => {
        if (doc.exists()) {
          state.settings = doc.data();
          $('#whatsapp-support-link').href = state.settings.whatsappLink || 'https://wa.me/5521000000000';
          $('#whatsapp-link-input').value = state.settings.whatsappLink || '';
        }
      });
    }
    subSettings();

    onSnapshot(collection(db, USERS_PATH), (snap) => {
        const newUsers = {};
        snap.forEach(d => {
            newUsers[d.id] = { id: d.id, ...d.data() };
        });
        state.users = newUsers;
    });

    // ===== Admin gate =====
    function ensureAdmin(){ if(!auth.currentUser || auth.currentUser.isAnonymous){ openLogin(); toast('Faça login para acessar o Admin.', 'error'); return false } if(!state.isAdmin){ toast('Sua conta não possui acesso de administrador.', 'error'); return false } return true; }
    $('#btn-new-event').addEventListener('click', ()=>{ if(!ensureAdmin()) return; openEventModal('create') });
    $('#btn-new-org-event').addEventListener('click', ()=>{ if(!auth.currentUser || auth.currentUser.isAnonymous) return openLogin(); if(!state.isOrganizer) { toast('Apenas organizadores aprovados podem criar eventos.', 'error'); return; } openEventModal('org-create') });

    // ===== Organizador =====

    $('#org-event-form').addEventListener('submit', async (e)=>{
      e.preventDefault(); if(!auth.currentUser || auth.currentUser.isAnonymous){ openLogin(); return }
      if(!state.isOrganizer){ toast('Apenas organizadores aprovados podem enviar eventos.', 'error'); return }
      
      const formState = state.orgEventForm;
      if (Object.values(formState.uploadTasks).some(t => t.status === 'running')) {
        return showOrgEventError('Aguarde o fim de todos os uploads.');
      }

      const name=$('#org-ev-name').value.trim(); const dateS=$('#org-ev-date').value; const local=$('#org-ev-local').value.trim();
      if(!name||!dateS||!local) return showOrgEventError('Preencha nome, data e local.');
      if(formState.imageUrls.length===0) return showOrgEventError('Adicione pelo menos uma foto.');
      
      try{
        const when=parseDateInput(dateS); 
        const generoSel = document.getElementById('org-ev-genero');
const generoIds = generoSel ? Array.from(generoSel.selectedOptions).map(o=>o.value).filter(Boolean) : [];
const generoNames = generoIds.map(id => state.generos.find(g=>g.id===id)?.name).filter(Boolean);
        const payload={ 
            name, local, description:$('#org-ev-desc').value.trim(), 
            styles: generoNames, style: (generoNames[0] || null),
            buyLink:$('#org-ev-buy').value.trim(), 
            coupon:$('#org-ev-coupon').value.trim(), 
            imageUrls: formState.imageUrls, 
            date: Timestamp.fromDate(when), 
            timeStart: $('#org-ev-time-start').value||null, 
            timeEnd: $('#org-ev-time-end').value||null, 
            createdBy: auth.currentUser.uid, 
            createdAt: serverTimestamp(), 
            status:'pending', 
            isPrivate: $('#org-ev-private').checked,
            recurringEventId: $('#org-ev-recurring').value || null,
            bairroId: (document.getElementById('org-ev-bairro')?.value || null), 
            generoIds: generoIds, generoId: (generoIds[0] || null), 
            bairroName: (state.bairros.find(b=>b.id===document.getElementById('org-ev-bairro')?.value)?.name || null), 
            generoNames: generoNames, 
            repeatsWeekly: $('#org-ev-repeats-weekly').checked,
            displayCount: parseInt($('#org-ev-display-count').value, 10) || 1
        };
        await addDoc(collection(db, PENDING_PATH), payload); hide($('#org-event-modal')); toast('Evento enviado para aprovação!', 'info');
      }catch(err){ console.error(err); showOrgEventError('Falha ao enviar evento.'); }
    });
    function showOrgEventError(m){ const b=$('#org-event-error'); b.textContent=m; b.classList.remove('hidden'); }

    // ===== Gestão de admins =====
    async function findUserByEmail(email){ const qRef=query(collection(db, USERS_PATH), where('email','==',email)); const snap=await getDocs(qRef); return snap.docs.map(d=>({id:d.id, ...d.data()})); }
    async function refreshAdminsList(){ const ul=$('#admins-list'); ul.innerHTML=''; const qRef=query(collection(db, USERS_PATH), where('admin','==', true)); const snap=await getDocs(qRef); if(snap.empty){ ul.innerHTML='<li class="text-gray-500">Nenhum admin definido.</li>'; return } snap.forEach(docu=>{ const u={ id:docu.id, ...docu.data() }; const li=document.createElement('li'); li.className='flex items-center justify-between rounded-xl border border-gray-200 px-3 py-2'; li.innerHTML=`<div class='flex items-center gap-2'><span class='inline-grid h-7 w-7 place-items-center rounded-full bg-pink-600 text-white text-xs font-bold'>${initials(u.name||u.email||'U')}</span><div><div class='font-medium text-sm'>${u.name||'—'}</div><div class='text-xs text-gray-500'>${u.email||''}</div></div></div><button class='text-red-600 text-sm font-semibold' data-remove='${u.id}'>Remover</button>`; li.querySelector('[data-remove]').addEventListener('click', async()=>{ if(!ensureAdmin()) return; await setDoc(doc(db, USERS_PATH, u.id), {admin:false}, {merge:true}); toast('Admin removido.'); refreshAdminsList(); }); ul.appendChild(li); }); }
    $('#btn-grant-admin').addEventListener('click', async()=>{ if(!ensureAdmin()) return; const email=$('#role-email').value.trim(); const err=$('#role-error'); err.classList.add('hidden'); try{ if(!email) throw new Error('Informe o e-mail.'); const users=await findUserByEmail(email); if(!users.length) throw new Error('Usuário não encontrado.'); await setDoc(doc(db, USERS_PATH, users[0].id), { admin:true }, { merge:true }); toast('Admin concedido.'); refreshAdminsList(); }catch(e){ err.textContent=e.message||'Falha ao conceder.'; err.classList.remove('hidden'); } });
    $('#btn-revoke-admin').addEventListener('click', async()=>{ if(!ensureAdmin()) return; const email=$('#role-email').value.trim(); const err=$('#role-error'); err.classList.add('hidden'); try{ if(!email) throw new Error('Informe o e-mail.'); const users=await findUserByEmail(email); if(!users.length) throw new Error('Usuário não encontrado.'); await setDoc(doc(db, USERS_PATH, users[0].id), { admin:false }, { merge:true }); toast('Admin removido.'); refreshAdminsList(); }catch(e){ err.textContent=e.message||'Falha ao remover.'; err.classList.remove('hidden'); } });

    // ===== Solicitações de organizador (admin) =====
    function openOrganizerDetailsModal(orgData) {
      const content = $('#organizer-details-content');
      content.innerHTML = `
        <p><strong>Empresa:</strong> ${orgData.company || 'Não informado'}</p>
        <p><strong>Nome:</strong> ${orgData.name || 'Não informado'}</p>
        <p><strong>Email:</strong> ${orgData.email || 'Não informado'}</p>
        <p><strong>CNPJ:</strong> ${orgData.cnpj || 'Não informado'}</p>
        <p><strong>Telefone:</strong> ${orgData.phone || 'Não informado'}</p>
        <p><strong>Site/Social:</strong> ${orgData.website ? `<a href="${orgData.website}" target="_blank" class="text-pink-600 hover:underline">${orgData.website}</a>` : 'Não informado'}</p>
        <p><strong>Sobre:</strong> ${orgData.about || 'Não informado'}</p>
      `;
      show($('#organizer-details-modal'));
    }

    async function renderOrgRequests(){
      const wrap=$('#org-requests'); wrap.innerHTML='';
      const qSnap=await getDocs(query(collection(db, ORG_PATH), where('status','==','pending')));
      if(qSnap.empty){ wrap.innerHTML='<div class="py-3 text-sm text-gray-500">Sem solicitações pendentes.</div>'; return }
      qSnap.forEach(d=>{
        const r={id:d.id,...d.data()};
        const el=document.createElement('div');
        el.className='py-3 flex items-start justify-between gap-3';
        el.innerHTML=`
          <div>
            <div class='font-medium'>${r.company||r.name||r.email}</div>
            <div class='text-xs text-gray-500'>${r.email}</div>
          </div>
          <div class='flex items-center flex-shrink-0 gap-2'>
            <button class='rounded-full border border-gray-200 px-3 py-1.5 text-xs' data-details>Ver mais</button>
            <button class='rounded-full bg-emerald-600 px-3 py-1.5 text-xs font-semibold text-white' data-approve>Aprovar</button>
            <button class='rounded-full bg-red-600 px-3 py-1.5 text-xs font-semibold text-white' data-reject>Recusar</button>
          </div>`;
        el.querySelector('[data-details]').addEventListener('click', () => openOrganizerDetailsModal(r));
        el.querySelector('[data-approve]').addEventListener('click', async()=>{ if(!ensureAdmin()) return; await setDoc(doc(db, ORG_PATH, r.id), {status:'approved', approvedAt:serverTimestamp()}, {merge:true}); await setDoc(doc(db, USERS_PATH, r.uid), {organizer:true}, {merge:true}); toast('Organizador aprovado.'); renderOrgRequests(); renderApprovedOrganizers(); });
        el.querySelector('[data-reject]').addEventListener('click', async()=>{ if(!ensureAdmin()) return; await setDoc(doc(db, ORG_PATH, r.id), {status:'rejected', rejectedAt:serverTimestamp()}, {merge:true}); toast('Solicitação recusada.'); renderOrgRequests(); });
        wrap.appendChild(el);
      });
    }

    async function renderApprovedOrganizers() {
      const listEl = $('#approved-organizers-list');
      listEl.innerHTML = '';
      const qSnap = await getDocs(query(collection(db, ORG_PATH), where('status', '==', 'approved')));
      if (qSnap.empty) {
        listEl.innerHTML = '<div class="py-3 text-sm text-gray-500">Nenhum organizador aprovado.</div>';
        return;
      }
      qSnap.forEach(d => {
        const org = { id: d.id, ...d.data() };
        const el = document.createElement('div');
        el.className = 'py-3 flex items-center justify-between gap-3';
        el.innerHTML = `
          <div>
            <div class="font-medium">${org.company || org.name}</div>
            <div class="text-xs text-gray-500">${org.email}</div>
          </div>
          <button class="rounded-full bg-red-600 px-3 py-1.5 text-xs font-semibold text-white" data-remove>Remover</button>`;
        el.querySelector('[data-remove]').addEventListener('click', async () => {
          if (!ensureAdmin()) return;
          await updateDoc(doc(db, ORG_PATH, org.id), { status: 'revoked' });
          await updateDoc(doc(db, USERS_PATH, org.uid), { organizer: false });
          toast('Organizador removido.');
          renderApprovedOrganizers();
        });
        listEl.appendChild(el);
      });
    }

    // ===== Eventos pendentes (admin) =====
    let _approveTarget=null;
    function renderPending(){ const wrap=$('#pending-events'); wrap.innerHTML=''; if(!state.pending.length){ wrap.innerHTML='<div class="text-sm text-gray-500">Nenhum evento pendente.</div>'; return } state.pending.forEach(ev=>{ const card=document.createElement('div'); card.className='rounded-2xl border border-gray-200 p-3 flex items-start gap-3'; const cover=ev.imageUrls?.[0]||''; card.innerHTML=`<img src='${cover}' class='h-16 w-20 rounded-lg object-cover ring-subtle'/><div class='flex-1'><div class='font-medium'>${ev.name||''}</div><div class='text-xs text-gray-500'>${fmtDate(ev.date)} • ${ev.local||''}</div><div class='text-xs text-gray-500'>Enviado por ${ev.createdBy||'—'}</div></div><div class='flex gap-3'><button class='rounded-full border border-gray-200 px-3 py-1.5 text-xs' data-edit='${ev.id}'>Editar</button><button class='rounded-full bg-emerald-600 px-3 py-1.5 text-xs font-semibold text-white' data-approve='${ev.id}'>Aprovar</button><button class='rounded-full bg-red-600 px-3 py-1.5 text-xs font-semibold text-white' data-reject='${ev.id}'>Recusar</button></div>`; card.querySelector(`[data-edit='${ev.id}']`).addEventListener('click',()=>{ if(!ensureAdmin()) return; openEventModal('edit-pending', ev); }); card.querySelector(`[data-approve='${ev.id}']`).addEventListener('click',()=>{ if(!ensureAdmin()) return; _approveTarget=ev; $('#approve-importance').value=5; $('#approve-importance-value').textContent='5'; show($('#approve-modal')); }); card.querySelector(`[data-reject='${ev.id}']`).addEventListener('click', async()=>{ if(!ensureAdmin()) return; await deleteDoc(doc(db, PENDING_PATH, ev.id)); toast('Evento recusado.'); }); wrap.appendChild(card); }); }

    $('#approve-importance').addEventListener('input', e=> $('#approve-importance-value').textContent=e.target.value );
    $('#approve-confirm').addEventListener('click', async()=>{ if(!_approveTarget) return; try{ const imp=Number($('#approve-importance').value)||0; const payload={ ..._approveTarget, importance:imp, status:'approved', approvedAt:serverTimestamp() }; delete payload.id; await addDoc(collection(db, EVENTS_PATH), payload); await deleteDoc(doc(db, PENDING_PATH, _approveTarget.id)); hide($('#approve-modal')); toast('Evento aprovado!'); }catch(e){ console.error(e); toast('Falha ao aprovar.', 'error') } finally{ _approveTarget=null; }
    });

    // ===== Render helpers =====
    function isEventActive(ev){ 
      try {
        const now = new Date();
        const startDate = ev.date?.toDate ? ev.date.toDate() : new Date();
        
        if (!ev.timeEnd) {
          const endDateForLogic = ev.endDate?.toDate ? ev.endDate.toDate() : startDate;
          endDateForLogic.setHours(23, 59, 59, 999);
          return now <= endDateForLogic;
        }

        const endDatePart = ev.endDate?.toDate ? ev.endDate.toDate() : startDate;
        const [endHours, endMinutes] = ev.timeEnd.split(':').map(Number);
        
        const exactEndDate = new Date(endDatePart);
        exactEndDate.setHours(endHours, endMinutes, 0, 0);

        return now <= exactEndDate;
      } catch {
        return true; 
      }
    }

    async function eventCard(ev){
        const url=ev.imageUrls?.[0]||'';
        const el=document.createElement('article');
        const isToday = isEventToday(ev);
        el.className=`group w-[150px] md:w-[280px] shrink-0 snap-start rounded-3xl overflow-hidden bg-white shadow-soft ring-subtle hover:shadow-xl transition cursor-pointer ${isToday ? 'ring-2 ring-orange-500/30 today-event' : ''}`;
        
        const friendsGoingCount = state.friendsGoingMap.get(ev._original_id || ev._id)?.size || 0;
        const friendsGoingHTML = friendsGoingCount > 0 
            ? `<div class="absolute top-3 left-3 flex items-center gap-1.5 rounded-full bg-black/50 px-2 py-0.5 text-[10px] md:py-1 md:text-xs font-medium text-white backdrop-blur-sm">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                <span>${friendsGoingCount} amigo${friendsGoingCount > 1 ? 's' : ''} ${friendsGoingCount > 1 ? 'vão' : 'vai'}</span>
               </div>` 
            : '';

        // Verifica se é evento privado
        const isPrivate = ev.isPrivate || false;
        
        // Verifica se o usuário tem acesso ao evento privado
        let hasAccess = false;
        if (isPrivate && auth.currentUser && !auth.currentUser.isAnonymous) {
            try {
                hasAccess = await checkPrivateEventAccess(ev._original_id || ev._id);
            } catch (err) {
                console.error('Erro ao verificar acesso:', err);
                hasAccess = false;
            }
        }

        el.innerHTML=`
          <div class="relative h-28 md:h-44 w-full bg-gray-100 overflow-hidden">
            <img class="h-full w-full object-cover group-hover:scale-[1.02] transition" src="${url}" alt="${ev.name||''}" loading="lazy" decoding="async" />
            ${friendsGoingHTML}
            ${isPrivate && !hasAccess ? `<div class="absolute top-3 right-3 flex items-center gap-1 rounded-full bg-purple-600/90 px-2 py-0.5 text-[10px] md:py-1 md:text-xs font-medium text-white backdrop-blur-sm">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 15v2m-6 4h12a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2zm10-10V7a4 4 0 0 0-8 0v4h8z"/></svg>
                Privado
            </div>` : ''}
            ${isEventToday(ev) ? `<div class="absolute top-3 left-3 flex items-center gap-1 rounded-full bg-orange-500/90 px-2 py-0.5 text-[10px] md:py-1 md:text-xs font-medium text-white backdrop-blur-sm today-badge">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Hoje
            </div>` : ''}
          </div>
          <div class="p-3 md:p-5 space-y-1.5">
            <h3 class="text-sm md:text-lg font-semibold break-words">${ev.name||''}</h3>
            ${isPrivate && !hasAccess ? `<div class="text-[11px] md:text-sm text-gray-500">Evento privado</div>` : 
            `<div class="text-[11px] md:text-sm text-gray-600">${fmtDate(ev.date)}</div>
            ${(ev.local || ev.bairroName || ev.address || ev.location || ev.venue) ? `<div class="text-[11px] md:text-sm text-gray-600 line-clamp-1">${ev.local || ev.bairroName || ev.address || ev.location || ev.venue}</div>` : ''}
            ${(Array.isArray(ev.styles) ? ev.styles : (ev.style ? [ev.style] : [])).map(s=>`<div class="inline-flex items-center rounded-full border border-pink-600/30 bg-pink-600/5 px-3 py-0.5 text-[10px] md:py-1 md:text-xs font-medium text-pink-600">${s}</div>`).join('')}`}
          </div>`;
        el.addEventListener('click',()=>openViewModal(ev));
        return el;
    }

    async function renderCarousel(containerId, list, emptyId){ 
        const wrap=$('#'+containerId); 
        const emptyEl=$('#'+emptyId); 
        wrap.innerHTML=''; 
        if(!list || !list.length){ 
            show(emptyEl); 
            hide(wrap); 
            return 
        } else { 
            hide(emptyEl); 
            show(wrap); 
        } 
        
        // Create all cards first for better performance
        const cards = [];
        for (let idx = 0; idx < list.length; idx++) {
            const ev = list[idx];
            const card = await eventCard(ev);
            const img = card.querySelector && card.querySelector('img');
            if (img) {
                img.setAttribute('decoding','async');
                // Optimize loading strategy
                if (idx < 3) { 
                    img.setAttribute('loading','eager'); 
                    img.setAttribute('fetchpriority','high'); 
                    // Preload critical images
                    if (idx === 0 && ev.imageUrls?.[0]) {
                        const link = document.createElement('link');
                        link.rel = 'preload';
                        link.as = 'image';
                        link.href = ev.imageUrls[0];
                        document.head.appendChild(link);
                    }
                } else { 
                    img.setAttribute('loading','lazy'); 
                    img.removeAttribute('fetchpriority'); 
                }
                // Add error handling with optimized fallback
                img.onerror = function() {
                    this.src = 'https://placehold.co/280x176/f9a8d4/ffffff?text=RioFestas';
                    this.onerror = null; // Prevent infinite loop
                };
            }
            cards.push(card);
        }
        
        // Batch append for better performance
        const fragment = document.createDocumentFragment();
        cards.forEach(card => fragment.appendChild(card));
        wrap.appendChild(fragment);
    }

    function buildNext7Menu(){ const menu=$('#weekday-menu'); menu.innerHTML=''; const today=startOfToday(); const labels=[]; for(let i=0;i<7;i++){ const d=new Date(today); d.setDate(today.getDate()+i); labels.push({date:d,label:weekdayLong[d.getDay()]}); } labels.forEach((it,idx)=>{ const b=document.createElement('button'); b.className='flex-shrink-0 rounded-full border px-4 py-2 text-sm '+(idx===state.byDayOffset? 'bg-pink-600 text-white border-pink-600':'bg-white border-gray-200 hover:bg-gray-50'); b.textContent=it.label; b.addEventListener('click', ()=>{ state.byDayOffset=idx; applyFiltersAndRender().catch(console.error); }); menu.appendChild(b); }); }

    async function renderAllHome(filteredEvents){
      
      // Query-aware: hide hero sections when searching
      try {
        const qEl = document.getElementById('search-input');
        const q = (qEl && qEl.value ? qEl.value : '').trim();
        const secIds = ['carousel-today-highlights','carousel-week-top','carousel-popular','carousel-byday','carousel-others'];
        const secs = secIds.map(id => document.getElementById(id)?.closest('section')).filter(Boolean);
        const resultsSection = document.getElementById('search-results-section');
        if (q) {
          secs.forEach(sec => sec && sec.classList.add('hidden'));
          resultsSection && resultsSection.classList.remove('hidden');
        } else {
          secs.forEach(sec => sec && sec.classList.remove('hidden'));
        }
      } catch(e) {}

      // Ensure results render & skip carousels when searching
      try {
        const qEl = document.getElementById('search-input');
        const q = (qEl && qEl.value ? qEl.value : '').trim();
        const secIds = ['carousel-today-highlights','carousel-week-top','carousel-popular','carousel-byday','carousel-others'];
        const secs = secIds.map(id => document.getElementById(id)?.closest('section')).filter(Boolean);
        const resultsSection = document.getElementById('search-results-section');
        if (q) {
          secs.forEach(sec => sec && sec.classList.add('hidden'));
          resultsSection && resultsSection.classList.remove('hidden');
          renderFeed(filteredEvents);
          return;
        } else {
          secs.forEach(sec => sec && sec.classList.remove('hidden'));
        }
      } catch(e) {}
      
      const activeEvents = filteredEvents.filter(isEventActive);
      const evs=[...activeEvents].sort((a,b)=>(b.importance||0)-(a.importance||0));
      const start=startOfToday(); const end=next7End();
      
      // Eventos de hoje (apenas o dia atual)
      const todayEvents = evs.filter(isEventToday);
      
      // Mostrar seção "Destaques de Hoje" apenas se houver eventos hoje
      const todaySection = document.getElementById('today-highlights-section');
      if (todayEvents.length > 0) {
        todaySection.classList.remove('hidden');
        await renderCarousel('carousel-today-highlights', todayEvents, 'empty-today-highlights');
      } else {
        todaySection.classList.add('hidden');
      }
      
      const inNext7 = evs.filter(ev=>{ const d=ev.date?.toDate?ev.date.toDate():new Date(ev.date); return d>=start && d<=end; });
      const others=evs.filter(ev=>{ const d=ev.date?.toDate?ev.date.toDate():new Date(ev.date); return !(d>=start && d<=end); });
      // CORREÇÃO: Filtra populares por goingCount > 0
      const popular = [...activeEvents].filter(ev => ev.goingCount > 0).sort((a, b) => (b.goingCount || 0) - (a.goingCount || 0)).slice(0, 10);
      
      await renderCarousel('carousel-week-top', inNext7, 'empty-week-top');
      await renderCarousel('carousel-popular', popular, 'empty-popular');
      renderByDay(activeEvents);
      await renderCarousel('carousel-others', others, 'empty-others');
      renderFeed(activeEvents);
    }

    function renderByDay(filteredEvents){ 
        buildNext7Menu();
        const start=startOfToday(); 
        const target=new Date(start); 
        target.setDate(start.getDate()+state.byDayOffset); 
        const a=new Date(target); a.setHours(0,0,0,0); 
        const b=new Date(target); b.setHours(23,59,59,999); 
        const list=filteredEvents.filter(ev=>{ const d=ev.date?.toDate?ev.date.toDate():new Date(ev.date); return d>=a && d<=b; }); 
        renderCarousel('carousel-byday', list, 'empty-byday'); 
    }

    function renderFeed(filteredEvents){ 
        const grid=$('#grid-events'); 
        const empty=$('#empty-feed');
        const section = $('#search-results-section');
        grid.innerHTML=''; 
        const q=$('#search-input').value.trim().toLowerCase(); 
        if (!q) { hide(section); return; } 
        show(section); 
        const list=filteredEvents.filter(ev=> ([ev.name,ev.style,ev.local,ev.description].filter(Boolean).some(v=>String(v).toLowerCase().includes(q)))); 
        if(!list.length){ show(empty); hide(grid); } 
        else { hide(empty); show(grid); } 
        list.forEach((ev, index) => { 
            const url = ev.imageUrls?.[0] || ''; 
            const card = document.createElement('article'); 
            card.className = 'group rounded-3xl overflow-hidden bg-white shadow-soft ring-subtle hover:shadow-xl transition cursor-pointer'; 
            card.innerHTML = `<div class="relative h-48 w-full bg-gray-100 overflow-hidden"><img class="h-full w-full object-cover group-hover:scale-[1.02] transition" src="${url}" alt="${ev.name || ''}" loading="${index < 4 ? 'eager' : 'lazy'}" decoding="async" /></div><div class="p-5 space-y-2"><h3 class="text-lg font-semibold break-words">${ev.name || ''}</h3><div class="text-sm text-gray-600">${fmtDate(ev.date)}</div>${(ev.local || ev.bairroName || ev.address || ev.location || ev.venue) ? `<div class="text-sm text-gray-600 line-clamp-1">${ev.local || ev.bairroName || ev.address || ev.location || ev.venue}</div>` : ''}${(Array.isArray(ev.styles) ? ev.styles : (ev.style ? [ev.style] : [])).map(s => `<div class="inline-flex items-center rounded-full border border-pink-600/30 bg-pink-600/5 px-3 py-0.5 text-[10px] md:py-1 md:text-xs font-medium text-pink-600">${s}</div>`).join('')}</div>`; 
            
            // Add error handling for images
            const img = card.querySelector('img');
            if (img) {
                img.onerror = function() {
                    this.src = 'https://placehold.co/280x176/f9a8d4/ffffff?text=RioFestas';
                    this.onerror = null;
                };
            }
            
            card.addEventListener('click', () => openViewModal(ev)); 
            grid.appendChild(card); 
        }); 
    }
    
    // CORREÇÃO: Função central para aplicar filtros e re-renderizar
    async function applyFiltersAndRender() {
        let filtered = [...state.events];

        const qEl = document.getElementById('search-input');
        const q = (qEl && qEl.value ? qEl.value : '').trim().toLowerCase();

        const hasB = state.selectedBairros.size > 0;
        const hasG = state.selectedGeneros.size > 0;

        if (hasB || hasG) {
            filtered = filtered.filter(ev => {
                const matchB = !hasB || (ev.bairroId && state.selectedBairros.has(ev.bairroId));
                const matchG = !hasG || ( (ev.generoId && state.selectedGeneros.has(ev.generoId)) || (Array.isArray(ev.generoIds) && ev.generoIds.some(id=> state.selectedGeneros.has(id))) );
                return matchB && matchG;
            });
        }
        

        // Apply query on top of Bairros/Gêneros
        if (q) {
            filtered = filtered.filter(ev => {
                const inName = (ev.name || '').toLowerCase().includes(q);
                const inLocal = (ev.local || '').toLowerCase().includes(q);
                const stylesArr = Array.isArray(ev.styles) ? ev.styles : (ev.style ? [ev.style] : []);
                const inStyle = stylesArr.some(s => (s || '').toLowerCase().includes(q));
                return inName || inLocal || inStyle;
            });
        }

        await renderAllHome(filtered);
        renderAdminEventsView(); // Re-renderiza a view do admin também se estiver aberta
        renderSocialFeeds(); // Re-renderiza feeds sociais
    }

    $('#search-input').addEventListener('input', () => applyFiltersAndRender().catch(console.error));


    function refreshAllAdminViews() {
      renderAdminEventsView();
      refreshAdminsList();
      renderOrgRequests();
      renderApprovedOrganizers();
      renderRecurringEventsAdmin();
    }

    async function renderLocationsPage() {
        const container = $('#locations-container');
        container.innerHTML = ''; 

        const activeEvents = state.events.filter(isEventActive);

        const eventsByLocation = activeEvents.reduce((acc, event) => {
            if (event.recurringEventId) {
                if (!acc[event.recurringEventId]) {
                    acc[event.recurringEventId] = [];
                }
                acc[event.recurringEventId].push(event);
            }
            return acc;
        }, {});

        let hasContent = false;
        
        for (const location of state.recurringEvents) {
            const locationEvents = eventsByLocation[location.id];

            if (locationEvents && locationEvents.length > 0) {
                hasContent = true;
                // Ordena por data - eventos mais próximos primeiro
                locationEvents.sort((a, b) => {
                    const dateA = a.date?.toDate ? a.date.toDate() : new Date(a.date);
                    const dateB = b.date?.toDate ? b.date.toDate() : new Date(b.date);
                    return dateA - dateB; // Ordem crescente (mais próximo primeiro)
                });

                const sectionEl = document.createElement('section');
                const carouselId = `carousel-location-${location.id}`;
                
                sectionEl.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h3 class="text-2xl md:text-3xl font-extrabold tracking-tight">${location.name}</h3>
                    </div>
                    <div id="${carouselId}" class="mt-4 flex gap-3 md:gap-4 overflow-x-auto snap-x snap-mandatory pb-4 -mx-4 px-4"></div>
                `;
                
                container.appendChild(sectionEl);
                
                const carouselContainer = sectionEl.querySelector(`#${carouselId}`);
                
                // Aguarda a criação de todos os cards de eventos
                for (const ev of locationEvents) {
                    const card = await eventCard(ev);
                    carouselContainer.appendChild(card);
                }
            }
        }

        if (!hasContent) {
            container.innerHTML = `
                <div class="mt-10 text-center text-gray-500">
                    <p>Nenhum evento encontrado para os locais cadastrados.</p>
                    <p class="mt-2 text-sm">Debug: ${state.events.length} eventos total, ${state.recurringEvents.length} locais recorrentes</p>
                </div>
            `;
        }
    }

    // ===== Admin: Gerenciamento de Eventos Unificado =====
    const adminTabActive = $('#admin-tab-active');
    const adminTabPast = $('#admin-tab-past');
    const pastSearchContainer = $('#past-events-search-container');
    const pastSearchInput = $('#past-events-search');
    const adminThead = $('#admin-events-thead');
    const adminTbody = $('#admin-events-tbody');
    const adminPlaceholder = $('#admin-events-placeholder');
    const activeSearchContainer = $('#active-events-search-container');
    const activeSearchInput = $('#active-events-search');

    const activeTheadHTML = `
        <tr class="text-left text-sm text-gray-600">
            <th class="px-4 py-3 font-semibold">Evento</th>
            <th class="px-4 py-3 font-semibold">Local</th>
            <th class="px-4 py-3 font-semibold">Data</th>
            <th class="px-4 py-3 font-semibold">Importância</th>
            <th class="px-4 py-3 font-semibold">Ações</th>
        </tr>`;

    const pastTheadHTML = `
        <tr class="text-left text-sm text-gray-600">
            <th class="px-4 py-3 font-semibold">Evento</th>
            <th class="px-4 py-3 font-semibold">Local</th>
            <th class="px-4 py-3 font-semibold">Data</th>
            <th class="px-4 py-3 font-semibold">Ações</th>
        </tr>`;

    adminTabActive.addEventListener('click', () => {
        state.adminEventsView = 'active';
        adminTabActive.classList.add('bg-white', 'shadow');
        adminTabActive.classList.remove('text-gray-600');
        adminTabPast.classList.remove('bg-white', 'shadow');
        adminTabPast.classList.add('text-gray-600');
        renderAdminEventsView();
    });

    adminTabPast.addEventListener('click', () => {
        state.adminEventsView = 'past';
        adminTabPast.classList.add('bg-white', 'shadow');
        adminTabPast.classList.remove('text-gray-600');
        adminTabActive.classList.remove('bg-white', 'shadow');
        adminTabActive.classList.add('text-gray-600');
        renderAdminEventsView();
    });

    pastSearchInput.addEventListener('input', (e) => {
        renderAdminPastEventsResults(e.target.value);
    });
    
    
    // Busca (Ativos): re-renderiza tabela enquanto digita
    if (activeSearchInput) {
        let _t;
        activeSearchInput.addEventListener('input', () => { clearTimeout(_t); _t = setTimeout(()=>{ if (state.adminEventsView === 'active') renderAdminEventsView(); }, 120); });
        activeSearchInput.addEventListener('keydown', (e)=>{ if (e.key==='Escape'){ activeSearchInput.value=''; renderAdminEventsView(); }});
    }
async function deleteRecurringInstance(eventInstance) {
        if (!ensureAdmin()) return;
        const { _original_id, date, name } = eventInstance;
        if (!_original_id || !date) {
            toast('Erro: Informações do evento recorrente inválidas.', 'error');
            return;
        }
        
        try {
            (async ()=>{ if (!confirm('Remover esta ocorrência do evento?')) return; })();
            await addDoc(collection(db, EVENT_EXCEPTIONS_PATH), {
                eventId: _original_id,
                deletedDate: date 
            });
            toast(`Ocorrência de "${name}" para ${fmtDate(date)} foi removida.`);
        } catch (err) {
            console.error('Falha ao remover ocorrência:', err);
            toast('Erro ao remover ocorrência.', 'error');
        }
    }


    function renderAdminEventsView() {
        adminTbody.innerHTML = '';
        hide(adminPlaceholder);

        if (state.adminEventsView === 'active') {
            show(activeSearchContainer);
            hide(pastSearchContainer);
            hide(pastSearchContainer);
            adminThead.innerHTML = activeTheadHTML;
            
            let activeEvents = state.events.filter(isEventActive);
            const _q = (activeSearchInput && activeSearchInput.value ? activeSearchInput.value : '').trim().toLowerCase();
            if (_q) {
                activeEvents = activeEvents.filter(ev => {
                    const name = (ev.name||'').toLowerCase();
                    const local = (ev.local||'').toLowerCase();
                    const stylesArr = Array.isArray(ev.styles) ? ev.styles : (ev.style ? [ev.style] : []);
                    const inStyle = stylesArr.some(s => (s||'').toLowerCase().includes(_q));
                    return name.includes(_q) || local.includes(_q) || inStyle;
                });
            }
            if (activeEvents.length === 0) {
                const hasQuery = !!_q;
                adminPlaceholder.textContent = hasQuery ? 'Nenhum evento encontrado para essa busca.' : 'Nenhum evento ativo no momento.';
                adminPlaceholder.textContent = 'Nenhum evento ativo no momento.';
                show(adminPlaceholder);
                return;
            }

            activeEvents.forEach(ev => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td class="event-cell" data-label="Evento">
                      <div class="flex items-center gap-3">
                          <img src="${ev.imageUrls?.[0]||''}" onerror="this.src='https://placehold.co/64x48/f9a8d4/ffffff?text=RioFestas'" class="h-12 w-16 rounded-lg object-cover ring-subtle" />
                          <div>
                              <div class="font-medium">${ev.name||''}</div>
                              <div class="text-xs text-gray-500">${Array.isArray(ev.styles) ? ev.styles.join(', ') : (ev.style||'')}</div>
                          </div>
                      </div>
                  </td>
                  <td data-label="Local" class="text-sm text-gray-700">${ev.local||''}</td>
                  <td data-label="Data" class="text-sm text-gray-700">${fmtDate(ev.date)}</td>
                  <td data-label="Importância" class="text-sm">${Number(ev.importance||0)}</td>
                  <td class="actions-cell">
                      <div class="flex gap-2 justify-end">
                          <button class="inline-flex items-center rounded-full border border-gray-200 bg-white px-3 py-1.5 text-sm font-semibold hover:bg-gray-50" data-act="edit">Editar</button>
                          <button class="inline-flex items-center rounded-full border border-red-200 bg-red-50 px-3 py-1.5 text-sm font-semibold text-red-700 hover:bg-red-100" data-act="del">Excluir</button>
                      </div>
                  </td>`;
                tr.querySelector('[data-act="edit"]').addEventListener('click', () => {
                    if (!ensureAdmin()) return;
                    const baseEvent = state.baseEvents.find(base => base._id === (ev._original_id || ev._id));
                    if (baseEvent) {
                        openEventModal('edit', baseEvent);
                    } else {
                        toast('Evento original não encontrado para edição.', 'error');
                    }
                });
                tr.querySelector('[data-act="del"]').addEventListener('click', () => {
                    if (!ensureAdmin()) return;
                    if (ev.isGenerated) {
                        deleteRecurringInstance(ev);
                    } else {
                        state.deleteTarget = { path: ev._path, name: ev.name };
                        $('#delete-event-name').textContent = ev.name || 'este evento';
                        show($('#delete-modal'));
                    }
                });
                adminTbody.appendChild(tr);
            });
        } else { // 'past' view
            hide(activeSearchContainer);
            show(pastSearchContainer);
            pastSearchInput.value = '';
            adminThead.innerHTML = pastTheadHTML;
            adminPlaceholder.textContent = 'Digite na busca para encontrar eventos passados (últimos 7 dias).';
            show(adminPlaceholder);
        }
    }

    function renderAdminPastEventsResults(searchTerm = '') {
        adminTbody.innerHTML = '';
        hide(adminPlaceholder);

        if (!searchTerm.trim()) {
            adminPlaceholder.textContent = 'Digite na busca para encontrar eventos passados (últimos 7 dias).';
            show(adminPlaceholder);
            return;
        }

        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

        const pastEvents = state.events
            .filter(ev => !isEventActive(ev))
            .filter(ev => (ev.endDate?.toDate() || ev.date?.toDate()) >= sevenDaysAgo)
            .filter(ev => ev.name.toLowerCase().includes(searchTerm.toLowerCase()));

        if (pastEvents.length === 0) {
            adminPlaceholder.textContent = 'Nenhum evento passado encontrado com esse nome.';
            show(adminPlaceholder);
            return;
        }

        pastEvents.forEach(ev => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="event-cell" data-label="Evento">
                  <div class="flex items-center gap-3">
                      <img src="${ev.imageUrls?.[0]||''}" onerror="this.src='https://placehold.co/64x48/f9a8d4/ffffff?text=RioFestas'" class="h-12 w-16 rounded-lg object-cover ring-subtle" />
                      <div>
                          <div class="font-medium">${ev.name||''}</div>
                          <div class="text-xs text-gray-500">${Array.isArray(ev.styles) ? ev.styles.join(', ') : (ev.style||'')}</div>
                      </div>
                  </div>
              </td>
              <td data-label="Local" class="text-sm text-gray-700">${ev.local||''}</td>
              <td data-label="Data" class="text-sm text-gray-700">${fmtDate(ev.date)}</td>
              <td class="actions-cell">
                  <div class="flex gap-2 justify-end">
                      <button class="inline-flex items-center rounded-full border border-gray-200 bg-white px-3 py-1.5 text-sm font-semibold hover:bg-gray-50" data-act="edit">Editar</button>
                  </div>
              </td>`;
            tr.querySelector('[data-act="edit"]').addEventListener('click', () => {
              if (!ensureAdmin()) return;
              const baseEvent = state.baseEvents.find(base => base._id === (ev._original_id || ev._id));
                if (baseEvent) {
                    openEventModal('edit', baseEvent);
                } else {
                    toast('Evento original não encontrado para edição.', 'error');
                }
            });
            adminTbody.appendChild(tr);
        });
    }

    $('#delete-confirm-btn').addEventListener('click', async (e)=>{
        if (!state.deleteTarget) return;
        const { path, name } = state.deleteTarget;
        const btn = e.target;
        const oldText = btn.textContent;
        btn.textContent = 'Excluindo...';
        btn.disabled = true;
        try {
            if (!path) throw new Error("Caminho do documento não encontrado.");
            const ref = doc(db, path);
            await deleteDoc(ref);
            toast(`Evento "${name}" excluído.`);
        } catch (err) {
            console.error('[Excluir] falhou', err);
            toast(`Falha ao excluir: ${err?.message || 'ver console'}`, 'error');
        } finally {
            btn.textContent = oldText;
            btn.disabled = false;
            hide($('#delete-modal'));
            state.deleteTarget = null;
        }
    });

    // ===== Create/Edit: UPLOAD LÓGICA =====
    function handleFileUpload(files, context) {
        console.log(`[Upload] Seleção de arquivos. Contexto: ${context}. Arquivos:`, files);
        const formState = context === 'admin' ? state.eventForm : state.orgEventForm;
        const saveBtn = context === 'admin' ? $('#btn-save-event') : $('#org-btn-save');
        
        for (const file of files) {
            if (!file.type.startsWith('image/')) {
                console.warn('[Upload] Arquivo ignorado (não é imagem):', file.name);
                continue;
            }
            const uniqueId = `upload_${Date.now()}_${Math.random().toString(36).slice(2)}`;
            const filePath = `event-images/${auth.currentUser.uid}/${uniqueId}-${file.name}`;
            const storageRef = ref(storage, filePath);
            const uploadTask = uploadBytesResumable(storageRef, file);

            console.log(`[Upload] Iniciando upload para ${file.name} com ID: ${uniqueId}`);
            formState.uploadTasks[uniqueId] = { status: 'running', progress: 0, file, task: uploadTask };
            
            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    if(formState.uploadTasks[uniqueId]) {
                      formState.uploadTasks[uniqueId].progress = progress;
                    }
                    console.log(`[Upload Progress] ${uniqueId}: ${progress.toFixed(2)}%`);
                    renderPhotoPreview(context);
                    if (saveBtn) {
                        saveBtn.disabled = true;
                        saveBtn.textContent = 'Aguarde o upload...';
                    }
                },
                (error) => {
                    if (error.code !== 'storage/canceled') {
                      console.error(`[Upload Error] ${uniqueId}:`, error);
                      toast(`Erro no upload de ${file.name}`, 'error');
                    } else {
                      console.log(`[Upload Canceled] ${uniqueId}`);
                    }
                    delete formState.uploadTasks[uniqueId];
                    renderPhotoPreview(context);
                    checkAllUploadsDone(context);
                },
                async () => {
                    try {
                        console.log(`[Upload Success] ${uniqueId}. Obtendo URL...`);
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        console.log(`[Upload Complete] ${uniqueId}. URL: ${downloadURL}`);
                        formState.imageUrls.push(downloadURL);
                        delete formState.uploadTasks[uniqueId];
                        renderPhotoPreview(context);
                        checkAllUploadsDone(context);
                    } catch (error) {
                        console.error(`[Upload URL Error] ${uniqueId}:`, error);
                        toast(`Erro ao obter URL de ${file.name}`, 'error');
                        delete formState.uploadTasks[uniqueId];
                        renderPhotoPreview(context);
                        checkAllUploadsDone(context);
                    }
                }
            );
        }
        renderPhotoPreview(context);
    }

    function checkAllUploadsDone(context) {
        const formState = context === 'admin' ? state.eventForm : state.orgEventForm;
        const saveBtn = context === 'admin' ? $('#btn-save-event') : $('#org-btn-save');
        const defaultText = context === 'admin' ? 'Salvar Evento' : 'Enviar para aprovação';

        if (Object.keys(formState.uploadTasks).length === 0) {
            console.log('[Upload] Todas as tarefas concluídas.');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = defaultText;
            }
        }
    }

    function renderPhotoPreview(context) {
        const formState = context === 'admin' ? state.eventForm : state.orgEventForm;
        const previewEl = context === 'admin' ? $('#preview-photos') : $('#org-preview-photos');
        if (!previewEl) return;
        previewEl.innerHTML = '';

        // Render completed/existing URLs
        formState.imageUrls.forEach((url, index) => {
            const el = document.createElement('div');
            el.className = 'relative group';
            el.innerHTML = `
                <img src="${url}" class="h-24 w-full rounded-lg object-cover ring-subtle"/>
                <button type="button" class="absolute right-1.5 top-1.5 hidden group-hover:inline-flex items-center justify-center h-7 w-7 rounded-full bg-white/90 text-gray-700 shadow ring-1 ring-gray-200">✕</button>
            `;
            el.querySelector('button').addEventListener('click', () => {
                formState.imageUrls.splice(index, 1);
                renderPhotoPreview(context);
            });
            previewEl.appendChild(el);
        });

        // Render ongoing uploads
        Object.values(formState.uploadTasks).forEach(task => {
            const el = document.createElement('div');
            el.className = 'relative group overflow-hidden rounded-lg';
            const localUrl = URL.createObjectURL(task.file);
            el.innerHTML = `
                <img src="${localUrl}" class="h-24 w-full object-cover ring-subtle opacity-60"/>
                <div class="absolute inset-0 bg-black/30 flex items-center justify-center">
                    <span class="text-white text-sm font-semibold">${task.progress.toFixed(0)}%</span>
                </div>
                <div class="progress-bar" style="width: ${task.progress}%"></div>
            `;
            previewEl.appendChild(el);
        });
    }

    // ===== Create/Edit: ADMIN =====
    $('#ev-photo-upload').addEventListener('change', (e) => handleFileUpload(e.target.files, 'admin'));
    $('#org-ev-photo-upload').addEventListener('change', (e) => handleFileUpload(e.target.files, 'organizer'));

    // CORREÇÃO: Listener do slider de importância
    $('#ev-importance').addEventListener('input', (e) => {
        $('#ev-importance-value').textContent = e.target.value;
    });

    function resetEventForm(context){
        const formState = context === 'admin' ? state.eventForm : state.orgEventForm;
        const formEl = context === 'admin' ? $('#event-form') : $('#org-event-form');
        const previewEl = context === 'admin' ? $('#preview-photos') : $('#org-preview-photos');
        const errorEl = context === 'admin' ? $('#event-error') : $('#org-event-error');
        
        formEl.reset();
        if (context === 'admin') {
            $('#ev-importance').value=5; 
            $('#ev-importance-value').textContent='5';
            $('#ev-repeat-options').style.display = 'none';
        } else {
            $('#org-ev-repeat-options').style.display = 'none';
        }
        previewEl.innerHTML='';
        hide(errorEl);
        
        state.editingId=null;
        formState.imageUrls = [];
        formState.uploadTasks = {};
    }

    function openEventModal(mode='create', ev=null){
        let context = 'admin';
        if (mode.startsWith('org-')) {
            context = 'organizer';
        }
        
        const modal = context === 'admin' ? $('#event-modal') : $('#org-event-modal');
        const titleEl = context === 'admin' ? $('#event-modal-title') : modal.querySelector('h3');
        const formState = context === 'admin' ? state.eventForm : state.orgEventForm;

        if (context === 'admin' && !ensureAdmin()) return;
        if (context === 'organizer' && (!auth.currentUser || auth.currentUser.isAnonymous)) return openLogin();

        formState.imageUrls = [];
        formState.uploadTasks = {};
        resetEventForm(context);

        const isEdit = (mode==='edit'&&ev) || (mode==='edit-pending'&&ev) || (mode==='org-edit'&&ev);
        
        titleEl.textContent = isEdit ? 'Editar Evento' : (context === 'admin' ? 'Novo Evento' : 'Criar Evento');
        const prefix = context === 'admin' ? 'ev' : 'org-ev';

        if(isEdit){
            state.editingId = ev._id || ev.id;
            $(`#${prefix}-name`).value=ev.name||'';
            if(ev.date){ const d=ev.date?.toDate?ev.date.toDate():new Date(ev.date); $(`#${prefix}-date`).valueAsDate=d }
            if(ev.endDate){ const d=ev.endDate?.toDate?ev.endDate.toDate():new Date(ev.endDate); $(`#${prefix}-date-end`).valueAsDate=d }
            $(`#${prefix}-time-start`).value=ev.timeStart||'';
            $(`#${prefix}-time-end`).value=ev.timeEnd||'';
            $(`#${prefix}-local`).value=ev.local||'';
            $(`#${prefix}-desc`).value=ev.description||'';
            $(`#${prefix}-buy`).value=ev.buyLink||'';
            $(`#${prefix}-coupon`).value=ev.coupon||'';
            if (context === 'admin') {
                $('#ev-importance').value=Number(ev.importance??5);
                $('#ev-importance-value').textContent=Number(ev.importance??5);
            }
            $(`#${prefix}-recurring`).value = ev.recurringEventId || '';
            $(`#${prefix}-private`).checked = ev.isPrivate || false;
            formState.imageUrls = [...(ev.imageUrls||[])];
            state._editPending = (mode==='edit-pending');

            $(`#${prefix}-repeats-weekly`).checked = ev.repeatsWeekly || false;
            $(`#${prefix}-display-count`).value = ev.displayCount || 1;
        }
        
        const repeatsCheckbox = $(`#${prefix}-repeats-weekly`);
        const repeatOptions = $(`#${prefix}-repeat-options`);
        repeatOptions.style.display = repeatsCheckbox.checked ? 'block' : 'none';
        repeatsCheckbox.onchange = () => {
            repeatOptions.style.display = repeatsCheckbox.checked ? 'block' : 'none';
        };

        renderPhotoPreview(context);
        checkAllUploadsDone(context);
        show(modal);
    }

    $('#event-form').addEventListener('submit', onSaveEvent);
    async function onSaveEvent(e){ 
      e.preventDefault(); 
      if(!ensureAdmin()) return; 
      const formState = state.eventForm;
      const errorEl = $('#event-error');
      hide(errorEl);

      if (Object.values(formState.uploadTasks).some(t => t.status === 'running')) {
        errorEl.textContent = 'Aguarde o fim de todos os uploads.'; show(errorEl); return;
      }
      
      const name=$('#ev-name').value.trim(); const dateS=$('#ev-date').value; const local=$('#ev-local').value.trim();
      if(!name||!dateS||!local) { errorEl.textContent = 'Preencha nome, data e local.'; show(errorEl); return; }
      if(formState.imageUrls.length===0) { errorEl.textContent = 'Adicione pelo menos uma foto.'; show(errorEl); return; }
      
      try{
        const when=parseDateInput(dateS);
        const endDateVal = $('#ev-date-end').value;
        const generoSel = document.getElementById('ev-genero');
const generoIds = generoSel ? Array.from(generoSel.selectedOptions).map(o=>o.value).filter(Boolean) : [];
const generoNames = generoIds.map(id => state.generos.find(g=>g.id===id)?.name).filter(Boolean);
        const payload={ 
          name, local, date: Timestamp.fromDate(when),
          endDate: endDateVal ? Timestamp.fromDate(parseDateInput(endDateVal)) : null,
          description:$('#ev-desc').value.trim(), 
          styles: generoNames, style: (generoNames[0] || null), 
          buyLink:$('#ev-buy').value.trim(), coupon:$('#ev-coupon').value.trim(), 
          timeStart:$('#ev-time-start').value||null, timeEnd:$('#ev-time-end').value||null, 
          importance:Number($('#ev-importance').value), imageUrls: formState.imageUrls, 
          recurringEventId: $('#ev-recurring').value || null, 
          bairroId: (document.getElementById('ev-bairro')?.value || null), 
          generoIds: generoIds, generoId: (generoIds[0] || null), 
          bairroName: (state.bairros.find(b=>b.id===document.getElementById('ev-bairro')?.value)?.name || null), 
          generoNames: generoNames, 
          isPrivate: $('#ev-private').checked,
          updatedAt: serverTimestamp(),
          repeatsWeekly: $('#ev-repeats-weekly').checked,
          displayCount: parseInt($('#ev-display-count').value, 10) || 1
        };
        
        if(state._editPending){ await updateDoc(doc(db, PENDING_PATH, state.editingId), payload); toast('Rascunho pendente atualizado!'); } 
        else if(state.editingId){ await updateDoc(doc(db, EVENTS_PATH, state.editingId), payload); toast('Evento atualizado!'); } 
        else { await addDoc(collection(db, EVENTS_PATH), { ...payload, createdAt: serverTimestamp(), goingCount: 0 }); toast('Evento criado com sucesso!'); } 
        
        hide($('#event-modal')); 
      }catch(err){ console.error(err); errorEl.textContent = err?.message||'Falha ao salvar.'; show(errorEl); } 
    }

    // ===== Visualização =====
    async function openViewModal(ev){
      // Verifica se é evento privado e se o usuário não está logado
      const isPrivate = ev.isPrivate || false;
      const isLoggedIn = auth.currentUser && !auth.currentUser.isAnonymous;
      
      if (isPrivate && !isLoggedIn) {
        // Mostra modal de login com mensagem específica
        openLogin();
        toast('Para ver mais detalhes deste evento privado, você precisa fazer login.', 'info');
        return;
      }
      
      if (isPrivate && isLoggedIn) {
        // Verifica se o usuário tem acesso ao evento privado
        const hasAccess = await checkPrivateEventAccess(ev._original_id || ev._id);
        if (!hasAccess) {
          // Verifica se já solicitou acesso
          const hasRequested = await checkPrivateEventRequest(ev._original_id || ev._id);
          if (hasRequested) {
            // Mostra notificação de que a solicitação está pendente
            showNotification('Sua solicitação de acesso ainda está pendente. Aguarde a aprovação do organizador.');
            return;
          } else {
            // Mostra modal customizado para solicitar acesso
            showPrivateEventAccessModal(ev._original_id || ev._id, ev.name);
          }
          return;
        }
      }
      
      state.currentViewEvent = ev;
      $('#view-title').textContent=ev.name||'Evento'; const d=ev.date?.toDate?ev.date.toDate():new Date(ev.date); const dateStr = `${d.toLocaleDateString('pt-BR',{day:'2-digit',month:'short'})} (${weekdayLabels[d.getDay()]})`; $('#view-date').textContent = dateStr + (ev.timeStart?` • ${ev.timeStart}${ev.timeEnd?`–${ev.timeEnd}`:''}`:''); $('#view-local').textContent=ev.local||'—'; $('#view-style').textContent = (Array.isArray(ev.styles) ? ev.styles : (ev.style ? [ev.style] : [])).join(' e ') || '—'; $('#view-desc').textContent=ev.description||'—'; const buy=$('#view-buy'); if(ev.buyLink){ buy.href=ev.buyLink; buy.classList.remove('pointer-events-none','opacity-50'); } else { buy.href='#'; buy.classList.add('pointer-events-none','opacity-50'); } $('#view-coupon').textContent=ev.coupon||'—'; const g=$('#view-gallery'); g.innerHTML=''; (ev.imageUrls||[]).forEach((u,i)=> g.insertAdjacentHTML('beforeend', `<img src="${u}" alt="${ev.name||''} - foto ${i+1}" class="w-full aspect-[16/10] object-cover rounded-2xl ring-subtle"/>`) );
      updateGoingButtonUI();
      await renderFriendsGoing(ev._original_id || ev._id);
      await renderRatingSection(ev.recurringEventId);
      show($('#event-view'));
    }

    // ===== Social: "Vou nesse" =====
    function updateGoingButtonUI() {
      if (!state.currentViewEvent) return;
      const evId = state.currentViewEvent._original_id || state.currentViewEvent._id;
      const isGoing = state.userGoingTo.has(evId);
      const btn = $('#btn-going');
      const btnText = $('#btn-going-text');
      const countEl = $('#going-count');

      btn.classList.toggle('bg-gray-500', isGoing);
      btn.classList.toggle('bg-emerald-600', !isGoing);
      btnText.textContent = isGoing ? 'Presença Confirmada' : 'Confirmar Presença';
      const count = state.currentViewEvent.goingCount || 0;
      
      if (count > 0) {
        countEl.innerHTML = `${count} pessoa${count > 1 ? 's' : ''} ${count > 1 ? 'vão' : 'vai'} nesse evento.`;
      } else {
        countEl.innerHTML = 'Seja o primeiro a confirmar presença!';
      }
    }

    $('#btn-going').addEventListener('click', async () => {
      if (!auth.currentUser || auth.currentUser.isAnonymous) return openLogin();
      if (!state.currentViewEvent) return;

      const evId = state.currentViewEvent._original_id || state.currentViewEvent._id;
      const eventPath = state.currentViewEvent._path;
      const userId = auth.currentUser.uid;
      const isCurrentlyGoing = state.userGoingTo.has(evId);
      const batch = writeBatch(db);

      const eventRef = doc(db, eventPath);
      const goingToRef = doc(db, `artifacts/${appId}/users/${userId}/goingTo`, evId);
      const attendeeRef = doc(db, `${eventPath}/attendees`, userId);

      if (isCurrentlyGoing) {
        batch.delete(goingToRef);
        batch.delete(attendeeRef);
        batch.update(eventRef, { goingCount: increment(-1) });
      } else {
        batch.set(goingToRef, { eventId: evId, addedAt: serverTimestamp() });
        batch.set(attendeeRef, { userId: userId, addedAt: serverTimestamp() });
        batch.update(eventRef, { goingCount: increment(1) });
      }

      try {
        await batch.commit();
        toast(isCurrentlyGoing ? 'Presença removida.' : 'Presença confirmada!');
        if (!isCurrentlyGoing) {
            notifyFollowersOfGoing(userId, evId);
        }
      } catch (err) {
        console.error("Erro ao confirmar presença:", err);
        toast('Erro ao confirmar presença.', 'error');
      }
    });

    // ===== Social: Sistema de Seguir (com Perfil Privado) =====
    async function toggleFollow(targetUserId, buttonEl = null) {
        const currentUser = auth.currentUser;
        if (!currentUser || currentUser.isAnonymous) return openLogin();
        if (currentUser.uid === targetUserId) return;

        const targetUser = state.users[targetUserId];
        if (!targetUser) {
            toast('Este usuário não existe.', 'error');
            return;
        }

        const isFollowing = state.userFollowing.has(targetUserId);
        const hasRequested = state.userOutgoingRequests.has(targetUserId);
        const originalState = { isFollowing, hasRequested };

        if (buttonEl) buttonEl.disabled = true;

        if (buttonEl) {
            if (isFollowing) { 
                buttonEl.textContent = 'Seguir';
                buttonEl.className = buttonEl.className.replace(/bg-gray-200\s+text-gray-800/, 'bg-pink-600 text-white');
            } else if (hasRequested) { 
                buttonEl.textContent = 'Seguir';
                buttonEl.className = buttonEl.className.replace(/bg-gray-100\s+text-gray-600\s+border\s+border-gray-300/, 'bg-pink-600 text-white');
            } else { 
                if (targetUser.isPrivate) {
                    buttonEl.textContent = 'Solicitado';
                    buttonEl.className = buttonEl.className.replace(/bg-pink-600\s+text-white/, 'bg-gray-100 text-gray-600 border border-gray-300');
                } else {
                    buttonEl.textContent = 'Seguindo';
                    buttonEl.className = buttonEl.className.replace(/bg-pink-600\s+text-white/, 'bg-gray-200 text-gray-800');
                }
            }
        }

        const batch = writeBatch(db);
        const currentUserRef = doc(db, USERS_PATH, currentUser.uid);
        const targetUserRef = doc(db, USERS_PATH, targetUserId);

        if (isFollowing) {
            const followingRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/following`, targetUserId);
            const followerRef = doc(db, `artifacts/${appId}/users/${targetUserId}/followers`, currentUser.uid);
            batch.delete(followingRef);
            batch.delete(followerRef);
            batch.update(currentUserRef, { followingCount: increment(-1) });
            batch.update(targetUserRef, { followersCount: increment(-1) });
        } 
        else if (hasRequested) {
            const outgoingRequestRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/outgoingFollowRequests`, targetUserId);
            const incomingRequestRef = doc(db, `artifacts/${appId}/users/${targetUserId}/followRequests`, currentUser.uid);
            const notificationRef = doc(db, `artifacts/${appId}/users/${targetUserId}/notifications`, `follow_request_${currentUser.uid}`);
            batch.delete(outgoingRequestRef);
            batch.delete(incomingRequestRef);
            batch.delete(notificationRef);
        } 
        else {
            if (targetUser.isPrivate) {
                const outgoingRequestRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/outgoingFollowRequests`, targetUserId);
                const incomingRequestRef = doc(db, `artifacts/${appId}/users/${targetUserId}/followRequests`, currentUser.uid);
                const notificationRef = doc(db, `artifacts/${appId}/users/${targetUserId}/notifications`, `follow_request_${currentUser.uid}`);
                
                batch.set(outgoingRequestRef, { requestedAt: serverTimestamp() });
                batch.set(incomingRequestRef, { from: currentUser.uid, timestamp: serverTimestamp() });
                batch.set(notificationRef, { type: 'follow_request', fromUserId: currentUser.uid, timestamp: serverTimestamp(), read: false });
            } 
            else {
                const followingRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/following`, targetUserId);
                const followerRef = doc(db, `artifacts/${appId}/users/${targetUserId}/followers`, currentUser.uid);
                const notificationRef = doc(db, `artifacts/${appId}/users/${targetUserId}/notifications`, `new_follower_${currentUser.uid}`);
                
                batch.set(followingRef, { followedAt: serverTimestamp() });
                batch.set(followerRef, { followerAt: serverTimestamp() });
                batch.update(currentUserRef, { followingCount: increment(1) });
                batch.update(targetUserRef, { followersCount: increment(1) });
                batch.set(notificationRef, { type: 'new_follower', fromUserId: currentUser.uid, timestamp: serverTimestamp(), read: false });
            }
        }

        try {
            await batch.commit();
        } catch (err) {
            console.error("Erro na operação de seguir:", err);
            toast("Ocorreu um erro.", 'error');
            if (buttonEl) {
                if (originalState.isFollowing) {
                    buttonEl.textContent = 'Seguindo';
                    buttonEl.className = buttonEl.className.replace(/bg-pink-600\s+text-white/, 'bg-gray-200 text-gray-800');
                } else if (originalState.hasRequested) {
                    buttonEl.textContent = 'Solicitado';
                     buttonEl.className = buttonEl.className.replace(/bg-pink-600\s+text-white/, 'bg-gray-100 text-gray-600 border border-gray-300');
                } else {
                    buttonEl.textContent = 'Seguir';
                    buttonEl.className = buttonEl.className.replace(/bg-gray-100\s+text-gray-600\s+border\s+border-gray-300|bg-gray-200\s+text-gray-800/, 'bg-pink-600 text-white');
                }
            }
        } finally {
            if (buttonEl) {
                buttonEl.disabled = false;
            }
        }
    }
    
    function promptRemoveFollower(followerId, fromProfile = false) {
        const followerUser = state.users[followerId];
        if (!followerUser) return toast('Usuário não encontrado.', 'error');
        
        state.removeFollowerTarget = { id: followerId, name: followerUser.name, fromProfile };
        
        $('#remove-follower-name').textContent = followerUser.name || 'este usuário';
        show($('#remove-follower-modal'));
    }

    async function confirmRemoveFollower() {
        if (!state.removeFollowerTarget) return;

        const { id: followerId, fromProfile, name } = state.removeFollowerTarget;
        const currentUser = auth.currentUser;
        if (!currentUser || currentUser.isAnonymous) return;

        const btn = $('#remove-follower-confirm-btn');
        const oldText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Removendo...';

        const followerUserRef = doc(db, USERS_PATH, followerId);
        
        try {
            const followerUserDoc = await getDoc(followerUserRef);
            if (!followerUserDoc.exists()) {
                throw new Error('Este seguidor já não existe.');
            }

            const batch = writeBatch(db);
            const currentUserRef = doc(db, USERS_PATH, currentUser.uid);
            const myFollowerRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/followers`, followerId);
            const theirFollowingRef = doc(db, `artifacts/${appId}/users/${followerId}/following`, currentUser.uid);

            batch.delete(myFollowerRef);
            batch.delete(theirFollowingRef);
            batch.update(currentUserRef, { followersCount: increment(-1) });
            batch.update(followerUserRef, { followingCount: increment(-1) });

            await batch.commit();
            toast(`Você removeu ${name} dos seus seguidores.`);
            
            if (fromProfile) {
                openUserProfileModal(followerId);
            } else {
                loadFollowLists(); 
            }
        } catch (err) {
            console.error("Erro ao remover seguidor:", err);
            toast(err.message || "Ocorreu um erro ao remover seguidor.", 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = oldText;
            hide($('#remove-follower-modal'));
            state.removeFollowerTarget = null;
        }
    }
    $('#remove-follower-confirm-btn').addEventListener('click', confirmRemoveFollower);

    // ===== Social: Feeds =====
    async function renderSocialFeeds() {
        const popular = [...state.events].filter(isEventActive).filter(ev => ev.goingCount > 0).sort((a, b) => (b.goingCount || 0) - (a.goingCount || 0)).slice(0, 10);
        renderCarousel('carousel-social-popular', popular, 'empty-social-popular');

        const friendsEvents = await getFriendsEvents();
        renderCarousel('carousel-friends-popular', friendsEvents, 'empty-friends-popular');
    }
    
    async function updateFriendsGoingMap() {
        state.friendsGoingMap.clear();
        if (state.userFollowing.size === 0) {
            applyFiltersAndRender(); 
            return;
        }

        const friendIds = Array.from(state.userFollowing);
        const promises = friendIds.map(friendId => 
            getDocs(collection(db, `artifacts/${appId}/users/${friendId}/goingTo`))
        );
        const results = await Promise.all(promises);

        results.forEach((snap, index) => {
            const friendId = friendIds[index];
            snap.forEach(doc => {
                const eventId = doc.id;
                if (!state.friendsGoingMap.has(eventId)) {
                    state.friendsGoingMap.set(eventId, new Set());
                }
                state.friendsGoingMap.get(eventId).add(friendId);
            });
        });
        applyFiltersAndRender(); 
    }

    async function getFriendsEvents() {
        if (state.userFollowing.size === 0) return [];
        const friendsIds = Array.from(state.userFollowing);
        const eventCounts = {};
        for (const friendId of friendsIds) {
            const goingToSnap = await getDocs(collection(db, `artifacts/${appId}/users/${friendId}/goingTo`));
            goingToSnap.forEach(doc => {
                const eventId = doc.id;
                eventCounts[eventId] = (eventCounts[eventId] || 0) + 1;
            });
        }
        const sortedEventIds = Object.keys(eventCounts).sort((a, b) => eventCounts[b] - eventCounts[a]);
        return sortedEventIds.map(id => state.events.find(ev => (ev._original_id || ev._id) === id)).filter(Boolean).filter(isEventActive);
    }

    // ===== Social: Busca e Perfil =====
    $('#user-search-input').addEventListener('input', (e) => {
      const query = e.target.value.trim().toLowerCase();
      const resultsEl = $('#user-search-results');
      resultsEl.innerHTML = '';
      if (query.length < 2) return;

      const results = Object.values(state.users).filter(u =>
        u.id !== auth.currentUser?.uid && !u.organizer && (u.username?.toLowerCase().includes(query) || u.name?.toLowerCase().includes(query))
      );

      if (results.length === 0) {
        resultsEl.innerHTML = '<div class="text-center text-gray-500 py-4">Nenhum usuário encontrado.</div>';
        return;
      }

      results.forEach(user => {
        const isFollowing = state.userFollowing.has(user.id);
        const hasRequested = state.userOutgoingRequests.has(user.id);
        const userCard = document.createElement('div');
        userCard.className = 'flex items-center gap-4 p-3 rounded-2xl hover:bg-gray-50';
        
        let btnClass, btnText;
        if (isFollowing) {
            btnClass = 'bg-gray-200 text-gray-800';
            btnText = 'Seguindo';
        } else if (hasRequested) {
            btnClass = 'bg-gray-100 text-gray-600 border border-gray-300';
            btnText = 'Solicitado';
        } else {
            btnClass = 'bg-pink-600 text-white';
            btnText = 'Seguir';
        }

        userCard.innerHTML = `
          <img src="${user.photoUrl || 'https://placehold.co/48x48/f472b6/ffffff?text='+initials(user.name)}" class="h-12 w-12 rounded-full object-cover bg-gray-200 cursor-pointer" data-profile-id="${user.id}">
          <div class="flex-1 cursor-pointer" data-profile-id="${user.id}">
            <div class="font-semibold">${user.name}</div>
            <div class="text-sm text-gray-500">@${user.username}</div>
          </div>
          <button class="rounded-full px-4 py-2 text-sm font-semibold ${btnClass}" data-follow-id="${user.id}">${btnText}</button>
        `;
        const followBtn = userCard.querySelector(`[data-follow-id]`);
        followBtn.addEventListener('click', () => toggleFollow(user.id, followBtn));
        userCard.querySelectorAll(`[data-profile-id]`).forEach(el => el.addEventListener('click', () => openUserProfileModal(user.id)));
        resultsEl.appendChild(userCard);
      });
    });

    async function openUserProfileModal(userId) {
        const user = state.users[userId];
        if (!user) return toast('Usuário não encontrado.', 'error');

        const contentEl = $('#profile-content');
        contentEl.innerHTML = '<div class="text-center py-8">Carregando...</div>';
        show($('#user-profile-modal'));
        document.body.classList.add('modal-open');

        const isFollowing = state.userFollowing.has(userId);
        const isFollower = state.userFollowers.has(userId);
        const hasRequested = state.userOutgoingRequests.has(userId);
        const hasPendingRequestFromUser = state.incomingFollowRequests.has(userId);
        const isOwnProfile = auth.currentUser?.uid === userId;
        
        const canViewDetails = !user.isPrivate || isFollowing || isOwnProfile;

        let actionButtonsHTML = '';
        if (!isOwnProfile) {
            if (hasPendingRequestFromUser) {
                actionButtonsHTML = `
                <div id="profile-request-banner" class="mt-4 w-full p-3 rounded-2xl bg-gray-100 text-center">
                    <p class="text-sm font-medium">${user.name} quer seguir você.</p>
                    <div class="mt-2 flex justify-center gap-2">
                        <button class="rounded-full bg-emerald-600 text-white px-4 py-2 text-xs font-semibold" data-profile-accept-request="${userId}">Aceitar</button>
                        <button class="rounded-full bg-gray-200 text-gray-800 px-4 py-2 text-xs font-semibold" data-profile-decline-request="${userId}">Recusar</button>
                    </div>
                </div>`;
            } else {
                let btnClass, btnText;
                if (isFollowing) {
                    btnClass = 'bg-gray-200 text-gray-800';
                    btnText = 'Seguindo';
                } else if (hasRequested) {
                    btnClass = 'bg-gray-100 text-gray-600 border border-gray-300';
                    btnText = 'Solicitado';
                } else {
                    btnClass = 'bg-pink-600 text-white';
                    btnText = 'Seguir';
                }
                actionButtonsHTML = `<button id="profile-follow-btn" class="mt-4 rounded-full px-5 py-2.5 text-sm font-semibold ${btnClass}">${btnText}</button>`;
            }

            if (isFollower) {
                actionButtonsHTML += `<button id="profile-remove-follower-btn" class="mt-3 w-full rounded-full bg-red-50 border border-red-200 px-4 py-2 text-sm font-semibold text-red-700 hover:bg-red-100 transition-colors">Remover seguidor</button>`;
            }
        }
        
        let detailsHTML = '';
        if (canViewDetails) {
            const goingToSnap = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/goingTo`));
            const eventIds = goingToSnap.docs.map(d => d.id);
            const upcomingEvents = [], pastEvents = [];
            
            for (const eventId of eventIds) {
                const eventData = state.baseEvents.find(e => e._id === eventId);
                if (eventData) {
                    if (isEventActive(eventData)) {
                        upcomingEvents.push(eventData);
                    } else {
                        pastEvents.push(eventData);
                    }
                }
            }
            detailsHTML = `
                <div class="mt-8">
                    <h5 class="font-semibold">Próximos Eventos</h5>
                    <div id="upcoming-list" class="mt-2 space-y-2">${renderProfileEventList(upcomingEvents)}</div>
                </div>
                <div class="mt-6">
                    <h5 class="font-semibold">Eventos Anteriores</h5>
                    <div id="past-list" class="mt-2 space-y-2">${renderProfileEventList(pastEvents)}</div>
                </div>`;
        } else {
            detailsHTML = `
                <div class="mt-8 text-center p-6 rounded-2xl bg-gray-50 border border-gray-200">
                    <svg class="mx-auto h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                    <h5 class="mt-2 font-semibold">Este perfil é privado</h5>
                    <p class="mt-1 text-sm text-gray-500">Siga esta pessoa para ver os eventos que ela vai.</p>
                </div>`;
        }

        contentEl.innerHTML = `
            <div class="flex flex-col items-center text-center">
                <img src="${user.photoUrl || 'https://placehold.co/96x96/f472b6/ffffff?text='+initials(user.name)}" class="h-24 w-24 rounded-full object-cover bg-gray-200 ring-4 ring-white shadow-md">
                <h4 class="mt-4 text-2xl font-bold">${user.name}</h4>
                <p class="text-gray-500">@${user.username}</p>
                <div class="mt-2 flex gap-4 text-sm">
                    <button class="hover:underline ${!canViewDetails ? 'pointer-events-none text-gray-400' : ''}" data-action="view-follow-list" data-user-id="${userId}" data-list-type="followers">
                        <strong>${user.followersCount || 0}</strong> seguidores
                    </button>
                    <button class="hover:underline ${!canViewDetails ? 'pointer-events-none text-gray-400' : ''}" data-action="view-follow-list" data-user-id="${userId}" data-list-type="following">
                        <strong>${user.followingCount || 0}</strong> seguindo
                    </button>
                </div>
                ${user.bio ? `<p class="mt-3 max-w-md text-gray-600">${user.bio}</p>` : ''}
                <div id="profile-action-buttons" class="w-full">${actionButtonsHTML}</div>
            </div>
            ${detailsHTML}`;

        if (!isOwnProfile) {
            const followBtn = $('#profile-follow-btn');
            if (followBtn) followBtn.addEventListener('click', () => toggleFollow(userId, followBtn));
            
            const acceptBtn = contentEl.querySelector('[data-profile-accept-request]');
            if (acceptBtn) acceptBtn.addEventListener('click', () => handleFollowRequest(userId, true, '#profile-request-banner'));
            
            const declineBtn = contentEl.querySelector('[data-profile-decline-request]');
            if (declineBtn) declineBtn.addEventListener('click', () => handleFollowRequest(userId, false, '#profile-request-banner'));

            const removeFollowerBtn = $('#profile-remove-follower-btn');
            if (removeFollowerBtn) removeFollowerBtn.addEventListener('click', () => promptRemoveFollower(userId, true));
        }
        
        contentEl.querySelectorAll('[data-action="view-follow-list"]').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!canViewDetails) return;
                const targetUserId = btn.dataset.userId;
                const listType = btn.dataset.listType;
                openFollowListModal(targetUserId, listType);
            });
        });
    }

    function renderProfileEventList(eventList) {
      if (eventList.length === 0) return '<p class="text-sm text-gray-500">Nenhum evento aqui.</p>';
      return eventList.map(ev => `
        <div class="flex items-center gap-3 p-2 rounded-lg bg-gray-50 ring-subtle cursor-pointer hover:bg-gray-100" data-event-id="${ev._id}">
          <img src="${ev.imageUrls?.[0] || ''}" class="h-12 w-16 rounded-md object-cover">
          <div>
            <div class="font-medium text-sm">${ev.name}</div>
            <div class="text-xs text-gray-500">${fmtDate(ev.date)}</div>
          </div>
        </div>
      `).join('');
    }
    
    document.addEventListener('click', (e) => {
        const card = e.target.closest('[data-event-id]');
        if (card) {
            const eventId = card.dataset.eventId;
            const eventData = state.events.find(ev => (ev._original_id || ev._id) === eventId);
            if (eventData) {
                hide($('#user-profile-modal'));
                document.body.classList.remove('modal-open');
                openViewModal(eventData);
            }
        }
    });

    // ===== Meu Perfil (Salvar & Upload/Remover Foto) =====
    $('#account-photo-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('image/')) return;
        
        state.photoRemovalFlag = false; // Desmarca a remoção se uma nova foto for escolhida
        const previewEl = $('#account-photo-preview');
        previewEl.src = URL.createObjectURL(file);
        
        const user = auth.currentUser;
        if (!user) return;

        const filePath = `profile-pictures/${user.uid}/${Date.now()}-${file.name}`;
        const storageRef = ref(storage, filePath);
        const uploadTask = uploadBytesResumable(storageRef, file);
        
        toast('Enviando nova foto...', 'info');

        uploadTask.on('state_changed', null, 
            (error) => {
                console.error("Profile photo upload error:", error);
                toast('Erro ao enviar a foto.', 'error');
                previewEl.src = state.currentUserData?.photoUrl || `https://placehold.co/64x64/f472b6/ffffff?text=${initials(state.currentUserData.name)}`;
            },
            async () => {
                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                state.newProfilePhotoUrl = downloadURL;
                toast('Foto pronta para salvar.');
            }
        );
    });

    $('#btn-remove-photo').addEventListener('click', () => {
        state.photoRemovalFlag = true;
        state.newProfilePhotoUrl = null; // Cancela qualquer upload pendente
        $('#account-photo-preview').src = `https://placehold.co/64x64/f472b6/ffffff?text=${initials(state.currentUserData.name)}`;
        toast('A foto será removida ao salvar.', 'info');
    });

    $('#account-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return;

      const name = $('#account-name').value.trim();
      const bio = $('#account-bio').value.trim();
      const isPrivate = $('#account-private').checked;
      const errEl = $('#account-error');
      hide(errEl);

      const updateData = { name, bio, isPrivate };
      if (state.photoRemovalFlag) {
          updateData.photoUrl = null;
      } else if (state.newProfilePhotoUrl) {
          updateData.photoUrl = state.newProfilePhotoUrl;
      }

      try {
        await updateDoc(doc(db, USERS_PATH, user.uid), updateData);
        if (updateData.photoUrl !== undefined) { // Se photoUrl foi modificado (adicionado ou removido)
            await updateProfile(user, { photoURL: updateData.photoUrl });
        }
        await updateProfile(user, { displayName: name });
        
        toast('Perfil atualizado com sucesso!');
        state.newProfilePhotoUrl = null;
        state.photoRemovalFlag = false;
      } catch (err) {
        errEl.textContent = 'Falha ao atualizar o perfil.';
        show(errEl);
      }
    });

    // ===== Social: Lista de amigos que vão no evento =====
    async function renderFriendsGoing(eventId) {
        const container = $('#friends-going-container');
        const button = $('#friends-going-button');
        const modalContent = $('#friends-list-content');
        hide(container);
        button.innerHTML = '';
        modalContent.innerHTML = '';

        if (state.userFollowing.size === 0) return;

        const attendeesSnap = await getDocs(collection(db, `${EVENTS_PATH}/${eventId}/attendees`));
        const attendeeIds = new Set(attendeesSnap.docs.map(d => d.id));
        
        const friendsGoing = Array.from(state.userFollowing).filter(friendId => attendeeIds.has(friendId));

        if (friendsGoing.length > 0) {
            const count = friendsGoing.length;
            button.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                <span>${count} amigo${count > 1 ? 's' : ''} ${count > 1 ? 'vão' : 'vai'}</span>
            `;
            
            friendsGoing.forEach(friendId => {
                const friendData = state.users[friendId];
                if (friendData) {
                    const userCard = document.createElement('div');
                    userCard.className = 'flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50';
                    userCard.innerHTML = `
                        <img src="${friendData.photoUrl || `https://placehold.co/40x40/f472b6/ffffff?text=${initials(friendData.name)}`}" class="h-10 w-10 rounded-full object-cover">
                        <div>
                            <div class="font-semibold text-sm">${friendData.name}</div>
                            <div class="text-xs text-gray-500">@${friendData.username}</div>
                        </div>
                    `;
                    userCard.addEventListener('click', () => {
                        hide($('#event-view'));
                        hide($('#friends-list-modal'));
                        openUserProfileModal(friendId);
                    });
                    modalContent.appendChild(userCard);
                }
            });

            button.onclick = () => show($('#friends-list-modal'));
            show(container);
        }
    }

    // ===== Sistema de Notificações =====
    $('#account-notify-check').addEventListener('change', async (e) => {
        const user = auth.currentUser;
        if (!user) return;
        try {
            await updateDoc(doc(db, USERS_PATH, user.uid), { 'settings.notifyOnFriendGoing': e.target.checked });
        } catch {
            toast('Erro ao salvar configuração.', 'error');
        }
    });

    $('#clear-all-notifs-btn').addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) return;
        const notifsRef = collection(db, `artifacts/${appId}/users/${user.uid}/notifications`);
        const notifsSnap = await getDocs(notifsRef);
        if (notifsSnap.empty) return;

        const batch = writeBatch(db);
        notifsSnap.forEach(doc => batch.delete(doc.ref));
        try {
            await batch.commit();
            toast('Notificações limpas.');
        } catch {
            toast('Erro ao limpar notificações.', 'error');
        }
    });

    async function notifyFollowersOfGoing(userId, eventId) {
        const followersSnap = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/followers`));
        if (followersSnap.empty) return;
        
        const eventData = state.events.find(e => e._id === eventId);
        if (!eventData) return;

        for (const followerDoc of followersSnap.docs) {
            const followerId = followerDoc.id;
            const followerData = state.users[followerId];
            
            if (followerData?.settings?.notifyOnFriendGoing ?? true) {
                const notificationRef = doc(collection(db, `artifacts/${appId}/users/${followerId}/notifications`));
                await setDoc(notificationRef, {
                    type: 'event_going',
                    fromUserId: userId,
                    eventId: eventId,
                    eventName: eventData.name,
                    timestamp: serverTimestamp(),
                    read: false
                });
            }
        }
    }
    
    async function handleFollowRequest(requesterId, accept, bannerSelector = null) {
        const currentUser = auth.currentUser;
        if (!currentUser) return;
        
        const banner = bannerSelector ? $(bannerSelector) : null;
        if (banner) {
            banner.innerHTML = `<p class="text-sm font-medium">Processando...</p>`;
        }

        const batch = writeBatch(db);
        
        const outgoingRequestRef = doc(db, `artifacts/${appId}/users/${requesterId}/outgoingFollowRequests`, currentUser.uid);
        const incomingRequestRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/followRequests`, requesterId);
        const notificationRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/notifications`, `follow_request_${requesterId}`);
        
        batch.delete(outgoingRequestRef);
        batch.delete(incomingRequestRef);

        if (accept) {
            batch.update(notificationRef, { type: 'new_follower' }); 
            
            const followingRef = doc(db, `artifacts/${appId}/users/${requesterId}/following`, currentUser.uid);
            const followerRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/followers`, requesterId);
            batch.set(followingRef, { followedAt: serverTimestamp() });
            batch.set(followerRef, { followerAt: serverTimestamp() });
            
            const requesterUserRef = doc(db, USERS_PATH, requesterId);
            const currentUserRef = doc(db, USERS_PATH, currentUser.uid);
            batch.update(requesterUserRef, { followingCount: increment(1) });
            batch.update(currentUserRef, { followersCount: increment(1) });
            
            const acceptedNotificationRef = doc(db, `artifacts/${appId}/users/${requesterId}/notifications`, `request_accepted_${currentUser.uid}`);
            batch.set(acceptedNotificationRef, { type: 'request_accepted', fromUserId: currentUser.uid, timestamp: serverTimestamp(), read: false });
        } else {
            batch.update(notificationRef, { type: 'request_declined' });
        }
        
        try {
            await batch.commit();
            if (banner) {
                 banner.innerHTML = `<p class="text-sm font-medium text-emerald-700">Solicitação ${accept ? 'aceita' : 'recusada'}!</p>`;
                 setTimeout(() => openUserProfileModal(requesterId), 1000); 
            }
        } catch (err) {
            console.error("Erro ao processar solicitação:", err);
            toast("Erro ao processar solicitação.", 'error');
            if (banner) banner.innerHTML = `<p class="text-sm font-medium text-red-700">Ocorreu um erro.</p>`;
        }
    }

    function renderNotifications(notifications) {
        const listEl = $('#notifications-list');
        const emptyEl = $('#empty-notifications');
        const badgeEl = $('#notifications-badge');
        listEl.innerHTML = '';

        // Mostrar/esconder badge baseado em notificações não lidas
        const hasUnreadNotifications = notifications.some(notif => !notif.read);
        if (hasUnreadNotifications) {
            show(badgeEl);
        } else {
            hide(badgeEl);
        }

        if (notifications.length === 0) {
            show(emptyEl);
            return;
        }
        hide(emptyEl);
        
        // Expandir automaticamente se há notificações
        setTimeout(() => {
            expandNotificationsIfNew();
        }, 100);

        notifications.forEach(notif => {
            const fromUser = state.users[notif.fromUserId];
            if (!fromUser) return;

            const el = document.createElement('div');
            el.className = 'notification-item rounded-2xl bg-white hover:bg-gray-50/80';
            
            let contentHTML = '';
            const isFollowingBack = state.userFollowing.has(notif.fromUserId);
            const hasPending = state.userOutgoingRequests.has(notif.fromUserId);
            
            let btnText, btnClass;
            if (isFollowingBack) {
              btnText = 'Seguindo';
              btnClass = 'bg-gray-200 text-gray-800';
            } else if (hasPending) {
              btnText = 'Solicitado';
              btnClass = 'bg-gray-100 text-gray-600 ring-1 ring-gray-200';
            } else {
              btnText = 'Seguir';
              btnClass = 'bg-pink-600 text-white';
            }

            const followButtonHTML = `<button class="rounded-full px-3 py-1.5 text-xs font-semibold ${btnClass}" data-follow-id="${fromUser.id}">${btnText}</button>`;

            if (notif.type === 'new_follower') {
                contentHTML = `
                  <img src="${fromUser.photoUrl || `https://placehold.co/40x40/f472b6/ffffff?text=${initials(fromUser.name)}`}" class="h-10 w-10 rounded-full object-cover cursor-pointer" data-profile-id="${fromUser.id}">
                  <div class="flex-1 text-sm cursor-pointer" data-profile-id="${fromUser.id}">
                    <span class="font-semibold">${fromUser.name}</span> começou a seguir você.
                  </div>
                  <div class="ml-auto flex-shrink-0">${followButtonHTML}</div>`;
            } else if (notif.type === 'event_going') {
                contentHTML = `
                  <img src="${fromUser.photoUrl || `https://placehold.co/40x40/f472b6/ffffff?text=${initials(fromUser.name)}`}" class="h-10 w-10 rounded-full object-cover cursor-pointer" data-profile-id="${fromUser.id}">
                  <div class="flex-1 text-sm">
                    <span class="font-semibold">${fromUser.name}</span> confirmou presença em <strong class="cursor-pointer hover:underline" data-event-id="${notif.eventId}">${notif.eventName || 'um evento'}</strong>.
                  </div>`;
            } else if (notif.type === 'follow_request') {
                contentHTML = `
                  <img src="${fromUser.photoUrl || `https://placehold.co/40x40/f472b6/ffffff?text=${initials(fromUser.name)}`}" class="h-10 w-10 rounded-full object-cover cursor-pointer" data-profile-id="${fromUser.id}">
                  <div class="flex-1 text-sm cursor-pointer" data-profile-id="${fromUser.id}">
                    <span class="font-semibold">${fromUser.name}</span> quer seguir você.
                  </div>
                  <div class="ml-auto flex gap-2 flex-shrink-0">
                    <button class="rounded-full bg-emerald-600 text-white px-3 py-1.5 text-xs font-semibold" data-accept-request="${fromUser.id}">Aceitar</button>
                    <button class="rounded-full bg-gray-200 text-gray-800 px-3 py-1.5 text-xs font-semibold" data-decline-request="${fromUser.id}">Recusar</button>
                  </div>`;
            } else if (notif.type === 'request_accepted') {
                 contentHTML = `
                  <img src="${fromUser.photoUrl || `https://placehold.co/40x40/f472b6/ffffff?text=${initials(fromUser.name)}`}" class="h-10 w-10 rounded-full object-cover cursor-pointer" data-profile-id="${fromUser.id}">
                  <div class="flex-1 text-sm cursor-pointer" data-profile-id="${fromUser.id}">
                    <span class="font-semibold">${fromUser.name}</span> aceitou sua solicitação para seguir.
                  </div>`;
            } else if (notif.type === 'request_declined') {
                 contentHTML = `
                  <img src="${fromUser.photoUrl || `https://placehold.co/40x40/f472b6/ffffff?text=${initials(fromUser.name)}`}" class="h-10 w-10 rounded-full object-cover cursor-pointer" data-profile-id="${fromUser.id}">
                  <div class="flex-1 text-sm cursor-pointer" data-profile-id="${fromUser.id}">
                    Você recusou a solicitação de <span class="font-semibold">${fromUser.name}</span>.
                  </div>
                  <div class="ml-auto flex-shrink-0">${followButtonHTML}</div>`;
            }
            
            el.innerHTML = `
                <div class="delete-background">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </div>
                <div class="notification-content flex items-center gap-3 p-3 rounded-2xl ring-1 ring-gray-100">
                    ${contentHTML}
                </div>
            `;
            
            const followBtn = el.querySelector(`[data-follow-id]`);
            if(followBtn) followBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleFollow(notif.fromUserId, followBtn); });
            
            el.querySelectorAll(`[data-profile-id]`).forEach(p => p.addEventListener('click', (e) => { e.stopPropagation(); openUserProfileModal(notif.fromUserId); }));
            
            const eventLink = el.querySelector(`[data-event-id]`);
            if (eventLink) eventLink.addEventListener('click', (e) => {
                e.stopPropagation();
                const eventData = state.events.find(ev => ev._id === notif.eventId);
                if (eventData) openViewModal(eventData);
            });
            
            const acceptBtn = el.querySelector('[data-accept-request]');
            if (acceptBtn) acceptBtn.addEventListener('click', (e) => { e.stopPropagation(); handleFollowRequest(notif.fromUserId, true); });

            const declineBtn = el.querySelector('[data-decline-request]');
            if (declineBtn) declineBtn.addEventListener('click', (e) => { e.stopPropagation(); handleFollowRequest(notif.fromUserId, false); });

            addSwipeToDelete(el, notif.id);

            listEl.appendChild(el);
        });
    }
    
    async function confirmNotificationDeletion() {
        if (!state.deleteNotificationTarget) return;

        const { id, element } = state.deleteNotificationTarget;
        const user = auth.currentUser;
        if (!user) return;

        element.classList.add('deleting');
        
        hide($('#delete-notification-modal'));

        try {
            const notifRef = doc(db, `artifacts/${appId}/users/${user.uid}/notifications`, id);
            await deleteDoc(notifRef);
            toast('Notificação excluída.', 'success');
        } catch (err) {
            console.error("Erro ao apagar notificação:", err);
            toast('Erro ao apagar notificação.', 'error');
            element.classList.remove('deleting');
        } finally {
            state.deleteNotificationTarget = null;
        }
    }
    $('#delete-notification-confirm-btn').addEventListener('click', confirmNotificationDeletion);


    function addSwipeToDelete(element, notificationId) {
        let startX = 0;
        let currentX = 0;
        let isDragging = false;
        let hasMovedEnough = false; 
        const clickThreshold = 5; 
        const deleteThreshold = -100; 
        const content = element.querySelector('.notification-content');

        const onDragStart = (clientX) => {
            isDragging = true;
            hasMovedEnough = false;
            startX = clientX;
            element.classList.add('swiping');
        };

        const onDragMove = (clientX) => {
            if (!isDragging) return;
            currentX = clientX - startX;
            
            if (Math.abs(currentX) > clickThreshold) {
                hasMovedEnough = true;
            }

            if (currentX > 0) currentX = 0; 
            content.style.transform = `translateX(${currentX}px)`;
        };

        const onDragEnd = async () => {
            if (!isDragging) return;
            isDragging = false;
            element.classList.remove('swiping');

            if (hasMovedEnough) {
                if (currentX < deleteThreshold) {
                    state.deleteNotificationTarget = { id: notificationId, element: element };
                    show($('#delete-notification-modal'));
                    content.style.transform = 'translateX(0)';
                } else {
                    content.style.transform = 'translateX(0)';
                }
            } else {
                content.style.transform = 'translateX(0)';
            }
        };

        content.addEventListener('mousedown', (e) => onDragStart(e.clientX));
        document.addEventListener('mousemove', (e) => onDragMove(e.clientX));
        document.addEventListener('mouseup', onDragEnd);

        content.addEventListener('touchstart', (e) => onDragStart(e.touches[0].clientX), { passive: true });
        content.addEventListener('touchmove', (e) => onDragMove(e.touches[0].clientX), { passive: true });
        content.addEventListener('touchend', onDragEnd);
    }
    
    // ===== Meu Perfil: Abas Seguidores/Seguindo =====
    $$('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tab = btn.dataset.tab;
            $$('.tab-btn').forEach(b => {
                b.classList.remove('border-pink-600', 'text-pink-600');
                b.classList.add('border-transparent', 'text-gray-500');
            });
            btn.classList.add('border-pink-600', 'text-pink-600');
            btn.classList.remove('border-transparent', 'text-gray-500');

            if (tab === 'followers') {
                show($('#followers-list'));
                hide($('#following-list'));
            } else {
                hide($('#followers-list'));
                show($('#following-list'));
            }
        });
    });

    async function loadFollowLists() {
        const user = auth.currentUser;
        if (!user) return;
        const followersListEl = $('#followers-list');
        const followingListEl = $('#following-list');
        followersListEl.innerHTML = 'Carregando...';
        followingListEl.innerHTML = 'Carregando...';

        const followersSnap = await getDocs(collection(db, `artifacts/${appId}/users/${user.uid}/followers`));
        if (followersSnap.empty) {
            followersListEl.innerHTML = '<p class="text-sm text-gray-500">Nenhum seguidor ainda.</p>';
        } else {
            followersListEl.innerHTML = '';
            followersSnap.forEach(doc => {
                const followerUser = state.users[doc.id];
                if (followerUser) followersListEl.appendChild(createFollowUserCard(followerUser, 'follower'));
            });
        }

        const followingSnap = await getDocs(collection(db, `artifacts/${appId}/users/${user.uid}/following`));
        if (followingSnap.empty) {
            followingListEl.innerHTML = '<p class="text-sm text-gray-500">Você não segue ninguém ainda.</p>';
        } else {
            followingListEl.innerHTML = '';
            followingSnap.forEach(doc => {
                const followingUser = state.users[doc.id];
                if (followingUser) followingListEl.appendChild(createFollowUserCard(followingUser, 'following'));
            });
        }
    }

    function createFollowUserCard(userData, type) {
        const el = document.createElement('div');
        el.className = 'flex items-center gap-3';
        
        let buttonHTML = '';
        if (type === 'follower') {
            buttonHTML = `<button class="ml-auto rounded-full border border-gray-300 px-3 py-1.5 text-xs font-semibold" data-remove-follower-id="${userData.id}">Remover</button>`;
        } else { // following
            buttonHTML = `<button class="ml-auto rounded-full bg-gray-200 px-3 py-1.5 text-xs font-semibold" data-unfollow-id="${userData.id}">Seguindo</button>`;
        }

        el.innerHTML = `
            <div class="flex-1 flex items-center gap-3 cursor-pointer" data-profile-id="${userData.id}">
                <img src="${userData.photoUrl || `https://placehold.co/40x40/f472b6/ffffff?text=${initials(userData.name)}`}" class="h-10 w-10 rounded-full object-cover">
                <div>
                    <div class="font-semibold text-sm">${userData.name}</div>
                    <div class="text-xs text-gray-500">@${userData.username}</div>
                </div>
            </div>
            ${buttonHTML}
        `;

        el.querySelector('[data-profile-id]').addEventListener('click', () => openUserProfileModal(userData.id));
        const removeBtn = el.querySelector('[data-remove-follower-id]');
        if (removeBtn) removeBtn.addEventListener('click', () => promptRemoveFollower(userData.id));
        
        const unfollowBtn = el.querySelector('[data-unfollow-id]');
        if (unfollowBtn) unfollowBtn.addEventListener('click', () => {
            toggleFollow(userData.id);
            el.remove(); // Optimistic removal from list
        });

        return el;
    }

    // ===== Social: Modal de Lista de Seguidores/Seguindo (Público) =====
    async function openFollowListModal(targetUserId, listType) {
        const modal = $('#follow-list-modal');
        const titleEl = $('#follow-list-title');
        const contentEl = $('#follow-list-content');

        titleEl.textContent = listType === 'followers' ? 'Seguidores' : 'Seguindo';
        contentEl.innerHTML = '<div class="text-center text-gray-500 py-4">Carregando...</div>';
        show(modal);

        try {
            const collectionRef = collection(db, `artifacts/${appId}/users/${targetUserId}/${listType}`);
            const listSnap = await getDocs(collectionRef);

            if (listSnap.empty) {
                contentEl.innerHTML = `<div class="text-center text-gray-500 py-4">${listType === 'followers' ? 'Nenhum seguidor.' : 'Não segue ninguém.'}</div>`;
                return;
            }

            contentEl.innerHTML = ''; // Clear loading
            listSnap.docs.forEach(doc => {
                const userId = doc.id;
                const userData = state.users[userId];
                if (userData) {
                    const userCard = createPublicFollowUserCard(userData);
                    contentEl.appendChild(userCard);
                }
            });
        } catch (err) {
            console.error(`Erro ao carregar lista de ${listType}:`, err);
            contentEl.innerHTML = '<div class="text-center text-red-500 py-4">Erro ao carregar a lista.</div>';
        }
    }

    function createPublicFollowUserCard(userData) {
        const el = document.createElement('div');
        el.className = 'flex items-center gap-3 p-2 rounded-xl';
        
        const currentUserId = auth.currentUser?.uid;
        const isCurrentUserInList = currentUserId === userData.id;
        
        let buttonHTML = '';
        if (!isCurrentUserInList && currentUserId) {
            const isFollowing = state.userFollowing.has(userData.id);
            const hasRequested = state.userOutgoingRequests.has(userData.id);
            
            let btnClass, btnText;
            if (isFollowing) {
                btnClass = 'bg-gray-200 text-gray-800';
                btnText = 'Seguindo';
            } else if (hasRequested) {
                btnClass = 'bg-gray-100 text-gray-600 border border-gray-300';
                btnText = 'Solicitado';
            } else {
                btnClass = 'bg-pink-600 text-white';
                btnText = 'Seguir';
            }
            buttonHTML = `<button class="ml-auto rounded-full px-4 py-2 text-xs font-semibold ${btnClass}" data-follow-id="${userData.id}">${btnText}</button>`;
        }

        el.innerHTML = `
            <div class="flex-1 flex items-center gap-3 cursor-pointer" data-profile-id="${userData.id}">
                <img src="${userData.photoUrl || `https://placehold.co/40x40/f472b6/ffffff?text=${initials(userData.name)}`}" class="h-10 w-10 rounded-full object-cover">
                <div>
                    <div class="font-semibold text-sm">${userData.name}</div>
                    <div class="text-xs text-gray-500">@${userData.username}</div>
                </div>
            </div>
            ${buttonHTML}
        `;

        el.querySelector('[data-profile-id]').addEventListener('click', () => {
            hide($('#follow-list-modal'));
            openUserProfileModal(userData.id);
        });
        
        const followBtn = el.querySelector('[data-follow-id]');
        if (followBtn) {
            followBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFollow(userData.id, followBtn);
            });
        }

        return el;
    }
    
    // ===== Admin: Eventos Recorrentes =====
   $('#recurring-event-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!ensureAdmin()) return;
        const nameInput = $('#recurring-event-name');
        const name = nameInput.value.trim();
        const errEl = $('#recurring-event-error');
        hide(errEl);

        if (!name) {
            errEl.textContent = 'O nome não pode estar vazio.';
            show(errEl);
            return;
        }

        try {
            if (state.editingRecurringEventId) {
                await updateDoc(doc(db, RECURRING_EVENTS_PATH, state.editingRecurringEventId), { name });
                toast('Evento recorrente atualizado!');
            } else {
                await addDoc(collection(db, RECURRING_EVENTS_PATH), { name, ratingCount: 0, totalRatingSum: 0 });
                toast('Evento recorrente adicionado!');
            }
            state.editingRecurringEventId = null;
            nameInput.value = '';
        } catch (err) {
            console.error(err);
            errEl.textContent = 'Erro ao salvar.';
            show(errEl);
        }
    });

    function renderRecurringEventsAdmin() {
        const listEl = $('#recurring-events-list');
        listEl.innerHTML = '';
        if (state.recurringEvents.length === 0) {
            listEl.innerHTML = '<div class="py-3 text-sm text-gray-500">Nenhum evento recorrente cadastrado.</div>';
            return;
        }
        state.recurringEvents.forEach(rev => {
            const el = document.createElement('div');
            el.className = 'py-3 flex items-center justify-between';
            el.innerHTML = `
                <span class="font-medium">${rev.name}</span>
                <div class="flex items-center gap-2">
                    <button class="rounded-full border border-gray-200 bg-white px-3 py-1.5 text-xs font-semibold hover:bg-gray-50" data-edit-id="${rev.id}">Editar</button>
                    <button class="rounded-full border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-semibold text-red-700 hover:bg-red-100" data-delete-id="${rev.id}">Excluir</button>
                    <button class="h-8 w-8 inline-flex items-center justify-center rounded-full border border-yellow-300 bg-yellow-50 text-yellow-700 hover:bg-yellow-100" title="Zerar Avaliações" data-reset-ratings-id="${rev.id}" data-reset-ratings-name="${rev.name}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
            `;
            el.querySelector('[data-edit-id]').addEventListener('click', () => {
                $('#recurring-event-name').value = rev.name;
                state.editingRecurringEventId = rev.id;
            });
            el.querySelector('[data-delete-id]').addEventListener('click', async () => {
                if (ensureAdmin() && confirm(`Tem certeza que quer excluir "${rev.name}"? Esta ação não pode ser desfeita.`)) {
                    await (function(){ 
        if (!confirm('Tem certeza que deseja apagar este evento? Essa ação não pode ser desfeita.')) return Promise.resolve(); 
        return deleteDoc(doc(db, RECURRING_EVENTS_PATH, rev.id)); 
    })();
                    toast('Excluído com sucesso.');
                }
            });
            el.querySelector('[data-reset-ratings-id]').addEventListener('click', (e) => {
                if (!ensureAdmin()) return;
                const button = e.currentTarget;
                state.resetRatingsTarget = {
                    id: button.dataset.resetRatingsId,
                    name: button.dataset.resetRatingsName
                };
                $('#reset-ratings-name').textContent = state.resetRatingsTarget.name;
                show($('#reset-ratings-modal'));
            });
            listEl.appendChild(el);
        });
    }
    
    $('#reset-ratings-confirm-btn').addEventListener('click', async () => {
        if (!state.resetRatingsTarget) return;
        const { id, name } = state.resetRatingsTarget;
        if (!ensureAdmin()) return;
        
        try {
            const ratingsCollectionRef = collection(db, RECURRING_EVENTS_PATH, id, 'ratings');
            const ratingsSnapshot = await getDocs(ratingsCollectionRef);
            
            const batch = writeBatch(db);
            
            ratingsSnapshot.forEach(ratingDoc => {
                batch.delete(ratingDoc.ref);
            });
            
            const recurringEventRef = doc(db, RECURRING_EVENTS_PATH, id);
            batch.update(recurringEventRef, {
                ratingCount: 0,
                totalRatingSum: 0
            });
            
            await batch.commit();
            toast(`Avaliações para "${name}" foram zeradas.`);
        } catch (err) {
            console.error("Erro ao zerar avaliações:", err);
            toast("Falha ao zerar avaliações.", 'error');
        } finally {
            hide($('#reset-ratings-modal'));
            state.resetRatingsTarget = null;
        }
    });

    function populateRecurringEventsDropdown() {
        const selects = ['#ev-recurring', '#org-ev-recurring'];
        selects.forEach(selId => {
            const select = $(selId);
            if (!select) return;
            const currentVal = select.value;
            select.innerHTML = '<option value="">Nenhum</option>';
            state.recurringEvents.forEach(rev => {
                const option = document.createElement('option');
                option.value = rev.id;
                option.textContent = rev.name;
                select.appendChild(option);
            });
            select.value = currentVal;
        });
    }

    // ===== Sistema de Avaliação (Rating) =====
    async function renderRatingSection(recurringEventId) {
        const displayContainer = $('#view-rating-display-container');
        const inputContainer = $('#view-rating-input-container');
        hide(displayContainer);
        hide(inputContainer);

        if (!recurringEventId) return;

        const recurringEvent = state.recurringEvents.find(r => r.id === recurringEventId);
        if (!recurringEvent) return;

        // Display de Média
        const { ratingCount = 0, totalRatingSum = 0 } = recurringEvent;
        const average = ratingCount > 0 ? (totalRatingSum / ratingCount).toFixed(1) : 0;
        
        let starsHTML = '';
        for (let i = 1; i <= 5; i++) {
            let starClass = 'text-gray-300';
            if (average >= i) starClass = 'text-yellow-400';
            else if (average >= i - 0.5) starClass = 'text-yellow-400';
            starsHTML += `<svg class="w-5 h-5 ${starClass}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
        }

        displayContainer.innerHTML = `
            <div class="text-sm text-gray-500">Avaliação do Local</div>
            <div class="flex items-center gap-2 mt-1">
                <div class="flex">${starsHTML}</div>
                <div class="text-lg font-semibold">${average}</div>
                <div class="text-sm text-gray-500">(${ratingCount} avaliações)</div>
            </div>
        `;
        show(displayContainer);

        // Input do Usuário
        const user = auth.currentUser;
        if (!user || user.isAnonymous) return;

        const ratingDocRef = doc(db, `${RECURRING_EVENTS_PATH}/${recurringEventId}/ratings`, user.uid);
        const ratingDoc = await getDoc(ratingDocRef);
        const currentUserRating = ratingDoc.exists() ? ratingDoc.data().rating : 0;
        
        inputContainer.innerHTML = `
            <div class="text-sm font-medium text-gray-700 mb-2">${currentUserRating > 0 ? 'Sua avaliação:' : 'Avalie este local:'}</div>
            <div class="flex items-center gap-2">
                <div class="star-rating flex flex-row-reverse justify-end items-center" data-recurring-id="${recurringEventId}">
                    <input type="radio" id="star5" name="rating" value="5" ${currentUserRating == 5 ? 'checked' : ''} /><label for="star5">★</label>
                    <input type="radio" id="star4" name="rating" value="4" ${currentUserRating == 4 ? 'checked' : ''} /><label for="star4">★</label>
                    <input type="radio" id="star3" name="rating" value="3" ${currentUserRating == 3 ? 'checked' : ''} /><label for="star3">★</label>
                    <input type="radio" id="star2" name="rating" value="2" ${currentUserRating == 2 ? 'checked' : ''} /><label for="star2">★</label>
                    <input type="radio" id="star1" name="rating" value="1" ${currentUserRating == 1 ? 'checked' : ''} /><label for="star1">★</label>
                </div>
                ${currentUserRating > 0 ? `<button id="remove-rating-btn" class="flex items-center justify-center h-7 w-7 rounded-full bg-gray-200 text-gray-600 hover:bg-red-100 hover:text-red-600 transition-colors text-xs">✕</button>` : ''}
            </div>
        `;
        show(inputContainer);

        inputContainer.querySelectorAll('input[name="rating"]').forEach(radio => {
            radio.addEventListener('change', async (e) => {
                const newRating = parseInt(e.target.value);
                await submitRating(recurringEventId, newRating, currentUserRating);
            });
        });
        
        const removeBtn = inputContainer.querySelector('#remove-rating-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', () => {
                removeRating(recurringEventId, currentUserRating);
            });
        }
    }

    async function submitRating(recurringEventId, newRating, oldRating) {
        const user = auth.currentUser;
        if (!user || user.isAnonymous) return openLogin();
        
        const recurringEventRef = doc(db, RECURRING_EVENTS_PATH, recurringEventId);
        const ratingRef = doc(db, `${RECURRING_EVENTS_PATH}/${recurringEventId}/ratings`, user.uid);

        try {
            await runTransaction(db, async (transaction) => {
                const recurringEventDoc = await transaction.get(recurringEventRef);
                if (!recurringEventDoc.exists()) throw "Evento recorrente não existe!";
                
                const isNewRating = oldRating === 0;
                const ratingDiff = newRating - oldRating;

                const newCount = isNewRating ? increment(1) : increment(0);
                const newSum = increment(ratingDiff);

                transaction.set(ratingRef, { rating: newRating, updatedAt: serverTimestamp() }, { merge: true });
                transaction.update(recurringEventRef, {
                    ratingCount: newCount,
                    totalRatingSum: newSum
                });
            });
            toast('Avaliação enviada, obrigado!');
            if (state.currentViewEvent) {
                renderRatingSection(state.currentViewEvent.recurringEventId);
            }
        } catch (error) {
            console.error("Erro ao enviar avaliação: ", error);
            toast('Não foi possível enviar sua avaliação.', 'error');
        }
    }
    
    async function removeRating(recurringEventId, ratingToRemove) {
        const user = auth.currentUser;
        if (!user || user.isAnonymous) return;

        const recurringEventRef = doc(db, RECURRING_EVENTS_PATH, recurringEventId);
        const ratingRef = doc(db, `${RECURRING_EVENTS_PATH}/${recurringEventId}/ratings`, user.uid);

        try {
            await runTransaction(db, async (transaction) => {
                const ratingDoc = await transaction.get(ratingRef);
                if (!ratingDoc.exists()) return; 

                transaction.update(recurringEventRef, {
                    ratingCount: increment(-1),
                    totalRatingSum: increment(-ratingToRemove)
                });
                transaction.delete(ratingRef);
            });
            toast('Avaliação removida.');
            if (state.currentViewEvent) {
                renderRatingSection(state.currentViewEvent.recurringEventId);
            }
        } catch (error) {
            console.error("Erro ao remover avaliação: ", error);
            toast('Não foi possível remover sua avaliação.', 'error');
        }
    }

    // ===== Admin: Configurações Gerais =====
    $('#general-settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!ensureAdmin()) return;
        const whatsappLink = $('#whatsapp-link-input').value.trim();
        try {
            await setDoc(doc(db, SETTINGS_PATH, 'global'), { whatsappLink }, { merge: true });
            toast('Configurações salvas com sucesso!');
        } catch (err) {
            console.error("Erro ao salvar configurações:", err);
            toast('Falha ao salvar as configurações.', 'error');
        }
    });


    // ===== Aux =====
    function mapAuthErr(err){ const c=String(err?.code||''); if(c.includes('auth/invalid-email')) return 'E-mail inválido.'; if(c.includes('auth/user-not-found')) return 'Usuário não encontrado.'; if(c.includes('auth/wrong-password')) return 'Senha incorreta.'; if(c.includes('auth/email-already-in-use')) return 'E-mail já cadastrado.'; if(c.includes('auth/weak-password')) return 'A senha precisa ter no mínimo 6 caracteres.'; return 'Falha de autenticação.'; }
  
    // ======= Bairros & Gêneros (Taxonomias) + Filtros =======
    const BAIRROS_PATH = `artifacts/${appId}/public/data/bairros`;
    const GENEROS_PATH = `artifacts/${appId}/public/data/generos`;
    state.bairros = [];
    state.generos = [];
    state.selectedBairros = new Set();
    state.selectedGeneros = new Set();

    // Observers para listas
    onSnapshot(collection(db, BAIRROS_PATH), (snap)=>{
      state.bairros = snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      updateTaxonomyUIs();
    });
    onSnapshot(collection(db, GENEROS_PATH), (snap)=>{
      state.generos = snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      updateTaxonomyUIs();
    });

    // UI chips + selects
    function el(tag, cls='', html=''){ const e=document.createElement(tag); if(cls) e.className=cls; if(html) e.innerHTML=html; return e; }
    function updateTaxonomyUIs(){
      // Chips (home)
      const chipWrapB = document.getElementById('chips-bairros');
      const chipWrapG = document.getElementById('chips-generos');
      if (chipWrapB) {
        chipWrapB.innerHTML='';
        state.bairros.forEach(b=>{
          const active = state.selectedBairros.has(b.id);
          const btn = el('button', `px-3 py-1.5 rounded-full border text-xs font-semibold ${active?'bg-pink-600 text-white border-pink-600':'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'}`);
          btn.textContent = b.name||'—';
          btn.onclick = ()=>{ 
            if (state.selectedBairros.has(b.id)) state.selectedBairros.delete(b.id); else state.selectedBairros.add(b.id);
            applyFiltersAndRender();
            updateTaxonomyUIs();
          };
          chipWrapB.appendChild(btn);
        });
      }
      if (chipWrapG) {
        chipWrapG.innerHTML='';
        state.generos.forEach(g=>{
          const active = state.selectedGeneros.has(g.id);
          const btn = el('button', `px-3 py-1.5 rounded-full border text-xs font-semibold ${active?'bg-pink-600 text-white border-pink-600':'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'}`);
          btn.textContent = g.name||'—';
          btn.onclick = ()=>{ 
            if (state.selectedGeneros.has(g.id)) state.selectedGeneros.delete(g.id); else state.selectedGeneros.add(g.id);
            applyFiltersAndRender();
            updateTaxonomyUIs();
          };
          chipWrapG.appendChild(btn);
        });
      }

      // Selects (modais)
      const mapOpts = (arr)=> ['<option value="">Selecione...</option>'].concat(arr.map(x=>`<option value="${x.id}">${x.name||'—'}</option>`)).join('');
      const selEvB = document.getElementById('ev-bairro');
      const selEvG = document.getElementById('ev-genero');
      if (selEvB) selEvB.innerHTML = mapOpts(state.bairros);
      if (selEvG) selEvG.innerHTML = mapOpts(state.generos);
      const selOrgB = document.getElementById('org-ev-bairro');
      const selOrgG = document.getElementById('org-ev-genero');
      if (selOrgB) selOrgB.innerHTML = mapOpts(state.bairros);
      if (selOrgG) selOrgG.innerHTML = mapOpts(state.generos);
    }

    // Botão limpar filtros
    const btnClearFilters = document.getElementById('btn-clear-filters');
    if (btnClearFilters){
      btnClearFilters.onclick = ()=>{ state.selectedBairros.clear(); state.selectedGeneros.clear(); applyFiltersAndRender().catch(console.error); updateTaxonomyUIs(); };
    }

    // Patch renderFeed: encaminha com fallback seguro
try {
  if (typeof renderFeed === 'function') {
    // Patch renderFeed: encaminha com fallback seguro
try {
  if (typeof renderFeed === 'function') {
    const _renderFeedOriginal = renderFeed;
    renderFeed = function (filteredEvents) {
      const base = Array.isArray(filteredEvents) ? filteredEvents : ((window.state && Array.isArray(window.state.events)) ? window.state.events : []);
      _renderFeedOriginal(base);
    };
  }
} catch (e) { console.error('Falha ao ajustar renderFeed', e); }

  }
} catch (e) { console.error('Falha ao ajustar renderFeed', e); }


    // Painel Admin (toggle)
    const taxToggle = document.getElementById('toggle-taxonomy-panel');
    if (taxToggle){
      taxToggle.onclick = ()=>{
        const p = document.getElementById('taxonomy-panel');
        if (p) p.classList.toggle('hidden');
      };
    }

    // Ações Admin: adicionar/remover bairros & gêneros
    async function addTaxonomy(path, name){
      if (!ensureAdmin()) return;
      const clean = (name||'').trim();
      if (!clean) return;
      await addDoc(collection(db, path), { name: clean });
      toast('Adicionado com sucesso!');
    }
    async function removeTaxonomy(path, id){
      if (!ensureAdmin()) return;
      await deleteDoc(doc(db, path, id));
      toast('Removido.');
    }

    const bairroForm = document.getElementById('bairro-form');
    if (bairroForm){
      bairroForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const name = (document.getElementById('bairro-name-input')?.value||'').trim();
        if (!name) return;
        try{
          await addTaxonomy(BAIRROS_PATH, name);
          document.getElementById('bairro-name-input').value='';
        }catch(err){ console.error(err); const el=document.getElementById('bairro-error'); if(el){ el.textContent='Falha ao adicionar.'; el.classList.remove('hidden'); } }
      });
    }
    const generoForm = document.getElementById('genero-form');
    if (generoForm){
      generoForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const name = (document.getElementById('genero-name-input')?.value||'').trim();
        if (!name) return;
        try{
          await addTaxonomy(GENEROS_PATH, name);
          document.getElementById('genero-name-input').value='';
        }catch(err){ console.error(err); const el=document.getElementById('genero-error'); if(el){ el.textContent='Falha ao adicionar.'; el.classList.remove('hidden'); } }
      });
    }

    function renderTaxonomyLists(){
      const ulB = document.getElementById('bairro-list');
      const ulG = document.getElementById('genero-list');
      if (ulB){
        ulB.innerHTML='';
        state.bairros.forEach(b=>{
          const li = el('li', 'flex items-center justify-between rounded-xl border border-gray-200 px-3 py-2');
          li.innerHTML = `<span>${b.name||'—'}</span><button class="text-sm text-red-600 hover:underline" data-id="${b.id}" data-tx="bairro">Remover</button>`;
          ulB.appendChild(li);
        });
      }
      if (ulG){
        ulG.innerHTML='';
        state.generos.forEach(g=>{
          const li = el('li', 'flex items-center justify-between rounded-xl border border-gray-200 px-3 py-2');
          li.innerHTML = `<span>${g.name||'—'}</span><button class="text-sm text-red-600 hover:underline" data-id="${g.id}" data-tx="genero">Remover</button>`;
          ulG.appendChild(li);
        });
      }
      // Bind remove actions
      document.querySelectorAll('#bairro-list [data-tx="bairro"]').forEach(btn=>{
        btn.onclick = async ()=>{ try{ await removeTaxonomy(BAIRROS_PATH, btn.dataset.id); }catch(e){ console.error(e) } };
      });
      document.querySelectorAll('#genero-list [data-tx="genero"]').forEach(btn=>{
        btn.onclick = async ()=>{ try{ await removeTaxonomy(GENEROS_PATH, btn.dataset.id); }catch(e){ console.error(e) } };
      });
    }

    // Atualiza listas quando taxonomias mudarem
    const _updateTaxonomyUIsRef = updateTaxonomyUIs;
    updateTaxonomyUIs = function(){ _updateTaxonomyUIsRef(); renderTaxonomyLists(); };

    // Preenche selects quando abrir modal de evento
    const _openEventModalOriginal = openEventModal;
    openEventModal = function(mode='create', ev=null){
      _openEventModalOriginal(mode, ev);
      // Tente pré-selecionar valores existentes
      setTimeout(()=>{
        const isOrg = mode.startsWith('org-');
        const selB = document.getElementById(isOrg ? 'org-ev-bairro' : 'ev-bairro');
        const selG = document.getElementById(isOrg ? 'org-ev-genero' : 'ev-genero');
        if (selB && state.bairros) selB.value = ev?.bairroId || '';
        if (selG && state.generos) { const ids = Array.isArray(ev?.generoIds) ? ev.generoIds : (ev?.generoId ? [ev.generoId] : []); Array.from(selG.options).forEach(o=> o.selected = ids.includes(o.value)); }
      }, 10);
    };



// === PATCH: Corrige menu de filtros recolhível e aplica filtros nos carrosséis ===
(function(){
  const $ = (sel)=> document.querySelector(sel);
  const $$ = (sel)=> Array.from(document.querySelectorAll(sel));

  const bar = $('#filters-bar');
  const toggleBtn = $('#btn-toggle-filters');
  const countEl = $('#active-filters-count');
  const clearBtn = $('#btn-clear-filters');

  function updateFiltersBadge(){
    try{
      const total = (state?.selectedBairros?.size||0) + (state?.selectedGeneros?.size||0);
      if (countEl){
        countEl.textContent = String(total);
        countEl.classList.toggle('hidden', total===0);
      }
      if (clearBtn){
        clearBtn.disabled = total===0;
        clearBtn.classList.toggle('text-gray-400', total===0);
        clearBtn.classList.toggle('no-underline', total===0);
      }
    }catch(e){ console.warn('Badge update failed', e); }
  }

  function wireChipsExtraHandlers(){
    try{
      // Evita duplicar handlers
      $$('#chips-bairros button, #chips-generos button').forEach(btn=>{
        if (btn.dataset.wiredPatch === '1') return;
        btn.dataset.wiredPatch = '1';
        btn.addEventListener('click', ()=>{
          // Deixa o handler original rodar primeiro
          setTimeout(()=>{
            updateFiltersBadge();
            if (typeof applyFiltersAndRender === 'function') {
              applyFiltersAndRender();
            } else {
              // fallback (não deve acontecer, mas garante feed filtrado)
              if (typeof renderFeed === 'function') applyFiltersAndRender();
            }
          }, 0);
        });
      });
    }catch(e){ console.warn('wireChipsExtraHandlers failed', e); }
  }

  // Hook na função que já atualiza chips/listas para reforçar wiring e badge
  if (typeof updateTaxonomyUIs === 'function'){
    const _origUpdateTaxonomyUIs = updateTaxonomyUIs;
    updateTaxonomyUIs = function(){
      const res = _origUpdateTaxonomyUIs.apply(this, arguments);
      // Após o UI original ser construído, reforça nossos handlers
      wireChipsExtraHandlers();
      updateFiltersBadge();
      return res;
    };
  } else {
    document.addEventListener('DOMContentLoaded', wireChipsExtraHandlers);
  }

  // Botão "Limpar filtros"
  if (clearBtn){
    const _origClear = clearBtn.onclick;
    clearBtn.onclick = function(ev){
      try{
        state?.selectedBairros?.clear?.();
        state?.selectedGeneros?.clear?.();
      }catch(e){}
      updateFiltersBadge();
      if (typeof applyFiltersAndRender === 'function') applyFiltersAndRender();
      // Chama handler antigo (atualiza selects/chips, se houver)
      if (typeof _origClear === 'function') _origClear.call(this, ev);
    };
  }

  // Toggle do menu recolhível
  if (toggleBtn && bar){
    toggleBtn.addEventListener('click', ()=>{
      bar.classList.toggle('filters-open');
    });
  }

  // Garante estado inicial consistente
  setTimeout(()=>{
    wireChipsExtraHandlers();
    updateFiltersBadge();
  }, 400);
})();
// === FIM DO PATCH ===


// === Theme toggle & persistence ===
const THEME_KEY = 'rf_theme';
function applyTheme(theme){
  const t = (theme === 'dark') ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', t);
  const sun = document.getElementById('icon-sun');
  const moon = document.getElementById('icon-moon');
  if (sun && moon) {
    if (t === 'dark') { sun.classList.add('hidden'); moon.classList.remove('hidden'); }
    else { sun.classList.remove('hidden'); moon.classList.add('hidden'); }
  }
}
function getStoredTheme(){ try { return localStorage.getItem(THEME_KEY); } catch(e){ return null; } }
async function persistTheme(theme){
  try {
    const u = auth.currentUser;
    if (u && !u.isAnonymous) {
      await setDoc(doc(db, USERS_PATH, u.uid), { 
        settings: { ...(state.currentUserData?.settings || {}), theme } 
      }, { merge: true });
      state.currentUserData = { ...(state.currentUserData || {}), settings: { ...(state.currentUserData?.settings || {}), theme } };
    } else {
      localStorage.setItem(THEME_KEY, theme);
    }
  } catch(e){ console.warn('persistTheme failed', e); }
}
document.getElementById('btn-theme')?.addEventListener('click', async () => {
  const current = document.documentElement.getAttribute('data-theme') || 'light';
  const next = (current === 'dark') ? 'light' : 'dark';
  applyTheme(next);
  await persistTheme(next);
});
onAuthStateChanged(auth, async (user) => {
  try {
    if (user && !user.isAnonymous) {
      const ref = doc(db, USERS_PATH, user.uid);
      try {
        const snap = await getDoc(ref);
        const t = snap?.data()?.settings?.theme || getStoredTheme();
        if (t) applyTheme(t);
      } catch(e) {
        const t = getStoredTheme();
        if (t) applyTheme(t);
      }
    } else {
      const t = getStoredTheme();
      if (t) applyTheme(t);
    }
  } catch(e){}
});

// === Collapsibles for Admin (mobile) ===
function enhanceAdminMobileCollapsibles(){
  const admin = document.getElementById('view-admin');
  if(!admin) return;
  const isMobile = window.matchMedia('(max-width: 767px)').matches;
  if(!isMobile) return;
  const cards = Array.from(admin.querySelectorAll('.rounded-3xl.bg-white.shadow-soft.ring-subtle'))
    .filter(el => !el.querySelector('#taxonomy-panel'));
  cards.forEach(card => {
    if (card.dataset.collapsibleWired === '1') return;
    card.dataset.collapsibleWired = '1';
    const heading = card.querySelector('h3, h4');
    const title = heading ? (heading.textContent || 'Seção') : 'Seção';
    const toggle = document.createElement('button');
    toggle.className = 'collapsible-toggle px-4 py-3 text-left';
    toggle.innerHTML = `<span>${title}</span><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
    const body = document.createElement('div');
    body.className = 'collapsible-body';
    const inner = document.createElement('div');
    inner.className = 'collapsible-inner';
    const children = Array.from(card.children);
    if (children.length > 1) {
      for (let i = 1; i < children.length; i++) inner.appendChild(children[i]);
    } else {
      children.forEach(ch => inner.appendChild(ch));
    }
    body.appendChild(inner);
    card.classList.add('collapsible','collapsed');
    card.innerHTML = '';
    card.appendChild(toggle);
    card.appendChild(body);
    toggle.addEventListener('click', () => { card.classList.toggle('collapsed'); });
  });
}
window.addEventListener('load', enhanceAdminMobileCollapsibles);
window.addEventListener('resize', enhanceAdminMobileCollapsibles);



// --- Search events across name, local and styles; respects current filters ---
(function(){
  const input = document.getElementById('search-input');
  const btn = document.getElementById('search-btn');
  const run = () => applyFiltersAndRender();
  let t;
  if (input){
    input.addEventListener('input', () => { clearTimeout(t); t = setTimeout(run, 120); });
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); run(); }
      if (e.key === 'Escape') { input.value = ''; run(); }
    });
  }
  btn?.addEventListener('click', run);
})();

// ===== SISTEMA DE EVENTOS PRIVADOS =====

// Verifica se o usuário tem acesso a um evento privado
async function checkPrivateEventAccess(eventId) {
    if (!auth.currentUser || auth.currentUser.isAnonymous) return false;
    
    try {
        const accessRef = doc(db, `artifacts/${appId}/privateEvents/${eventId}/access`, auth.currentUser.uid);
        const accessDoc = await getDoc(accessRef);
        return accessDoc.exists() && accessDoc.data().status === 'approved';
    } catch (err) {
        console.error('Erro ao verificar acesso:', err);
        return false;
    }
}

// Verifica se o usuário já solicitou acesso a um evento privado
async function checkPrivateEventRequest(eventId) {
    if (!auth.currentUser || auth.currentUser.isAnonymous) return false;
    
    try {
        const requestRef = doc(db, `artifacts/${appId}/privateEvents/${eventId}/requests`, auth.currentUser.uid);
        const requestDoc = await getDoc(requestRef);
        
        if (!requestDoc.exists()) {
            return false;
        }
        
        const requestData = requestDoc.data();
        return requestData.status === 'pending';
    } catch (err) {
        console.error('Erro ao verificar solicitação:', err);
        return false;
    }
}

// Solicita acesso a um evento privado
async function requestPrivateEventAccess(eventId) {
    if (!auth.currentUser || auth.currentUser.isAnonymous) {
        openLogin();
        return;
    }
    
    try {
        const event = state.events.find(ev => (ev._original_id || ev._id) === eventId);
        if (!event) {
            toast('Evento não encontrado.', 'error');
            return;
        }
        
        // Verifica se já existe uma solicitação pendente
        const existingRequestRef = doc(db, `artifacts/${appId}/privateEvents/${eventId}/requests`, auth.currentUser.uid);
        const existingRequestSnap = await getDoc(existingRequestRef);
        
        if (existingRequestSnap.exists()) {
            const requestData = existingRequestSnap.data();
            console.log('Solicitação existente encontrada:', requestData);
            
            if (requestData.status === 'pending') {
                console.log('Solicitação pendente detectada, mostrando notificação');
                showNotification('Sua solicitação de acesso ainda está pendente. Aguarde a aprovação do organizador.');
                hide($('#private-event-access-modal'));
                return;
            } else if (requestData.status === 'approved') {
                console.log('Usuário já tem acesso aprovado');
                showNotification('Você já tem acesso a este evento privado.');
                hide($('#private-event-access-modal'));
                return;
            } else if (requestData.status === 'rejected') {
                console.log('Solicitação anterior foi recusada, permitindo nova solicitação');
                showNotification('Sua solicitação anterior foi recusada. Você pode solicitar novamente.');
                // Continua para criar nova solicitação
            }
        } else {
            console.log('Nenhuma solicitação existente encontrada, criando nova');
        }
        
        const requestRef = doc(db, `artifacts/${appId}/privateEvents/${eventId}/requests`, auth.currentUser.uid);
        const userData = state.currentUserData;
        
        await setDoc(requestRef, {
            userId: auth.currentUser.uid,
            userName: userData?.name || auth.currentUser.displayName || 'Usuário',
            userEmail: userData?.email || auth.currentUser.email || '',
            status: 'pending',
            requestedAt: serverTimestamp()
        });
        
        showNotification('Solicitação de acesso enviada! Aguarde aprovação do organizador.');
        hide($('#private-event-access-modal'));
    } catch (err) {
        console.error('Erro ao solicitar acesso:', err);
        toast('Erro ao solicitar acesso.', 'error');
    }
}

// Aprova ou recusa solicitação de acesso
async function handlePrivateEventRequest(eventId, userId, action) {
    try {
        const requestRef = doc(db, `artifacts/${appId}/privateEvents/${eventId}/requests`, userId);
        const accessRef = doc(db, `artifacts/${appId}/privateEvents/${eventId}/access`, userId);
        
        if (action === 'approve') {
            // Busca os dados do usuário
            const userData = state.users[userId];
            
            await setDoc(accessRef, {
                userId: userId,
                userName: userData?.name || 'Usuário',
                userEmail: userData?.email || '',
                status: 'approved',
                approvedAt: serverTimestamp()
            });
            await updateDoc(requestRef, { status: 'approved' });
            toast('Acesso aprovado!');
        } else if (action === 'reject') {
            await updateDoc(requestRef, { status: 'rejected' });
            toast('Acesso recusado.');
        }
        
        // Recarrega as solicitações
        if (state.isAdmin) {
            renderAdminPrivateEventRequests();
            renderAdminPrivateEventApproved();
        } else if (state.isOrganizer) {
            renderOrganizerPrivateEventRequests();
            renderOrganizerPrivateEventApproved();
        }
    } catch (err) {
        console.error('Erro ao processar solicitação:', err);
        toast('Erro ao processar solicitação.', 'error');
    }
}

// Renderiza solicitações de eventos privados para organizadores
async function renderOrganizerPrivateEventRequests() {
    const container = $('#private-events-requests');
    const emptyEl = $('#empty-private-requests');
    
    if (!container) return;
    
    container.innerHTML = '';
    
    try {
        // Busca eventos privados criados pelo organizador atual
        const myPrivateEvents = state.events.filter(ev => 
            ev.isPrivate && ev.createdBy === auth.currentUser.uid
        );
        
        if (myPrivateEvents.length === 0) {
            show(emptyEl);
            hide(container);
            return;
        }
        
        let hasRequests = false;
        
        for (const event of myPrivateEvents) {
            const eventId = event._original_id || event._id;
            const requestsRef = collection(db, `artifacts/${appId}/privateEvents/${eventId}/requests`);
            const requestsSnap = await getDocs(requestsRef);
            
            const pendingRequests = requestsSnap.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(req => req.status === 'pending');
            
            if (pendingRequests.length > 0) {
                hasRequests = true;
                
                const eventCard = document.createElement('div');
                eventCard.className = 'private-request-card';
                eventCard.innerHTML = `
                    <h4 class="font-semibold text-lg mb-3">${event.name}</h4>
                    <div class="space-y-3">
                        ${pendingRequests.map(req => `
                            <div class="flex items-center justify-between p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-2xl border border-gray-200 shadow-sm">
                                <div class="flex items-center gap-3">
                                    <div class="flex-shrink-0">
                                        <div class="h-10 w-10 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white font-semibold text-sm">
                                            ${req.userName ? req.userName.charAt(0).toUpperCase() : 'U'}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">${req.userName}</div>
                                        <div class="text-sm text-gray-600">${req.userEmail}</div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            <svg class="inline w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            Solicitado em ${req.requestedAt?.toDate?.()?.toLocaleDateString('pt-BR') || 'Data não disponível'}
                                        </div>
                                    </div>
                                </div>
                                <div class="request-actions flex flex-col gap-3">
                                    <button class="approve-btn" data-approve="${eventId}" data-user="${req.userId}">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                        Aprovar
                                    </button>
                                    <button class="reject-btn" data-reject="${eventId}" data-user="${req.userId}">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                        Recusar
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Adiciona event listeners
                eventCard.querySelectorAll('[data-approve]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const eventId = btn.dataset.approve;
                        const userId = btn.dataset.user;
                        handlePrivateEventRequest(eventId, userId, 'approve');
                    });
                });
                
                eventCard.querySelectorAll('[data-reject]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const eventId = btn.dataset.reject;
                        const userId = btn.dataset.user;
                        handlePrivateEventRequest(eventId, userId, 'reject');
                    });
                });
                
                container.appendChild(eventCard);
            }
        }
        
        if (!hasRequests) {
            show(emptyEl);
            hide(container);
        } else {
            hide(emptyEl);
            show(container);
        }
    } catch (err) {
        console.error('Erro ao carregar solicitações:', err);
        toast('Erro ao carregar solicitações.', 'error');
    }
}

// Renderiza solicitações de eventos privados para admins
async function renderAdminPrivateEventRequests() {
    const container = $('#admin-private-events-requests');
    const emptyEl = $('#empty-admin-private-requests');
    
    if (!container) return;
    
    container.innerHTML = '';
    
    try {
        // Busca todos os eventos privados
        const privateEvents = state.events.filter(ev => ev.isPrivate);
        
        if (privateEvents.length === 0) {
            show(emptyEl);
            hide(container);
            return;
        }
        
        let hasRequests = false;
        
        for (const event of privateEvents) {
            const eventId = event._original_id || event._id;
            const requestsRef = collection(db, `artifacts/${appId}/privateEvents/${eventId}/requests`);
            const requestsSnap = await getDocs(requestsRef);
            
            const pendingRequests = requestsSnap.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(req => req.status === 'pending');
            
            if (pendingRequests.length > 0) {
                hasRequests = true;
                
                const eventCard = document.createElement('div');
                eventCard.className = 'private-request-card';
                eventCard.innerHTML = `
                    <h4 class="font-semibold text-lg mb-3">${event.name}</h4>
                    <div class="text-sm text-gray-600 mb-3">Organizador: ${state.users[event.createdBy]?.name || 'Desconhecido'}</div>
                    <div class="space-y-3">
                        ${pendingRequests.map(req => `
                            <div class="flex items-center justify-between p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-2xl border border-gray-200 shadow-sm">
                                <div class="flex items-center gap-3">
                                    <div class="flex-shrink-0">
                                        <div class="h-10 w-10 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white font-semibold text-sm">
                                            ${req.userName ? req.userName.charAt(0).toUpperCase() : 'U'}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">${req.userName}</div>
                                        <div class="text-sm text-gray-600">${req.userEmail}</div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            <svg class="inline w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            Solicitado em ${req.requestedAt?.toDate?.()?.toLocaleDateString('pt-BR') || 'Data não disponível'}
                                        </div>
                                    </div>
                                </div>
                                <div class="request-actions flex flex-col gap-3">
                                    <button class="approve-btn" data-approve="${eventId}" data-user="${req.userId}">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                        Aprovar
                                    </button>
                                    <button class="reject-btn" data-reject="${eventId}" data-user="${req.userId}">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                        Recusar
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Adiciona event listeners
                eventCard.querySelectorAll('[data-approve]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const eventId = btn.dataset.approve;
                        const userId = btn.dataset.user;
                        handlePrivateEventRequest(eventId, userId, 'approve');
                    });
                });
                
                eventCard.querySelectorAll('[data-reject]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const eventId = btn.dataset.reject;
                        const userId = btn.dataset.user;
                        handlePrivateEventRequest(eventId, userId, 'reject');
                    });
                });
                
                container.appendChild(eventCard);
            }
        }
        
        if (!hasRequests) {
            show(emptyEl);
            hide(container);
        } else {
            hide(emptyEl);
            show(container);
        }
    } catch (err) {
        console.error('Erro ao carregar solicitações:', err);
        toast('Erro ao carregar solicitações.', 'error');
    }
}

// Renderiza eventos do organizador
function renderOrganizerEvents() {
    const container = $('#my-events-grid');
    const emptyEl = $('#empty-my-events');
    
    if (!container) return;
    
    container.innerHTML = '';
    
    const myEvents = state.events.filter(ev => 
        ev.createdBy === auth.currentUser.uid && isEventActive(ev)
    );
    
    if (myEvents.length === 0) {
        show(emptyEl);
        hide(container);
        return;
    }
    
    hide(emptyEl);
    show(container);
    
            myEvents.forEach(event => {
            const eventCard = document.createElement('div');
            eventCard.className = 'organizer-event-card';
            eventCard.innerHTML = `
                <div class="flex items-start gap-3">
                    <img src="${event.imageUrls?.[0] || ''}" onerror="this.src='https://placehold.co/64x48/f9a8d4/ffffff?text=RioFestas'" class="h-16 w-20 rounded-lg object-cover" />
                    <div class="flex-1">
                        <h4 class="font-semibold">${event.name}</h4>
                        <div class="text-sm text-gray-600">${fmtDate(event.date)} • ${event.local}</div>
                        <div class="text-xs mt-1">
                            ${event.isPrivate ? '<span class="event-status private">● Privado</span>' : '<span class="event-status public">● Público</span>'}
                        </div>
                    </div>
                </div>
            `;
            
            eventCard.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                openViewModal(event);
            });
            container.appendChild(eventCard);
        });
}

// Função para mostrar confirmação de solicitação de acesso
function showPrivateEventAccessModal(eventId, eventName) {
    const confirmed = confirm(`Este é um evento privado (${eventName || 'Evento'}). Deseja solicitar acesso para ver mais detalhes?`);
    
    if (confirmed) {
        requestPrivateEventAccess(eventId);
    }
}

// Event listeners removidos - agora usando confirm() padrão do navegador

// Função para mostrar modal de confirmação de remoção de acesso
function showRemoveAccessModal(eventId, userId) {
    $('#remove-access-modal').dataset.eventId = eventId;
    $('#remove-access-modal').dataset.userId = userId;
    show($('#remove-access-modal'));
}

// Event listeners para o modal de remoção de acesso
$('#cancel-remove-access-btn').addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    hide($('#remove-access-modal'));
});

$('#confirm-remove-access-btn').addEventListener('click', async (e) => {
    e.preventDefault();
    e.stopPropagation();
    const eventId = $('#remove-access-modal').dataset.eventId;
    const userId = $('#remove-access-modal').dataset.userId;
    
    if (eventId && userId) {
        await removePrivateEventAccess(eventId, userId);
        hide($('#remove-access-modal'));
    }
});

// Prevenir propagação de eventos no modal
$('#remove-access-modal').addEventListener('click', (e) => {
    e.stopPropagation();
});

// Função para remover acesso de uma pessoa aprovada
async function removePrivateEventAccess(eventId, userId) {
    try {
        const accessRef = doc(db, `artifacts/${appId}/privateEvents/${eventId}/access`, userId);
        const requestRef = doc(db, `artifacts/${appId}/privateEvents/${eventId}/requests`, userId);
        
        await deleteDoc(accessRef);
        await updateDoc(requestRef, { status: 'removed' });
        
        toast('Acesso removido com sucesso.');
        
        // Recarrega as views
        if (state.isAdmin) {
            renderAdminPrivateEventRequests();
            renderAdminPrivateEventApproved();
        } else if (state.isOrganizer) {
            renderOrganizerPrivateEventRequests();
            renderOrganizerPrivateEventApproved();
            // Recarrega também os eventos do organizador para garantir consistência
            renderOrganizerEvents();
        }
    } catch (err) {
        console.error('Erro ao remover acesso:', err);
        toast('Erro ao remover acesso.', 'error');
    }
}

// Renderiza pessoas aprovadas para organizadores
async function renderOrganizerPrivateEventApproved() {
    const container = $('#private-events-approved');
    const emptyEl = $('#empty-private-approved');
    
    if (!container) return;
    
    container.innerHTML = '';
    
    try {
        // Busca eventos privados criados pelo organizador atual
        const myPrivateEvents = state.events.filter(ev => 
            ev.isPrivate && ev.createdBy === auth.currentUser.uid
        );
        
        if (myPrivateEvents.length === 0) {
            show(emptyEl);
            hide(container);
            return;
        }
        
        let hasApproved = false;
        
        for (const event of myPrivateEvents) {
            const eventId = event._original_id || event._id;
            const accessRef = collection(db, `artifacts/${appId}/privateEvents/${eventId}/access`);
            const accessSnap = await getDocs(accessRef);
            
            const approvedUsers = accessSnap.docs
                .map(doc => {
                    const data = doc.data();
                    // Se não tem userName, tenta buscar do state.users
                    if (!data.userName && data.userId) {
                        const userData = state.users[data.userId];
                        if (userData) {
                            data.userName = userData.name || 'Usuário';
                            data.userEmail = userData.email || '';
                        }
                    }
                    return { id: doc.id, ...data };
                })
                .filter(access => access.status === 'approved');
            
            if (approvedUsers.length > 0) {
                hasApproved = true;
                
                const eventCard = document.createElement('div');
                eventCard.className = 'private-request-card';
                eventCard.innerHTML = `
                    <h4 class="font-semibold text-lg mb-3">${event.name}</h4>
                    <div class="space-y-3">
                        ${approvedUsers.map(user => `
                            <div class="flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-green-100 rounded-2xl border border-green-200 shadow-sm">
                                <div class="flex items-center gap-3">
                                    <div class="flex-shrink-0">
                                        <div class="h-10 w-10 rounded-full bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center text-white font-semibold text-sm">
                                            ${user.userName ? user.userName.charAt(0).toUpperCase() : 'U'}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">${user.userName}</div>
                                        <div class="text-sm text-gray-600">${user.userEmail}</div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            <svg class="inline w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            Aprovado em ${user.approvedAt?.toDate?.()?.toLocaleDateString('pt-BR') || 'Data não disponível'}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="remove-btn" data-remove="${eventId}" data-user="${user.userId}">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                        Remover
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Adiciona event listeners
                eventCard.querySelectorAll('[data-remove]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const eventId = btn.dataset.remove;
                        const userId = btn.dataset.user;
                        showRemoveAccessModal(eventId, userId);
                    });
                });
                
                container.appendChild(eventCard);
            }
        }
        
        if (!hasApproved) {
            show(emptyEl);
            hide(container);
        } else {
            hide(emptyEl);
            show(container);
        }
    } catch (err) {
        console.error('Erro ao carregar pessoas aprovadas:', err);
        toast('Erro ao carregar pessoas aprovadas.', 'error');
    }
}

// Renderiza pessoas aprovadas para admins
async function renderAdminPrivateEventApproved() {
    const container = $('#admin-private-events-approved');
    const emptyEl = $('#empty-admin-private-approved');
    
    if (!container) return;
    
    container.innerHTML = '';
    
    try {
        // Busca todos os eventos privados
        const privateEvents = state.events.filter(ev => ev.isPrivate);
        
        if (privateEvents.length === 0) {
            show(emptyEl);
            hide(container);
            return;
        }
        
        let hasApproved = false;
        
        for (const event of privateEvents) {
            const eventId = event._original_id || event._id;
            const accessRef = collection(db, `artifacts/${appId}/privateEvents/${eventId}/access`);
            const accessSnap = await getDocs(accessRef);
            
            const approvedUsers = accessSnap.docs
                .map(doc => {
                    const data = doc.data();
                    // Se não tem userName, tenta buscar do state.users
                    if (!data.userName && data.userId) {
                        const userData = state.users[data.userId];
                        if (userData) {
                            data.userName = userData.name || 'Usuário';
                            data.userEmail = userData.email || '';
                        }
                    }
                    return { id: doc.id, ...data };
                })
                .filter(access => access.status === 'approved');
            
            if (approvedUsers.length > 0) {
                hasApproved = true;
                
                const eventCard = document.createElement('div');
                eventCard.className = 'private-request-card';
                eventCard.innerHTML = `
                    <h4 class="font-semibold text-lg mb-3">${event.name}</h4>
                    <div class="text-sm text-gray-600 mb-3">Organizador: ${state.users[event.createdBy]?.name || 'Desconhecido'}</div>
                    <div class="space-y-3">
                        ${approvedUsers.map(user => `
                            <div class="flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-green-100 rounded-2xl border border-green-200 shadow-sm">
                                <div class="flex items-center gap-3">
                                    <div class="flex-shrink-0">
                                        <div class="h-10 w-10 rounded-full bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center text-white font-semibold text-sm">
                                            ${user.userName ? user.userName.charAt(0).toUpperCase() : 'U'}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">${user.userName}</div>
                                        <div class="text-sm text-gray-600">${user.userEmail}</div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            <svg class="inline w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            Aprovado em ${user.approvedAt?.toDate?.()?.toLocaleDateString('pt-BR') || 'Data não disponível'}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="remove-btn" data-remove="${eventId}" data-user="${user.userId}">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                        Remover
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Adiciona event listeners
                eventCard.querySelectorAll('[data-remove]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const eventId = btn.dataset.remove;
                        const userId = btn.dataset.user;
                        showRemoveAccessModal(eventId, userId);
                    });
                });
                
                container.appendChild(eventCard);
            }
        }
        
        if (!hasApproved) {
            show(emptyEl);
            hide(container);
        } else {
            hide(emptyEl);
            show(container);
        }
    } catch (err) {
        console.error('Erro ao carregar pessoas aprovadas:', err);
        toast('Erro ao carregar pessoas aprovadas.', 'error');
    }
}

// Função para recarregar views do organizador
function refreshOrganizerViews() {
    renderOrganizerEvents();
    renderOrganizerPrivateEventRequests();
    renderOrganizerPrivateEventApproved();
}

// Adiciona refreshOrganizerViews ao refreshAllAdminViews
const originalRefreshAllAdminViews = refreshAllAdminViews;
refreshAllAdminViews = function() {
    originalRefreshAllAdminViews();
    renderAdminPrivateEventRequests();
    renderAdminPrivateEventApproved();
};

// Event listeners para barras de pesquisa
$('#search-pending-requests').addEventListener('input', (e) => {
    filterRequests('private-events-requests', e.target.value);
});

$('#search-approved-users').addEventListener('input', (e) => {
    filterRequests('private-events-approved', e.target.value);
});

$('#search-admin-pending-requests').addEventListener('input', (e) => {
    filterRequests('admin-private-events-requests', e.target.value);
});

$('#search-admin-approved-users').addEventListener('input', (e) => {
    filterRequests('admin-private-events-approved', e.target.value);
});

// Event listener para toggle das notificações
$('#notifications-toggle').addEventListener('click', () => {
    toggleNotifications();
});

$('#notifications-toggle-btn').addEventListener('click', (e) => {
    e.stopPropagation();
    toggleNotifications();
});

function toggleNotifications() {
    const content = $('#notifications-content');
    const arrow = $('#notifications-arrow');
    const controls = $('#notifications-controls');
    
    if (content.style.maxHeight === '0px' || !content.style.maxHeight) {
        // Expandir
        content.style.maxHeight = content.scrollHeight + 'px';
        arrow.style.transform = 'rotate(180deg)';
        controls.style.opacity = '1';
        controls.style.pointerEvents = 'auto';
        
        // Marcar notificações como lidas quando expandir
        markNotificationsAsRead();
    } else {
        // Recolher
        content.style.maxHeight = '0px';
        arrow.style.transform = 'rotate(0deg)';
        controls.style.opacity = '0.5';
        controls.style.pointerEvents = 'none';
    }
}

// Inicializar notificações como recolhidas
document.addEventListener('DOMContentLoaded', () => {
    initializeNotificationsCollapse();
});

// Função para inicializar o colapso das notificações
function initializeNotificationsCollapse() {
    const content = $('#notifications-content');
    const arrow = $('#notifications-arrow');
    const controls = $('#notifications-controls');
    
    if (content) {
        content.style.maxHeight = '0px';
        arrow.style.transform = 'rotate(0deg)'; // Setinha apontando para baixo (expandir)
        controls.style.opacity = '0.5';
        controls.style.pointerEvents = 'none';
    }
}

// Função para marcar notificações como lidas
async function markNotificationsAsRead() {
    if (!auth.currentUser || auth.currentUser.isAnonymous) return;
    
    try {
        const notificationsRef = collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/notifications`);
        const unreadNotifications = state.notifications.filter(notif => !notif.read);
        
        if (unreadNotifications.length > 0) {
            const batch = writeBatch(db);
            
            unreadNotifications.forEach(notif => {
                const notifRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/notifications`, notif.id);
                batch.update(notifRef, { read: true });
            });
            
            await batch.commit();
            
            // Atualizar estado local
            state.notifications.forEach(notif => {
                if (!notif.read) notif.read = true;
            });
            
            // Esconder o badge
            hide($('#notifications-badge'));
        }
    } catch (error) {
        console.error('Erro ao marcar notificações como lidas:', error);
    }
}

// Função para expandir notificações quando há novas
function expandNotificationsIfNew() {
    const content = $('#notifications-content');
    const arrow = $('#notifications-arrow');
    const controls = $('#notifications-controls');
    const notificationsList = $('#notifications-list');
    
    if (notificationsList && notificationsList.children.length > 0) {
        // Se há notificações, expandir automaticamente
        content.style.maxHeight = content.scrollHeight + 'px';
        arrow.style.transform = 'rotate(180deg)'; // Setinha apontando para cima (recolher)
        controls.style.opacity = '1';
        controls.style.pointerEvents = 'auto';
    }
}

// Função para detectar se é dispositivo móvel
function isMobileDevice() {
    return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Função para mostrar notificação baseada no dispositivo
function showNotification(message, type = 'info') {
    if (isMobileDevice()) {
        alert(message);
    } else {
        toast(message, type);
    }
}

// Função para filtrar solicitações e usuários aprovados
function filterRequests(containerId, searchTerm) {
    const container = $(`#${containerId}`);
    if (!container) return;
    
    const cards = container.querySelectorAll('.private-request-card');
    const searchLower = searchTerm.toLowerCase();
    
    cards.forEach(card => {
        const userNames = card.querySelectorAll('.font-semibold.text-gray-900');
        let shouldShow = false;
        
        userNames.forEach(nameEl => {
            if (nameEl.textContent.toLowerCase().includes(searchLower)) {
                shouldShow = true;
            }
        });
        
        card.style.display = shouldShow ? 'block' : 'none';
    });
}



</script>


<script src="app.js"></script></body>
</html>